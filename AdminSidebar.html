<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* --- GLOBAL RESET & TYPOGRAPHY --- */
      body { 
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        padding: 0; 
        background-color: #f8fafc; 
        color: #333; 
        margin: 0;
      }

      h2 { 
        color: #4a5568; 
        text-align: center; 
        font-size: 13px; 
        margin: 0 0 12px 0; 
        font-weight: 800;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      /* --- TAB NAVIGATION --- */
      .tab-nav {
        display: flex;
        background: #2d3748;
        padding: 0;
        margin: 0;
        position: sticky;
        top: 0;
        z-index: 100;
      }
      .tab-btn {
        flex: 1;
        padding: 14px 8px;
        border: none;
        background: #2d3748;
        color: #a0aec0;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 3px solid transparent;
      }
      .tab-btn:hover {
        background: #4a5568;
        color: #e2e8f0;
      }
      .tab-btn.active {
        background: #4a5568;
        color: #fff;
        border-bottom-color: #48bb78;
      }
      .tab-btn.disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }
      .tab-btn .tab-icon {
        display: block;
        font-size: 16px;
        margin-bottom: 4px;
      }
      
      /* --- TAB PANELS --- */
      .tab-panel {
        display: none;
        padding: 12px;
      }
      .tab-panel.active {
        display: block;
      }

      /* --- ACCESS DENIED MESSAGE --- */
      .access-denied {
        text-align: center;
        padding: 40px 20px;
        color: #718096;
      }
      .access-denied .icon {
        font-size: 48px;
        margin-bottom: 16px;
      }
      .access-denied h3 {
        color: #4a5568;
        margin: 0 0 8px 0;
        font-size: 16px;
      }
      .access-denied p {
        margin: 0;
        font-size: 12px;
      }

      /* --- INPUT CONTROL GROUP --- */
      .control-group { 
        background: white; 
        padding: 12px; 
        border-radius: 8px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        border: 1px solid #e2e8f0;
        margin-bottom: 15px;
      }

      label { 
        font-size: 10px; 
        font-weight: 700; 
        text-transform: uppercase; 
        color: #718096; 
        display: block; 
        margin-bottom: 4px; 
      }
      
      select, input[type="text"] { 
        width: 100%; 
        padding: 8px; 
        border: 1px solid #cbd5e0; 
        border-radius: 5px; 
        box-sizing: border-box; 
        font-size: 12px; 
        background-color: #fff;
        margin-bottom: 10px;
      }

      .checkbox-wrapper {
        font-size: 11px; 
        margin-top: 2px;
        display: flex;
        align-items: center;
        color: #4a5568;
      }
      
      .checkbox-wrapper input { margin-right: 6px; }

      /* --- BUTTON GRIDS --- */
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
      }
      
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
      }

      .grid-1 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }

      /* --- BUTTON STYLES --- */
      button { 
        padding: 10px 8px; 
        border: 1px solid #e2e8f0; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 11px; 
        font-weight: 600; 
        color: #2d3748; 
        background: white;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        display: flex; 
        justify-content: center;
        align-items: center;
      }

      button:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        background: #fafbfc;
      }

      .btn-vertical {
        flex-direction: column;
        text-align: center;
        height: 100%;
      }
      .btn-vertical .icon { margin-bottom: 5px; margin-right: 0; font-size: 18px; }

      .btn-horizontal {
        flex-direction: row;
        text-align: left;
        justify-content: flex-start;
      }
      .btn-horizontal .icon { margin-right: 10px; font-size: 16px; }

      /* --- COLOR CODING --- */
      .btn-safe   { border-top: 3px solid #27ae60; }
      .btn-copy   { border-top: 3px solid #2980b9; }
      .btn-del    { border-top: 3px solid #c0392b; }
      .btn-config { border-top: 3px solid #f39c12; }
      .btn-local  { border-left: 4px solid #8e44ad; } 
      .btn-warn   { border-left: 4px solid #d35400; } 

      /* --- DIVIDER --- */
      .section-divider {
        border: 0;
        height: 1px;
        background: #cbd5e0;
        margin: 20px 0;
      }

      /* --- MODALS --- */
      #confirm-modal { display: none; background: #fff8e1; border: 1px solid #ffe58f; color: #b7791f; padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center; }
      .confirm-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
      .btn-yes { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
      .btn-no { background: #718096; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }

      #data-refresh-modal { display: none; background: #e8f4fd; border: 1px solid #90cdf4; color: #2b6cb0; padding: 15px; border-radius: 6px; margin-top: 20px; }
      #data-refresh-modal h3 { margin: 0 0 12px 0; font-size: 13px; text-align: center; }
      .radio-option { display: flex; align-items: flex-start; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer; }
      .radio-option:hover { background: #f7fafc; border-color: #90cdf4; }
      .radio-option input { margin-right: 10px; margin-top: 3px; }
      .radio-option .option-text { flex: 1; }
      .radio-option .option-title { font-weight: 600; font-size: 12px; color: #2d3748; }
      .radio-option .option-desc { font-size: 10px; color: #718096; margin-top: 2px; }
      
      #spinner { display: none; text-align: center; margin: 30px 0; }
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3182ce; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 0 auto 10px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      #log-area { display: none; margin-top: 20px; font-size: 11px; max-height: 150px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 4px; }
      .log-entry { padding: 6px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; }
      .status-success { color: #27ae60; font-weight: bold; }
      .status-error { color: #c0392b; font-weight: bold; }
      .status-warning { color: #d69e2e; font-weight: bold; }

      /* --- RANGE REPLICATOR STYLES --- */
      .range-display {
        background: #f7fafc;
        border: 1px dashed #cbd5e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
        font-size: 11px;
        min-height: 50px;
      }
      .range-display.captured {
        background: #e6fffa;
        border-color: #38b2ac;
        border-style: solid;
      }
      .range-display .range-label {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
      }
      .range-display .range-info {
        color: #718096;
        font-size: 10px;
      }
      .range-display .range-info span {
        display: inline-block;
        margin-right: 12px;
      }
      .range-display .range-headers {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 10px;
        word-break: break-word;
      }
      .range-badges {
        margin-top: 6px;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
        margin-right: 4px;
      }
      .badge-formula { background: #fef3c7; color: #92400e; }
      .badge-richtext { background: #dbeafe; color: #1e40af; }
      
      .inline-input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .inline-input-group > div {
        flex: 1;
      }
      .inline-input-group input[type="text"],
      .inline-input-group input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 12px;
      }
      .inline-input-group input[type="number"] {
        width: 70px;
      }

      #no-header-modal { 
        display: none; 
        background: #fef3c7; 
        border: 1px solid #f59e0b; 
        color: #92400e; 
        padding: 15px; 
        border-radius: 6px; 
        margin-top: 20px; 
        text-align: center; 
      }

      #mismatch-modal { 
        display: none; 
        background: #fed7d7; 
        border: 1px solid #f56565; 
        color: #c53030; 
        padding: 15px; 
        border-radius: 6px; 
        margin-top: 20px; 
      }
      #mismatch-modal h3 { margin: 0 0 10px 0; font-size: 13px; text-align: center; }
      .mismatch-list {
        max-height: 100px;
        overflow-y: auto;
        background: white;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 12px;
        font-size: 10px;
      }

      /* --- TOAST NOTIFICATIONS --- */
      .toast-container {
        position: fixed;
        bottom: 12px;
        right: 12px;
        z-index: 9999;
        display: flex;
        flex-direction: column-reverse;
        gap: 8px;
        max-width: 280px;
      }
      .toast {
        background: #2d3748;
        color: white;
        padding: 12px 14px;
        border-radius: 8px;
        font-size: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        animation: slideIn 0.3s ease;
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }
      .toast.toast-success { background: #059669; }
      .toast.toast-error { background: #dc2626; }
      .toast.toast-warning { background: #d97706; }
      .toast.toast-info { background: #2563eb; }
      .toast.toast-working { background: #4a5568; }
      
      .toast-icon {
        font-size: 16px;
        flex-shrink: 0;
        margin-top: 1px;
      }
      .toast-content {
        flex: 1;
        min-width: 0;
      }
      .toast-title {
        font-weight: 600;
        margin-bottom: 2px;
      }
      .toast-message {
        font-size: 11px;
        opacity: 0.9;
        word-break: break-word;
      }
      .toast-close {
        background: none;
        border: none;
        color: white;
        opacity: 0.6;
        cursor: pointer;
        padding: 0;
        font-size: 16px;
        line-height: 1;
      }
      .toast-close:hover { opacity: 1; }
      
      .toast-progress {
        margin-top: 8px;
        font-size: 10px;
        opacity: 0.8;
      }
      .toast-progress-bar {
        height: 4px;
        background: rgba(255,255,255,0.3);
        border-radius: 2px;
        margin-top: 4px;
        overflow: hidden;
      }
      .toast-progress-fill {
        height: 100%;
        background: white;
        border-radius: 2px;
        transition: width 0.3s ease;
      }
      
      .toast-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255,255,255,0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }
      
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
      .toast.removing {
        animation: slideOut 0.3s ease forwards;
      }

      /* Hide old elements - we use toasts now */
      #spinner { display: none !important; }
      #log-area { display: none !important; }
      #queue-status-modal { display: none !important; }
    </style>
  </head>
  <body>

    <!-- TAB NAVIGATION -->
    <div class="tab-nav">
      <button class="tab-btn active" id="tab-local-btn" onclick="switchTab('local')">
        <span class="tab-icon">üìç</span>
        Local
      </button>
      <button class="tab-btn" id="tab-global-btn" onclick="switchTab('global')">
        <span class="tab-icon">üöÄ</span>
        Global Ops
      </button>
    </div>

    <!-- GLOBAL TAB PANEL -->
    <div class="tab-panel" id="tab-global">
      
      <!-- Access Denied Message (shown to non-admins) -->
      <div class="access-denied" id="global-access-denied" style="display:none;">
        <div class="icon">üîí</div>
        <h3>Admin Access Required</h3>
        <p>Global operations are restricted to authorized administrators.</p>
      </div>

      <!-- Global Content (shown to admins) -->
      <div id="global-content">
        <h2>üöÄ Fleet Operations</h2>
        
        <div class="control-group" id="sheet-deploy-controls">
          <label>Target Sheet (For Deploy Ops)</label>
          <select id="sheet-selector"><option>Loading...</option></select>
          
          <label>New Deploy Name (Copy Only)</label>
          <input type="text" id="new-name-input" placeholder="Enter new tab name...">
          
          <div class="checkbox-wrapper">
            <input type="checkbox" id="hide-check"> 
            <span>Hide sheet after deployment?</span>
          </div>
        </div>

        <div class="grid-3" id="global-row-1">
          <button class="btn-safe btn-vertical" onclick="requestAction('safeUpdate')">
            <span class="icon">üìë</span> Deploy Update
          </button>

          <button class="btn-copy btn-vertical" onclick="requestAction('copy')">
            <span class="icon">üìë</span> Deploy New
          </button>

          <button class="btn-del btn-vertical" onclick="requestAction('delete')">
            <span class="icon">üö´</span> Mass Delete
          </button>
        </div>

        <div class="grid-3" id="global-row-2">
          <button class="btn-local btn-vertical" onclick="requestAction('statcore')">
            <span class="icon">üåê</span> Data Refresh
          </button>

          <button class="btn-config btn-vertical" onclick="requestAction('config')">
            <span class="icon">‚öôÔ∏è</span> Update IDs
          </button>

          <button class="btn-safe btn-vertical" onclick="requestAction('globalTabs')">
            <span class="icon">üë•</span> AM Tabs
          </button>
        </div>
        
        <div class="grid-2" style="margin-top:8px;">
          <button class="btn-config btn-horizontal" onclick="exportAIFeedback()">
            <span class="icon">üì•</span> Export AI Feedback
          </button>
          <button class="btn-safe btn-horizontal" onclick="testApiConnection()">
            <span class="icon">üîå</span> Test API
          </button>
        </div>
        
        <div style="margin-top:8px; text-align:center;">
          <button style="background:#3b82f6; color:white; padding:6px 16px; border:none; border-radius:4px; cursor:pointer; font-size:11px;" onclick="checkQueueStatus()">
            üìã Check Queue Status
          </button>
        </div>

        <hr class="section-divider">

        <h2 id="range-replicator-header">üìã Range Replicator</h2>
        
        <div class="control-group" id="range-replicator-section">
          <div class="range-display" id="range-display">
            <div class="range-label">No range captured</div>
            <div class="range-info">
              <span>Sheet: ‚Äî</span>
              <span>Range: ‚Äî</span>
              <span>Size: ‚Äî √ó ‚Äî</span>
            </div>
          </div>
          
          <button class="btn-copy btn-horizontal" onclick="captureRange()" style="width:100%; margin-bottom:12px;">
            <span class="icon">üì∑</span> Capture Selection
          </button>
          
          <div class="inline-input-group">
            <div>
              <label>Header Row (for verify)</label>
              <input type="number" id="header-row-input" placeholder="Row #" min="1">
            </div>
            <div style="flex:2;">
              <label>Target Sheet</label>
              <select id="target-sheet-selector"><option value="">‚Äî Same as source ‚Äî</option></select>
            </div>
          </div>
          
          <div class="checkbox-wrapper" style="margin-bottom:8px;">
            <input type="checkbox" id="alt-range-check" onchange="toggleAltRange()"> 
            <span>Use different target range</span>
          </div>
          
          <input type="text" id="alt-range-input" placeholder="e.g., A5:F20" style="display:none; margin-bottom:12px;">
          
          <div class="checkbox-wrapper" style="margin-bottom:8px; padding:8px; background:#fff7ed; border:1px solid #fed7aa; border-radius:4px;">
            <input type="checkbox" id="test-mode-check" onchange="toggleTestMode()"> 
            <span style="color:#c2410c; font-weight:600;">Test Mode (Single File)</span>
          </div>
          
          <div id="test-file-wrapper" style="display:none; margin-bottom:12px;">
            <label>Target Fleet File</label>
            <select id="fleet-file-selector"><option value="">Loading fleet files...</option></select>
          </div>
          
          <div class="grid-2">
            <button class="btn-config btn-vertical" onclick="requestRangeAction('verify')" id="btn-verify">
              <span class="icon">‚úì</span> Verify Headers
            </button>
            <button class="btn-safe btn-vertical" onclick="requestRangeAction('push')" id="btn-push">
              <span class="icon">üöÄ</span> <span id="push-btn-text">Push to Fleet</span>
            </button>
          </div>
          
          <div id="test-success-modal" style="display:none; background:#e6fffa; border:1px solid #38b2ac; color:#234e52; padding:12px; border-radius:6px; margin-top:12px; text-align:center;">
            <div style="font-weight:bold; margin-bottom:6px; font-size:13px;">‚úÖ Test Push Complete!</div>
            <div style="font-size:11px; margin-bottom:4px;">Successfully pushed to:</div>
            <div id="test-success-filename" style="font-weight:600; color:#2c7a7b; margin-bottom:10px; font-size:12px;"></div>
            <div style="font-size:10px; margin-bottom:8px;">Would you like to open the file to verify?</div>
            <div class="confirm-btns" style="margin-top:0;">
              <button class="btn-yes" onclick="openTestFile()">Open File</button>
              <button class="btn-no" onclick="closeTestSuccessModal()">Done</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- LOCAL TAB PANEL -->
    <div class="tab-panel active" id="tab-local">
      <h2>üìç Local Functions (This File)</h2>
      
      <div class="grid-1" id="local-buttons">
        <button class="btn-local btn-horizontal" onclick="requestAction('createTabs')">
          <span class="icon">‚¨ÜÔ∏è</span> Refresh AM Tabs
        </button>

        <button class="btn-local btn-horizontal" onclick="requestAction('updateNotes')">
          <span class="icon">üìù</span> Update Notes Only
        </button>

        <button class="btn-warn btn-horizontal" onclick="requestAction('totalRefresh')">
          <span class="icon">üìä</span> Force Local Refresh
        </button>

        <button class="btn-warn btn-horizontal" onclick="requestAction('deleteTabs')">
          <span class="icon">‚ùå</span> Delete AM Tabs
        </button>
      </div>
    </div>

    <!-- SHARED MODALS (outside tab panels) -->
    <div style="padding: 0 12px 12px 12px;">
      <div id="confirm-modal">
        <div style="font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è Confirm Action</div>
        <div id="confirm-text" style="font-size:13px;"></div>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="executeConfirmedAction()">Run</button>
          <button class="btn-no" onclick="cancelAction()">Cancel</button>
        </div>
      </div>

      <div id="data-refresh-modal">
        <h3>üåê Select Data Refresh Scope</h3>
        
        <label class="radio-option">
          <input type="radio" name="refresh-scope" value="full" checked>
          <div class="option-text">
            <div class="option-title">Full Pipeline (All Data)</div>
            <div class="option-desc">STATCORE ‚Üí SYSCORE ‚Üí DAGCORE (Complete refresh)</div>
          </div>
        </label>
        
        <label class="radio-option">
          <input type="radio" name="refresh-scope" value="syscore">
          <div class="option-text">
            <div class="option-title">SYSCORE + DAGCORE</div>
            <div class="option-desc">Skip base STATCORE, refresh supplemental data only</div>
          </div>
        </label>
        
        <label class="radio-option">
          <input type="radio" name="refresh-scope" value="syscore-only">
          <div class="option-text">
            <div class="option-title">SYSCORE Only</div>
            <div class="option-desc">Refresh supplemental data, skip DISTRO</div>
          </div>
        </label>
        
        <label class="radio-option">
          <input type="radio" name="refresh-scope" value="dagcore">
          <div class="option-text">
            <div class="option-title">DAGCORE Only</div>
            <div class="option-desc">Refresh DISTRO sheet only (fastest)</div>
          </div>
        </label>

        <div class="checkbox-wrapper" style="margin-top: 12px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
          <input type="checkbox" id="update-notes-check"> 
          <span>Also update dynamic notes after refresh</span>
        </div>

        <div class="confirm-btns">
          <button class="btn-yes" onclick="executeDataRefresh()">Start Queued Refresh</button>
          <button class="btn-no" onclick="cancelAction()">Cancel</button>
        </div>
        
        <div style="font-size:10px; color:#666; margin-top:8px; text-align:center;">
          Queued mode processes files in batches with auto-continuation
        </div>
      </div>
      
      <div id="queue-status-modal" style="display:none; background:#f0f9ff; border:2px solid #3b82f6; border-radius:6px; padding:12px; margin-bottom:10px;">
        <h4 style="margin:0 0 10px 0; color:#1e40af;">üìã Queue Status</h4>
        <div id="queue-status-content" style="font-size:12px; line-height:1.6;"></div>
        <div class="confirm-btns" style="margin-top:10px;">
          <button class="btn-yes" onclick="continueQueue()">Continue Now</button>
          <button class="btn-no" onclick="resetQueue()">Reset Queue</button>
          <button style="background:#6b7280; color:white; padding:6px 12px; border:none; border-radius:4px; cursor:pointer;" onclick="closeQueueStatus()">Close</button>
        </div>
      </div>

      <div id="no-header-modal">
        <div style="font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è No Header Row Specified</div>
        <div style="font-size:12px; margin-bottom:10px;">
          Without a header row, the system cannot verify that target sheets have matching column structures. 
          Proceed anyway?
        </div>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="executeRangePush(true)">Push Anyway</button>
          <button class="btn-no" onclick="cancelRangeAction()">Cancel</button>
        </div>
      </div>

      <div id="mismatch-modal">
        <h3>‚ö†Ô∏è Header Mismatches Found</h3>
        <div class="mismatch-list" id="mismatch-list"></div>
        <div style="font-size:11px; margin-bottom:10px; text-align:center;">
          Force push to all files anyway? Files with mismatches will be overwritten.
        </div>
        <div class="confirm-btns">
          <button class="btn-yes" onclick="executeRangePush(true)">Force Push All</button>
          <button class="btn-no" onclick="cancelRangeAction()">Cancel</button>
        </div>
      </div>

      <div id="spinner">
        <div class="loader"></div>
        <div style="color:#666; font-size:12px;">Working...</div>
      </div>

      <div id="log-area"><div id="log-content"></div></div>
    </div>

    <!-- TOAST NOTIFICATIONS CONTAINER -->
    <div class="toast-container" id="toast-container"></div>

    <script>
      // =============================================================
      // TOAST NOTIFICATION SYSTEM
      // =============================================================
      var toastCounter = 0;
      var activeToasts = {};
      
      function showToast(type, title, message, options) {
        options = options || {};
        var id = 'toast-' + (++toastCounter);
        var container = document.getElementById('toast-container');
        
        var icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è',
          working: ''
        };
        
        var toast = document.createElement('div');
        toast.className = 'toast toast-' + type;
        toast.id = id;
        
        var iconHtml = type === 'working' 
          ? '<div class="toast-spinner"></div>'
          : '<span class="toast-icon">' + icons[type] + '</span>';
        
        var progressHtml = options.progress 
          ? '<div class="toast-progress">' + options.progressText + 
            '<div class="toast-progress-bar"><div class="toast-progress-fill" style="width:' + options.progress + '%"></div></div></div>'
          : '';
        
        toast.innerHTML = iconHtml +
          '<div class="toast-content">' +
            '<div class="toast-title">' + title + '</div>' +
            (message ? '<div class="toast-message">' + message + '</div>' : '') +
            progressHtml +
          '</div>' +
          (options.persistent ? '' : '<button class="toast-close" onclick="removeToast(\'' + id + '\')">&times;</button>');
        
        container.appendChild(toast);
        activeToasts[id] = toast;
        
        // Auto-remove non-persistent toasts
        if (!options.persistent) {
          var duration = options.duration || (type === 'error' ? 6000 : 4000);
          setTimeout(function() { removeToast(id); }, duration);
        }
        
        return id;
      }
      
      function removeToast(id) {
        var toast = document.getElementById(id);
        if (toast) {
          toast.classList.add('removing');
          setTimeout(function() {
            if (toast.parentNode) toast.parentNode.removeChild(toast);
            delete activeToasts[id];
          }, 300);
        }
      }
      
      function updateToast(id, updates) {
        var toast = document.getElementById(id);
        if (!toast) return;
        
        if (updates.title) {
          var titleEl = toast.querySelector('.toast-title');
          if (titleEl) titleEl.textContent = updates.title;
        }
        if (updates.message) {
          var msgEl = toast.querySelector('.toast-message');
          if (msgEl) msgEl.textContent = updates.message;
        }
        if (updates.progress !== undefined) {
          var fillEl = toast.querySelector('.toast-progress-fill');
          if (fillEl) fillEl.style.width = updates.progress + '%';
          var progText = toast.querySelector('.toast-progress');
          if (progText && updates.progressText) {
            progText.childNodes[0].textContent = updates.progressText;
          }
        }
        if (updates.type) {
          toast.className = 'toast toast-' + updates.type;
          // Replace spinner with icon if changing from working
          var spinner = toast.querySelector('.toast-spinner');
          if (spinner && updates.type !== 'working') {
            var icons = { success: '‚úÖ', error: '‚ùå', warning: '‚ö†Ô∏è', info: '‚ÑπÔ∏è' };
            spinner.outerHTML = '<span class="toast-icon">' + icons[updates.type] + '</span>';
          }
        }
      }
      
      function clearAllToasts() {
        Object.keys(activeToasts).forEach(function(id) {
          removeToast(id);
        });
      }

      // Persistent working toast tracker
      var workingToastId = null;
      
      function showWorkingToast(title, message) {
        if (workingToastId) removeToast(workingToastId);
        workingToastId = showToast('working', title || 'Working...', message, { persistent: true });
        return workingToastId;
      }
      
      function hideWorkingToast() {
        if (workingToastId) {
          removeToast(workingToastId);
          workingToastId = null;
        }
      }
      // =============================================================
      // TAB MANAGEMENT
      // =============================================================
      var currentTab = 'local';
      var isAdmin = false;

      function switchTab(tabId) {
        // If switching to global tab and not admin, show denied message
        if (tabId === 'global' && !isAdmin) {
          // Still switch tabs but show access denied
        }
        
        currentTab = tabId;
        
        // Update tab buttons
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
          btn.classList.remove('active');
        });
        document.getElementById('tab-' + tabId + '-btn').classList.add('active');
        
        // Update tab panels
        document.querySelectorAll('.tab-panel').forEach(function(panel) {
          panel.classList.remove('active');
        });
        document.getElementById('tab-' + tabId).classList.add('active');
        
        // Hide log area when switching tabs
        document.getElementById('log-area').style.display = 'none';
      }

      // Check admin access on load
      google.script.run
        .withSuccessHandler(function(adminStatus) {
          isAdmin = adminStatus;
          if (!isAdmin) {
            // Hide global content, show access denied (for when user clicks Global tab)
            document.getElementById('global-content').style.display = 'none';
            document.getElementById('global-access-denied').style.display = 'block';
          }
        })
        .withFailureHandler(function(e) {
          console.error("Failed to check admin status:", e);
          // Default to non-admin on error
          isAdmin = false;
          document.getElementById('global-content').style.display = 'none';
          document.getElementById('global-access-denied').style.display = 'block';
        })
        .checkAdminAccess();

      // =============================================================
      // INITIALIZATION
      // =============================================================
      
      // Initialize sheet dropdown
      google.script.run
        .withSuccessHandler(populateDropdown)
        .withFailureHandler(function(e) {
          var select = document.getElementById('sheet-selector');
          select.innerHTML = '<option value="">Error loading list</option>';
          console.error(e);
        })
        .getFilteredSheetNames();

      function populateDropdown(names) {
        var select = document.getElementById('sheet-selector');
        select.innerHTML = ''; 
        if (!names || names.length === 0) {
          var option = document.createElement('option');
          option.text = "No available sheets"; 
          option.value = ""; 
          select.add(option); 
          return;
        }
        names.forEach(function(name) {
          var option = document.createElement('option');
          option.value = name; option.text = name; select.add(option);
        });
      }

      // Initialize target sheet dropdown for Range Replicator
      google.script.run
        .withSuccessHandler(populateTargetSheetDropdown)
        .withFailureHandler(function(e) { console.error("Failed to load sheet names:", e); })
        .getAllSheetNamesForTarget();

      function populateTargetSheetDropdown(names) {
        var select = document.getElementById('target-sheet-selector');
        var firstOption = select.options[0];
        select.innerHTML = '';
        select.add(firstOption);
        
        if (names && names.length > 0) {
          names.forEach(function(name) {
            var option = document.createElement('option');
            option.value = name;
            option.text = name;
            select.add(option);
          });
        }
      }

      // =============================================================
      // ACTION HANDLING
      // =============================================================
      
      let pendingAction = null;

      function requestAction(actionType) {
        var sheetName = document.getElementById('sheet-selector').value;
        var newName = document.getElementById('new-name-input').value;
        var msg = "";

        // VALIDATION for Global Actions:
        if (['safeUpdate', 'copy', 'delete'].includes(actionType)) {
          if (sheetName === "Loading..." || sheetName === "") {
            showToast('warning', 'Please Wait', 'Sheet list is still loading');
            return;
          }
        }

        // Special handling for statcore - show options modal
        if (actionType === 'statcore') {
          document.getElementById('data-refresh-modal').style.display = 'block';
          return;
        }

        if (actionType === 'safeUpdate') msg = `GLOBAL: Deploy "${sheetName}" to all external files? (Overwrites existing)`;
        if (actionType === 'copy') {
          if(!newName) { showToast('warning', 'Missing Name', 'Please enter a New Deploy Name'); return; }
          msg = `GLOBAL: Deploy "${sheetName}" as NEW tab "${newName}" to all external files?`;
        }
        if (actionType === 'delete') msg = `WARNING: MASS TERMINATE "${sheetName}" from all external files?`;
        if (actionType === 'config') msg = `GLOBAL: Update Template IDs in "SETUP" tab for all external files?`;
        if (actionType === 'globalTabs') msg = `GLOBAL: Refresh AM Tabs in all external files? (Deletes & recreates employee tabs)`;

        if (actionType === 'createTabs') msg = `LOCAL: Refresh/Create AM Tabs based on Setup?`;
        if (actionType === 'deleteTabs') msg = `LOCAL: Delete all existing Employee tabs from this sheet?`;
        if (actionType === 'updateNotes') msg = `LOCAL: Refresh dynamic notes for this sheet only?`;
        if (actionType === 'totalRefresh') msg = `LOCAL: Force Full Refresh (Data + Notes)?`;

        document.getElementById('confirm-text').innerText = msg;
        document.getElementById('confirm-modal').style.display = 'block';
        
        pendingAction = actionType;
      }

      // Keep these for backward compatibility but they're mostly no-ops now
      function hideCurrentTabContent() {
        // Content stays visible - we use toasts now
      }

      function showCurrentTabContent() {
        // Content stays visible - we use toasts now
        if (currentTab === 'global' && isAdmin) {
          document.getElementById('local-buttons').style.display = 'grid';
        }
      }

      function cancelAction() {
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('data-refresh-modal').style.display = 'none';
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        document.getElementById('test-success-modal').style.display = 'none';
        showCurrentTabContent();
        pendingAction = null;
      }

      function executeDataRefresh() {
        var scope = document.querySelector('input[name="refresh-scope"]:checked').value;
        var updateNotes = document.getElementById('update-notes-check').checked;
        
        document.getElementById('data-refresh-modal').style.display = 'none';
        
        var toastId = showToast('working', 'Starting ' + scope + ' refresh...', 'Building queue...', { persistent: true });

        function onQueueSuccess(result) {
          removeToast(toastId);
          
          if (result.status === 'started' || result.status === 'continued') {
            var pct = result.total ? Math.round((0 / result.total) * 100) : 0;
            showToast('info', 'Queue Started', result.total + ' files queued. Auto-continues in background.', { duration: 6000 });
          } else if (result.status === 'in_progress') {
            var total = result.processed + result.remaining;
            var pct = Math.round((result.processed / total) * 100);
            showToast('info', 'Batch Complete', result.processed + ' done, ' + result.remaining + ' remaining. Auto-continuing...', { duration: 5000 });
          } else if (result.status === 'complete') {
            if (result.failed > 0) {
              showToast('warning', 'Complete with Errors', result.processed + ' successful, ' + result.failed + ' failed', { duration: 8000 });
            } else {
              showToast('success', 'All Complete!', result.processed + ' files processed successfully');
            }
          } else if (result.status === 'error') {
            showToast('error', 'Error', result.message);
          } else if (result.status === 'idle') {
            showToast('info', 'No Active Queue', 'Start a new refresh to begin');
          }
        }

        function onFailure(error) {
          removeToast(toastId);
          showToast('error', 'Error', error.message);
        }

        // Use queued refresh for all scopes
        google.script.run.withSuccessHandler(onQueueSuccess).withFailureHandler(onFailure).runQueuedDataRefresh(scope, updateNotes);
      }
      
      // === QUEUE MANAGEMENT FUNCTIONS ===
      
      function checkQueueStatus() {
        var toastId = showToast('working', 'Checking queue...', '', { persistent: true });
        
        google.script.run
          .withSuccessHandler(function(status) {
            removeToast(toastId);
            
            if (!status.active) {
              showToast('info', 'No Active Queue', 'Start a new data refresh to create one');
              return;
            }
            
            var pct = Math.round((status.completed / status.total) * 100);
            var msg = status.completed + '/' + status.total + ' files (' + pct + '%)';
            if (status.failed > 0) msg += ', ' + status.failed + ' failed';
            
            showToast('info', 'Queue: ' + status.scope, msg, { 
              duration: 8000,
              progress: pct,
              progressText: status.remaining + ' remaining'
            });
          })
          .withFailureHandler(function(error) {
            removeToast(toastId);
            showToast('error', 'Error', error.message);
          })
          .getFleetQueueStatus();
      }
      
      function continueQueue() {
        var toastId = showToast('working', 'Processing batch...', '', { persistent: true });
        
        google.script.run
          .withSuccessHandler(function(result) {
            removeToast(toastId);
            
            if (result.status === 'complete') {
              if (result.failed > 0) {
                showToast('warning', 'Complete with Errors', result.processed + ' successful, ' + result.failed + ' failed');
              } else {
                showToast('success', 'All Complete!', result.processed + ' files processed');
              }
            } else if (result.status === 'in_progress') {
              showToast('info', 'Batch Complete', result.processed + ' done, ' + result.remaining + ' remaining');
            } else if (result.status === 'idle') {
              showToast('info', 'No Active Queue', 'Nothing to continue');
            } else {
              showToast('info', 'Queue Running', result.message || 'Processing...');
            }
          })
          .withFailureHandler(function(error) {
            removeToast(toastId);
            showToast('error', 'Error', error.message);
          })
          .continueFleetQueue();
      }
      
      function resetQueue() {
        if (!confirm("Reset the queue? This will stop any pending processing.")) return;
        
        var toastId = showToast('working', 'Resetting queue...', '', { persistent: true });
        
        google.script.run
          .withSuccessHandler(function(result) {
            removeToast(toastId);
            showToast('success', 'Queue Reset', result.message);
          })
          .withFailureHandler(function(error) {
            removeToast(toastId);
            showToast('error', 'Error', error.message);
          })
          .resetFleetQueue();
      }
      
      // Keep for backward compatibility
      function closeQueueStatus() {}

      function executeConfirmedAction() {
        var actionToRun = pendingAction; 
        
        if (!actionToRun) {
          showToast('error', 'Error', 'No action selected');
          cancelAction();
          return;
        }

        document.getElementById('confirm-modal').style.display = 'none';
        
        var actionLabels = {
          safeUpdate: 'Deploying Update',
          copy: 'Deploying New Tab',
          delete: 'Deleting Tabs',
          config: 'Updating IDs',
          globalTabs: 'Refreshing AM Tabs',
          createTabs: 'Creating Tabs',
          deleteTabs: 'Deleting Tabs',
          updateNotes: 'Updating Notes',
          totalRefresh: 'Running Full Refresh'
        };
        
        var toastId = showToast('working', actionLabels[actionToRun] || 'Working...', '', { persistent: true });

        var sheetName = document.getElementById('sheet-selector').value;
        var newName = document.getElementById('new-name-input').value;
        var hideCheck = document.getElementById('hide-check').checked;

        function onFailure(error) {
          removeToast(toastId);
          pendingAction = null; 
          showToast('error', 'Error', error.message);
        }
        
        function onLogsSuccess(logs) {
          removeToast(toastId);
          showLogsAsToast(logs);
        }
        
        function onSimpleSuccess(msg) {
          removeToast(toastId);
          showToast('success', msg, '');
        }

        if (actionToRun === 'safeUpdate') {
          google.script.run.withSuccessHandler(onLogsSuccess).withFailureHandler(onFailure).runUpdateSheetSafe(sheetName, hideCheck);
        } else if (actionToRun === 'copy') {
          google.script.run.withSuccessHandler(onLogsSuccess).withFailureHandler(onFailure).runCopySheet(sheetName, newName, hideCheck);
        } else if (actionToRun === 'delete') {
          google.script.run.withSuccessHandler(onLogsSuccess).withFailureHandler(onFailure).runDeleteSheet(sheetName);
        } else if (actionToRun === 'config') {
          google.script.run.withSuccessHandler(onLogsSuccess).withFailureHandler(onFailure).runUpdateSheet();
        } else if (actionToRun === 'globalTabs') {
          google.script.run.withSuccessHandler(onLogsSuccess).withFailureHandler(onFailure).runCreateEmployeeTabs();
        } else if (actionToRun === 'createTabs') {
          google.script.run.withSuccessHandler(function() { onSimpleSuccess('AM Tabs Refreshed'); }).withFailureHandler(onFailure).createEmployeeTabs();
        } else if (actionToRun === 'deleteTabs') {
          google.script.run.withSuccessHandler(function() { onSimpleSuccess('Tabs Deleted'); }).withFailureHandler(onFailure).deleteEmployeeTabs();
        } else if (actionToRun === 'updateNotes') {
          google.script.run.withSuccessHandler(function() { onSimpleSuccess('Notes Updated'); }).withFailureHandler(onFailure).manualUpdateNotesOnly();
        } else if (actionToRun === 'totalRefresh') {
          google.script.run.withSuccessHandler(function() { onSimpleSuccess('Local Refresh Complete'); }).withFailureHandler(onFailure).runMasterPipeline(); 
        }

        pendingAction = null;
      }
      
      // Show logs summary as toast
      function showLogsAsToast(logs) {
        if (!logs || logs.length === 0) {
          showToast('success', 'Complete', 'Operation finished');
          return;
        }
        
        var success = logs.filter(function(l) { return l.status === 'Success'; }).length;
        var errors = logs.filter(function(l) { return l.status === 'Error'; }).length;
        var warnings = logs.filter(function(l) { return l.status === 'Warning'; }).length;
        
        var msg = success + ' success';
        if (errors > 0) msg += ', ' + errors + ' errors';
        if (warnings > 0) msg += ', ' + warnings + ' warnings';
        
        var type = errors > 0 ? 'warning' : 'success';
        showToast(type, 'Operation Complete', msg, { duration: 5000 });
      }

      // Show logs - now just uses toast summary (log area hidden by CSS)
      function showLogs(logs) {
        showLogsAsToast(logs);
      }

      function showSimpleSuccess(msg) {
        showToast('success', msg, '');
      }

      // =============================================================
      // RANGE REPLICATOR FUNCTIONS
      // =============================================================
      
      let capturedRangeData = null;

      function toggleAltRange() {
        var checkbox = document.getElementById('alt-range-check');
        var input = document.getElementById('alt-range-input');
        input.style.display = checkbox.checked ? 'block' : 'none';
        if (!checkbox.checked) {
          input.value = '';
        }
      }

      var fleetFilesLoaded = false;
      function loadFleetFiles() {
        if (fleetFilesLoaded) return;
        google.script.run
          .withSuccessHandler(function(files) {
            var select = document.getElementById('fleet-file-selector');
            select.innerHTML = '<option value="">‚Äî Select a file ‚Äî</option>';
            if (files && files.length > 0) {
              files.forEach(function(file) {
                var option = document.createElement('option');
                option.value = file.id;
                option.text = file.name;
                select.add(option);
              });
              fleetFilesLoaded = true;
            } else {
              select.innerHTML = '<option value="">No fleet files found</option>';
            }
          })
          .withFailureHandler(function(e) {
            var select = document.getElementById('fleet-file-selector');
            select.innerHTML = '<option value="">Error loading files</option>';
            console.error("Failed to load fleet files:", e);
          })
          .getFleetFileList();
      }

      function toggleTestMode() {
        var checkbox = document.getElementById('test-mode-check');
        var wrapper = document.getElementById('test-file-wrapper');
        var pushBtnText = document.getElementById('push-btn-text');
        
        if (checkbox.checked) {
          wrapper.style.display = 'block';
          pushBtnText.textContent = 'Test Push';
          loadFleetFiles();
        } else {
          wrapper.style.display = 'none';
          pushBtnText.textContent = 'Push to Fleet';
          document.getElementById('fleet-file-selector').value = '';
        }
      }

      function captureRange() {
        document.getElementById('range-display').innerHTML = '<div style="text-align:center; color:#718096;">Capturing...</div>';
        
        google.script.run
          .withSuccessHandler(function(data) {
            capturedRangeData = data;
            updateRangeDisplay(data);
          })
          .withFailureHandler(function(e) {
            document.getElementById('range-display').innerHTML = 
              '<div class="range-label" style="color:#c53030;">Capture Failed</div>' +
              '<div class="range-info">' + e.message + '</div>';
            capturedRangeData = null;
          })
          .captureSelectedRange();
      }

      function updateRangeDisplay(data) {
        var display = document.getElementById('range-display');
        display.className = 'range-display captured';
        
        var badgesHtml = '<div class="range-badges">';
        if (data.hasFormulas) badgesHtml += '<span class="badge badge-formula">Has Formulas</span>';
        if (data.hasRichText) badgesHtml += '<span class="badge badge-richtext">Has Rich Text</span>';
        badgesHtml += '</div>';
        
        var headersPreview = data.firstRowHeaders.slice(0, 5).join(', ');
        if (data.firstRowHeaders.length > 5) headersPreview += '...';
        
        display.innerHTML = 
          '<div class="range-label">Range Captured</div>' +
          '<div class="range-info">' +
            '<span>Sheet: <strong>' + data.sheetName + '</strong></span>' +
            '<span>Range: <strong>' + data.rangeA1 + '</strong></span>' +
            '<span>Size: <strong>' + data.numRows + ' √ó ' + data.numCols + '</strong></span>' +
          '</div>' +
          badgesHtml +
          '<div class="range-headers">Row 1: ' + headersPreview + '</div>';
      }

      function requestRangeAction(actionType) {
        if (!capturedRangeData) {
          showToast('warning', 'No Range', 'Please capture a range first');
          return;
        }
        
        if (isTestMode() && !getTestFileId()) {
          showToast('warning', 'Select File', 'Test Mode enabled - please select a target file');
          return;
        }
        
        var headerRow = document.getElementById('header-row-input').value;
        
        if (actionType === 'verify') {
          if (!headerRow) {
            showToast('warning', 'Header Row Required', 'Enter a header row number to verify');
            return;
          }
          executeRangeVerify();
        } else if (actionType === 'push') {
          if (!headerRow) {
            document.getElementById('no-header-modal').style.display = 'block';
          } else {
            executeRangeVerifyThenPush();
          }
        }
      }

      function cancelRangeAction() {
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('test-success-modal').style.display = 'none';
      }

      function buildRangeConfig() {
        var targetSheet = document.getElementById('target-sheet-selector').value;
        var altRangeChecked = document.getElementById('alt-range-check').checked;
        var altRange = document.getElementById('alt-range-input').value;
        var headerRow = document.getElementById('header-row-input').value;
        var testModeChecked = document.getElementById('test-mode-check').checked;
        var selectedFileId = document.getElementById('fleet-file-selector').value;
        
        return {
          sheetName: capturedRangeData.sheetName,
          rangeA1: capturedRangeData.rangeA1,
          targetSheetName: targetSheet || capturedRangeData.sheetName,
          targetRangeA1: (altRangeChecked && altRange) ? altRange : capturedRangeData.rangeA1,
          headerRow: headerRow,
          numRows: capturedRangeData.numRows,
          numCols: capturedRangeData.numCols,
          data: capturedRangeData.data,
          firstRowHeaders: capturedRangeData.firstRowHeaders,
          testMode: testModeChecked,
          testFileId: selectedFileId
        };
      }
      
      function isTestMode() {
        return document.getElementById('test-mode-check').checked;
      }
      
      function getTestFileId() {
        return document.getElementById('fleet-file-selector').value;
      }

      function executeRangeVerify() {
        var toastId = showToast('working', 'Verifying headers...', '', { persistent: true });
        
        var config = buildRangeConfig();
        
        var successHandler = function(logs) {
          removeToast(toastId);
          
          var success = logs.filter(function(l) { return l.status === 'Success'; }).length;
          var warnings = logs.filter(function(l) { return l.status === 'Warning'; }).length;
          
          if (warnings > 0) {
            showToast('warning', 'Header Mismatches', warnings + ' file(s) have different headers', { duration: 6000 });
          } else {
            showToast('success', 'Headers Verified', success + ' file(s) have matching headers');
          }
        };
        
        var failureHandler = function(e) {
          removeToast(toastId);
          showToast('error', 'Verification Error', e.message);
        };
        
        if (isTestMode()) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeadersSingleFile(config, getTestFileId());
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeaders(config);
        }
      }

      function executeRangeVerifyThenPush() {
        var toastId = showToast('working', 'Verifying before push...', '', { persistent: true });
        
        var config = buildRangeConfig();
        
        var successHandler = function(logs) {
          removeToast(toastId);
          
          var mismatches = logs.filter(function(log) {
            return log.status === 'Warning' && log.msg.includes('Mismatch');
          });
          
          if (mismatches.length > 0) {
            var mismatchHtml = '';
            mismatches.forEach(function(m) {
              mismatchHtml += '<div style="padding:4px; border-bottom:1px solid #fecaca;">' +
                '<strong>' + m.file + '</strong>: ' + m.msg + '</div>';
            });
            document.getElementById('mismatch-list').innerHTML = mismatchHtml;
            document.getElementById('mismatch-modal').style.display = 'block';
          } else {
            executeRangePush(false);
          }
        };
        
        var failureHandler = function(e) {
          removeToast(toastId);
          showToast('error', 'Verification Error', e.message);
        };
        
        if (isTestMode()) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeadersSingleFile(config, getTestFileId());
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeaders(config);
        }
      }

      var lastTestFileId = null;
      var lastTestFileName = null;

      function executeRangePush(forceOverwrite) {
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        
        var config = buildRangeConfig();
        var testMode = isTestMode();
        
        if (testMode) {
          lastTestFileId = getTestFileId();
          var selector = document.getElementById('fleet-file-selector');
          lastTestFileName = selector.options[selector.selectedIndex].text;
        }
        
        var toastId = showToast('working', testMode ? 'Pushing to test file...' : 'Pushing to fleet...', '', { persistent: true });
        
        var successHandler = function(logs) {
          removeToast(toastId);
          
          var wasSuccess = logs && logs.length > 0 && logs.some(function(l) { return l.status === 'Success'; });
          var errors = logs ? logs.filter(function(l) { return l.status === 'Error'; }).length : 0;
          
          if (testMode && wasSuccess) {
            document.getElementById('test-success-filename').textContent = lastTestFileName;
            document.getElementById('test-success-modal').style.display = 'block';
            showToast('success', 'Test Push Complete', lastTestFileName);
          } else if (wasSuccess && errors === 0) {
            showToast('success', 'Push Complete', logs.length + ' file(s) updated');
          } else if (errors > 0) {
            showToast('warning', 'Push Complete with Errors', errors + ' file(s) failed');
          } else {
            showToast('info', 'Push Complete', 'Operation finished');
          }
        };
        
        var failureHandler = function(e) {
          removeToast(toastId);
          showToast('error', 'Push Error', e.message);
        };
        
        if (testMode) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .pushRangeToSingleFile(config, lastTestFileId, forceOverwrite);
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .pushRangeToFleet(config, forceOverwrite);
        }
      }

      function openTestFile() {
        if (lastTestFileId) {
          var url = 'https://docs.google.com/spreadsheets/d/' + lastTestFileId + '/edit';
          window.open(url, '_blank');
        }
        closeTestSuccessModal();
      }

      function closeTestSuccessModal() {
        document.getElementById('test-success-modal').style.display = 'none';
      }
      
      // =============================================================
      // AI FEEDBACK EXPORT
      // =============================================================
      function exportAIFeedback() {
        google.script.run
          .withFailureHandler(function(e) {
            showToast('error', 'Export Failed', e.message);
          })
          .showFeedbackExportDialog();
      }

      // =============================================================
      // API CONNECTION TEST
      // =============================================================
      function testApiConnection() {
        var toastId = showToast('working', 'Testing API...', 'Pinging Gemini API', { persistent: true });
        
        google.script.run
          .withSuccessHandler(function(result) {
            removeToast(toastId);
            
            if (result.success) {
              showToast('success', 'API Connected', 'Response: ' + result.durationMs + 'ms latency', { duration: 6000 });
            } else {
              var errorMsg = result.error || 'Unknown error';
              if (errorMsg.includes('not found')) {
                showToast('error', 'API Key Missing', 'Add GEMINI_API_KEY to Script Properties', { duration: 8000 });
              } else {
                showToast('error', 'API Error', errorMsg, { duration: 8000 });
              }
            }
          })
          .withFailureHandler(function(e) {
            removeToast(toastId);
            var errorMsg = e.message || 'Unknown error';
            if (errorMsg.includes('not found')) {
              showToast('error', 'API Key Missing', 'Add GEMINI_API_KEY to Script Properties', { duration: 8000 });
            } else {
              showToast('error', 'API Test Failed', errorMsg, { duration: 8000 });
            }
          })
          .pingGeminiApi();
      }
    </script>
  </body>
</html>
