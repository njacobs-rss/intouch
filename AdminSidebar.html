<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      /* --- GLOBAL RESET & TYPOGRAPHY --- */
      body { 
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
        padding: 12px; 
        background-color: #f8fafc; 
        color: #333; 
        margin: 0;
      }

      h2 { 
        color: #4a5568; 
        text-align: center; 
        font-size: 13px; 
        margin: 0 0 12px 0; 
        font-weight: 800;
        letter-spacing: 0.5px;
        text-transform: uppercase;
      }

      /* --- INPUT CONTROL GROUP (THE COCKPIT) --- */
      .control-group { 
        background: white; 
        padding: 12px; 
        border-radius: 8px; 
        box-shadow: 0 1px 3px rgba(0,0,0,0.05); 
        border: 1px solid #e2e8f0;
        margin-bottom: 15px;
      }

      label { 
        font-size: 10px; 
        font-weight: 700; 
        text-transform: uppercase; 
        color: #718096; 
        display: block; 
        margin-bottom: 4px; 
      }
      
      select, input[type="text"] { 
        width: 100%; 
        padding: 8px; 
        border: 1px solid #cbd5e0; 
        border-radius: 5px; 
        box-sizing: border-box; 
        font-size: 12px; 
        background-color: #fff;
        margin-bottom: 10px;
      }

      .checkbox-wrapper {
        font-size: 11px; 
        margin-top: 2px;
        display: flex;
        align-items: center;
        color: #4a5568;
      }
      
      .checkbox-wrapper input { margin-right: 6px; }

      /* --- BUTTON GRIDS --- */
      
      /* Row of 3 (Dense) */
      .grid-3 {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
      }
      
      /* Row of 2 */
      .grid-2 {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        margin-bottom: 8px;
      }

      /* Standard Stack */
      .grid-1 {
        display: grid;
        grid-template-columns: 1fr;
        gap: 8px;
      }

      /* --- BUTTON STYLES --- */
      button { 
        padding: 10px 8px; 
        border: 1px solid #e2e8f0; 
        border-radius: 6px; 
        cursor: pointer; 
        font-size: 11px; 
        font-weight: 600; 
        color: #2d3748; 
        background: white;
        transition: all 0.2s ease;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        
        /* Flex setup for centering */
        display: flex; 
        justify-content: center;
        align-items: center;
      }

      button:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        background: #fafbfc;
      }

      /* Vertical Button (Icon Top, Text Bottom) - For Global Grid */
      .btn-vertical {
        flex-direction: column;
        text-align: center;
        height: 100%; /* Fill grid cell */
      }
      .btn-vertical .icon { margin-bottom: 5px; margin-right: 0; font-size: 18px; }

      /* Horizontal Button (Icon Left) - For Local List */
      .btn-horizontal {
        flex-direction: row;
        text-align: left;
        justify-content: flex-start;
      }
      .btn-horizontal .icon { margin-right: 10px; font-size: 16px; }

      /* --- COLOR CODING --- */
      .btn-safe   { border-top: 3px solid #27ae60; } /* Green Top for Vertical */
      .btn-copy   { border-top: 3px solid #2980b9; } /* Blue Top */
      .btn-del    { border-top: 3px solid #c0392b; } /* Red Top */
      .btn-config { border-top: 3px solid #f39c12; } /* Orange Top */
      
      /* Local buttons keep side borders */
      .btn-local  { border-left: 4px solid #8e44ad; } 
      .btn-warn   { border-left: 4px solid #d35400; } 

      /* --- DIVIDER --- */
      .section-divider {
        border: 0;
        height: 1px;
        background: #cbd5e0;
        margin: 20px 0;
      }

      /* --- UTILS --- */
      #confirm-modal { display: none; background: #fff8e1; border: 1px solid #ffe58f; color: #b7791f; padding: 15px; border-radius: 6px; margin-top: 20px; text-align: center; }
      .confirm-btns { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
      .btn-yes { background: #28a745; color: white; border: none; padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer; }
      .btn-no { background: #718096; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }

      /* Data Refresh Options Modal */
      #data-refresh-modal { display: none; background: #e8f4fd; border: 1px solid #90cdf4; color: #2b6cb0; padding: 15px; border-radius: 6px; margin-top: 20px; }
      #data-refresh-modal h3 { margin: 0 0 12px 0; font-size: 13px; text-align: center; }
      .radio-option { display: flex; align-items: flex-start; margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0; cursor: pointer; }
      .radio-option:hover { background: #f7fafc; border-color: #90cdf4; }
      .radio-option input { margin-right: 10px; margin-top: 3px; }
      .radio-option .option-text { flex: 1; }
      .radio-option .option-title { font-weight: 600; font-size: 12px; color: #2d3748; }
      .radio-option .option-desc { font-size: 10px; color: #718096; margin-top: 2px; }
      
      #spinner { display: none; text-align: center; margin: 30px 0; }
      .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3182ce; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 0 auto 10px auto; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      #log-area { display: none; margin-top: 20px; font-size: 11px; max-height: 150px; overflow-y: auto; background: white; border: 1px solid #e2e8f0; border-radius: 4px; }
      .log-entry { padding: 6px; border-bottom: 1px solid #edf2f7; display: flex; justify-content: space-between; }
      .status-success { color: #27ae60; font-weight: bold; }
      .status-error { color: #c0392b; font-weight: bold; }
      .status-warning { color: #d69e2e; font-weight: bold; }

      /* --- RANGE REPLICATOR STYLES --- */
      .range-display {
        background: #f7fafc;
        border: 1px dashed #cbd5e0;
        border-radius: 6px;
        padding: 10px;
        margin-bottom: 12px;
        font-size: 11px;
        min-height: 50px;
      }
      .range-display.captured {
        background: #e6fffa;
        border-color: #38b2ac;
        border-style: solid;
      }
      .range-display .range-label {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 4px;
      }
      .range-display .range-info {
        color: #718096;
        font-size: 10px;
      }
      .range-display .range-info span {
        display: inline-block;
        margin-right: 12px;
      }
      .range-display .range-headers {
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px solid #e2e8f0;
        color: #4a5568;
        font-size: 10px;
        word-break: break-word;
      }
      .range-badges {
        margin-top: 6px;
      }
      .badge {
        display: inline-block;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 9px;
        font-weight: 600;
        margin-right: 4px;
      }
      .badge-formula { background: #fef3c7; color: #92400e; }
      .badge-richtext { background: #dbeafe; color: #1e40af; }
      
      .inline-input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }
      .inline-input-group > div {
        flex: 1;
      }
      .inline-input-group input[type="text"],
      .inline-input-group input[type="number"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #cbd5e0;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 12px;
      }
      .inline-input-group input[type="number"] {
        width: 70px;
      }

      /* No Header Warning Modal */
      #no-header-modal { 
        display: none; 
        background: #fef3c7; 
        border: 1px solid #f59e0b; 
        color: #92400e; 
        padding: 15px; 
        border-radius: 6px; 
        margin-top: 20px; 
        text-align: center; 
      }

      /* Header Mismatch Modal */
      #mismatch-modal { 
        display: none; 
        background: #fed7d7; 
        border: 1px solid #f56565; 
        color: #c53030; 
        padding: 15px; 
        border-radius: 6px; 
        margin-top: 20px; 
      }
      #mismatch-modal h3 { margin: 0 0 10px 0; font-size: 13px; text-align: center; }
      .mismatch-list {
        max-height: 100px;
        overflow-y: auto;
        background: white;
        border-radius: 4px;
        padding: 8px;
        margin-bottom: 12px;
        font-size: 10px;
      }
    </style>
  </head>
  <body>

    <h2>üöÄ Global Functions (All Sheets)</h2>
    
    <div class="control-group">
      <label>Target Sheet (For Global Ops)</label>
      <select id="sheet-selector"><option>Loading...</option></select>
      
      <label>New Deploy Name (Copy Only)</label>
      <input type="text" id="new-name-input" placeholder="Enter new tab name...">
      
      <div class="checkbox-wrapper">
        <input type="checkbox" id="hide-check"> 
        <span>Hide sheet after deployment?</span>
      </div>
    </div>

    <div class="grid-3" id="global-row-1">
      <button class="btn-safe btn-vertical" onclick="requestAction('safeUpdate')">
        <span class="icon">üìë</span> Deploy Update (All)
      </button>

      <button class="btn-copy btn-vertical" onclick="requestAction('copy')">
        <span class="icon">üìë</span> Deploy New (All)
      </button>

      <button class="btn-del btn-vertical" onclick="requestAction('delete')">
        <span class="icon">üö´</span> Mass Terminate (All)
      </button>
    </div>

    <div class="grid-3" id="global-row-2">
      <button class="btn-local btn-vertical" onclick="requestAction('statcore')">
        <span class="icon">üåê</span> Global Data Refresh (All)
      </button>

      <button class="btn-config btn-vertical" onclick="requestAction('config')">
        <span class="icon">‚öôÔ∏è</span> Update Setup IDs (Global)
      </button>

      <button class="btn-safe btn-vertical" onclick="requestAction('globalTabs')">
        <span class="icon">üë•</span> Refresh AM Tabs (All)
      </button>
    </div>

    <hr class="section-divider">

    <h2 id="range-replicator-header">üìã Range Replicator</h2>
    
    <div class="control-group" id="range-replicator-section">
      <div class="range-display" id="range-display">
        <div class="range-label">No range captured</div>
        <div class="range-info">
          <span>Sheet: ‚Äî</span>
          <span>Range: ‚Äî</span>
          <span>Size: ‚Äî √ó ‚Äî</span>
        </div>
      </div>
      
      <button class="btn-copy btn-horizontal" onclick="captureRange()" style="width:100%; margin-bottom:12px;">
        <span class="icon">üì∑</span> Capture Selection
      </button>
      
      <div class="inline-input-group">
        <div>
          <label>Header Row (for verify)</label>
          <input type="number" id="header-row-input" placeholder="Row #" min="1">
        </div>
        <div style="flex:2;">
          <label>Target Sheet</label>
          <select id="target-sheet-selector"><option value="">‚Äî Same as source ‚Äî</option></select>
        </div>
      </div>
      
      <div class="checkbox-wrapper" style="margin-bottom:8px;">
        <input type="checkbox" id="alt-range-check" onchange="toggleAltRange()"> 
        <span>Use different target range</span>
      </div>
      
      <input type="text" id="alt-range-input" placeholder="e.g., A5:F20" style="display:none; margin-bottom:12px;">
      
      <div class="checkbox-wrapper" style="margin-bottom:8px; padding:8px; background:#fff7ed; border:1px solid #fed7aa; border-radius:4px;">
        <input type="checkbox" id="test-mode-check" onchange="toggleTestMode()"> 
        <span style="color:#c2410c; font-weight:600;">Test Mode (Single File)</span>
      </div>
      
      <div id="test-file-wrapper" style="display:none; margin-bottom:12px;">
        <label>Target Fleet File</label>
        <select id="fleet-file-selector"><option value="">Loading fleet files...</option></select>
      </div>
      
      <div class="grid-2">
        <button class="btn-config btn-vertical" onclick="requestRangeAction('verify')" id="btn-verify">
          <span class="icon">‚úì</span> Verify Headers
        </button>
        <button class="btn-safe btn-vertical" onclick="requestRangeAction('push')" id="btn-push">
          <span class="icon">üöÄ</span> <span id="push-btn-text">Push to Fleet</span>
        </button>
      </div>
      
      <div id="test-success-modal" style="display:none; background:#e6fffa; border:1px solid #38b2ac; color:#234e52; padding:12px; border-radius:6px; margin-top:12px; text-align:center;">
        <div style="font-weight:bold; margin-bottom:6px; font-size:13px;">‚úÖ Test Push Complete!</div>
        <div style="font-size:11px; margin-bottom:4px;">Successfully pushed to:</div>
        <div id="test-success-filename" style="font-weight:600; color:#2c7a7b; margin-bottom:10px; font-size:12px;"></div>
        <div style="font-size:10px; margin-bottom:8px;">Would you like to open the file to verify?</div>
        <div class="confirm-btns" style="margin-top:0;">
          <button class="btn-yes" onclick="openTestFile()">Open File</button>
          <button class="btn-no" onclick="closeTestSuccessModal()">Done</button>
        </div>
      </div>
    </div>

    <hr class="section-divider">

    <h2>üìç Local Functions (This File)</h2>
    
    <div class="grid-1" id="local-buttons">
      <button class="btn-local btn-horizontal" onclick="requestAction('createTabs')">
        <span class="icon">‚¨ÜÔ∏è</span> Refresh AM Tabs
      </button>

      <button class="btn-local btn-horizontal" onclick="requestAction('updateNotes')">
        <span class="icon">üìù</span> Update Notes Only
      </button>

      <button class="btn-warn btn-horizontal" onclick="requestAction('totalRefresh')">
        <span class="icon">üìä</span> Force Local Refresh
      </button>

      <button class="btn-warn btn-horizontal" onclick="requestAction('deleteTabs')">
        <span class="icon">‚ùå</span> Delete AM Tabs
      </button>
    </div>

    <div id="confirm-modal">
      <div style="font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è Confirm Action</div>
      <div id="confirm-text" style="font-size:13px;"></div>
      <div class="confirm-btns">
        <button class="btn-yes" onclick="executeConfirmedAction()">Run</button>
        <button class="btn-no" onclick="cancelAction()">Cancel</button>
      </div>
    </div>

    <div id="data-refresh-modal">
      <h3>üåê Select Data Refresh Scope</h3>
      
      <label class="radio-option">
        <input type="radio" name="refresh-scope" value="full" checked>
        <div class="option-text">
          <div class="option-title">Full Pipeline (All Data)</div>
          <div class="option-desc">STATCORE ‚Üí SYSCORE ‚Üí DAGCORE (Complete refresh)</div>
        </div>
      </label>
      
      <label class="radio-option">
        <input type="radio" name="refresh-scope" value="syscore">
        <div class="option-text">
          <div class="option-title">SYSCORE + DAGCORE</div>
          <div class="option-desc">Skip base STATCORE, refresh supplemental data only</div>
        </div>
      </label>
      
      <label class="radio-option">
        <input type="radio" name="refresh-scope" value="syscore-only">
        <div class="option-text">
          <div class="option-title">SYSCORE Only</div>
          <div class="option-desc">Refresh supplemental data, skip DISTRO</div>
        </div>
      </label>
      
      <label class="radio-option">
        <input type="radio" name="refresh-scope" value="dagcore">
        <div class="option-text">
          <div class="option-title">DAGCORE Only</div>
          <div class="option-desc">Refresh DISTRO sheet only (fastest)</div>
        </div>
      </label>

      <div class="checkbox-wrapper" style="margin-top: 12px; padding: 8px; background: white; border-radius: 4px; border: 1px solid #e2e8f0;">
        <input type="checkbox" id="update-notes-check"> 
        <span>Also update dynamic notes after refresh</span>
      </div>

      <div class="confirm-btns">
        <button class="btn-yes" onclick="executeDataRefresh()">Run Selected</button>
        <button class="btn-no" onclick="cancelAction()">Cancel</button>
      </div>
    </div>

    <div id="no-header-modal">
      <div style="font-weight:bold; margin-bottom:5px;">‚ö†Ô∏è No Header Row Specified</div>
      <div style="font-size:12px; margin-bottom:10px;">
        Without a header row, the system cannot verify that target sheets have matching column structures. 
        Proceed anyway?
      </div>
      <div class="confirm-btns">
        <button class="btn-yes" onclick="executeRangePush(true)">Push Anyway</button>
        <button class="btn-no" onclick="cancelRangeAction()">Cancel</button>
      </div>
    </div>

    <div id="mismatch-modal">
      <h3>‚ö†Ô∏è Header Mismatches Found</h3>
      <div class="mismatch-list" id="mismatch-list"></div>
      <div style="font-size:11px; margin-bottom:10px; text-align:center;">
        Force push to all files anyway? Files with mismatches will be overwritten.
      </div>
      <div class="confirm-btns">
        <button class="btn-yes" onclick="executeRangePush(true)">Force Push All</button>
        <button class="btn-no" onclick="cancelRangeAction()">Cancel</button>
      </div>
    </div>

    <div id="spinner">
      <div class="loader"></div>
      <div style="color:#666; font-size:12px;">Working...</div>
    </div>

    <div id="log-area"><div id="log-content"></div></div>

    <script>
      // 1. Initialize Dropdown with Failure Handler
      google.script.run
        .withSuccessHandler(populateDropdown)
        .withFailureHandler(function(e) {
             var select = document.getElementById('sheet-selector');
             select.innerHTML = '<option value="">Error loading list</option>';
             console.error(e);
        })
        .getFilteredSheetNames();

      function populateDropdown(names) {
        var select = document.getElementById('sheet-selector');
        select.innerHTML = ''; 
        if (!names || names.length === 0) {
           var option = document.createElement('option');
           option.text = "No available sheets"; 
           option.value = ""; 
           select.add(option); 
           return;
        }
        names.forEach(function(name) {
          var option = document.createElement('option');
          option.value = name; option.text = name; select.add(option);
        });
      }

      // 2. Request Action
      let pendingAction = null;

      function requestAction(actionType) {
        var sheetName = document.getElementById('sheet-selector').value;
        var newName = document.getElementById('new-name-input').value;
        var msg = "";

        // VALIDATION for Global Actions:
        if (['safeUpdate', 'copy', 'delete'].includes(actionType)) {
             if (sheetName === "Loading..." || sheetName === "") {
                  alert("‚ö†Ô∏è Please wait for the Sheet List to load, or check for errors.");
                  return;
             }
        }

        // Special handling for statcore - show options modal instead
        if (actionType === 'statcore') {
          document.getElementById('data-refresh-modal').style.display = 'block';
          document.getElementById('global-row-1').style.display = 'none'; 
          document.getElementById('global-row-2').style.display = 'none'; 
          document.getElementById('local-buttons').style.display = 'none'; 
          document.querySelector('.control-group').style.display = 'none';
          document.getElementById('range-replicator-section').style.display = 'none';
          document.getElementById('range-replicator-header').style.display = 'none';
          document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'none'; });
          return;
        }

        if (actionType === 'safeUpdate') msg = `GLOBAL: Deploy "${sheetName}" to all external files? (Overwrites existing)`;
        if (actionType === 'copy') {
           if(!newName) { alert("Please enter a New Deploy Name."); return; }
           msg = `GLOBAL: Deploy "${sheetName}" as NEW tab "${newName}" to all external files?`;
        }
        if (actionType === 'delete') msg = `WARNING: MASS TERMINATE "${sheetName}" from all external files?`;
        if (actionType === 'config') msg = `GLOBAL: Update Template IDs in "SETUP" tab for all external files?`;
        if (actionType === 'globalTabs') msg = `GLOBAL: Refresh AM Tabs in all external files? (Deletes & recreates employee tabs)`;

        if (actionType === 'createTabs') msg = `LOCAL: Refresh/Create AM Tabs based on Setup?`;
        if (actionType === 'deleteTabs') msg = `LOCAL: Delete all existing Employee tabs from this sheet?`;
        if (actionType === 'updateNotes') msg = `LOCAL: Refresh dynamic notes for this sheet only?`;
        if (actionType === 'totalRefresh') msg = `LOCAL: Force Full Refresh (Data + Notes)?`;

        document.getElementById('confirm-text').innerText = msg;
        document.getElementById('confirm-modal').style.display = 'block';
        
        // Hide all control sections during confirmation
        document.getElementById('global-row-1').style.display = 'none'; 
        document.getElementById('global-row-2').style.display = 'none'; 
        document.getElementById('local-buttons').style.display = 'none'; 
        document.querySelector('.control-group').style.display = 'none';
        document.getElementById('range-replicator-section').style.display = 'none';
        document.getElementById('range-replicator-header').style.display = 'none';
        document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'none'; });
        
        pendingAction = actionType;
      }

      function cancelAction() {
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('data-refresh-modal').style.display = 'none';
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        document.getElementById('test-success-modal').style.display = 'none';
        document.getElementById('global-row-1').style.display = 'grid'; 
        document.getElementById('global-row-2').style.display = 'grid'; 
        document.getElementById('local-buttons').style.display = 'grid'; 
        document.querySelector('.control-group').style.display = 'block';
        // Show Range Replicator sections
        var rangeSection = document.getElementById('range-replicator-section');
        var rangeHeader = document.getElementById('range-replicator-header');
        if (rangeSection) rangeSection.style.display = 'block';
        if (rangeHeader) rangeHeader.style.display = 'block';
        document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'block'; });
        document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'block'; });
        pendingAction = null;
      }

      // Data Refresh with scope selection
      function executeDataRefresh() {
        var scope = document.querySelector('input[name="refresh-scope"]:checked').value;
        var updateNotes = document.getElementById('update-notes-check').checked;
        
        document.getElementById('data-refresh-modal').style.display = 'none';
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('log-area').style.display = 'none';
        document.getElementById('log-content').innerHTML = '';

        console.log("Running data refresh with scope: " + scope + ", updateNotes: " + updateNotes);

        function onFailure(error) {
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('global-row-1').style.display = 'grid'; 
          document.getElementById('global-row-2').style.display = 'grid'; 
          document.getElementById('local-buttons').style.display = 'grid'; 
          document.querySelector('.control-group').style.display = 'block';
          document.getElementById('range-replicator-section').style.display = 'block';
          document.getElementById('range-replicator-header').style.display = 'block';
          document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'block'; });
          document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'block'; });
          alert("‚ùå ERROR: " + error.message);
        }

        if (scope === 'full') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateSTATCORE(updateNotes);
        } 
        else if (scope === 'syscore') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateSYSCOREWithDAGCORE(updateNotes);
        } 
        else if (scope === 'syscore-only') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateSYSCOREOnly(updateNotes);
        } 
        else if (scope === 'dagcore') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateDAGCOREOnly(updateNotes);
        }
      }

      // 3. Execute Action (Send to Google Apps Script)
      function executeConfirmedAction() {
        var actionToRun = pendingAction; 
        
        if (!actionToRun) {
          alert("Error: No action selected.");
          cancelAction();
          return;
        }

        // A. UI Updates (Hide menus, show spinner)
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('log-area').style.display = 'none';
        document.getElementById('log-content').innerHTML = '';

        // B. Gather Data
        var sheetName = document.getElementById('sheet-selector').value;
        var newName = document.getElementById('new-name-input').value;
        var hideCheck = document.getElementById('hide-check').checked;

        console.log("Attempting to run action: " + actionToRun);

        // C. Define Failure Handler
        function onFailure(error) {
          document.getElementById('spinner').style.display = 'none';
          document.getElementById('global-row-1').style.display = 'grid'; 
          document.getElementById('global-row-2').style.display = 'grid'; 
          document.getElementById('local-buttons').style.display = 'grid'; 
          document.querySelector('.control-group').style.display = 'block';
          document.getElementById('range-replicator-section').style.display = 'block';
          document.getElementById('range-replicator-header').style.display = 'block';
          document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'block'; });
          document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'block'; });
          pendingAction = null; 
          alert("‚ùå ERROR: " + error.message);
        }

        // D. Run the specific function using 'actionToRun' variable
        if (actionToRun === 'safeUpdate') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateSheetSafe(sheetName, hideCheck);
        } 
        else if (actionToRun === 'copy') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runCopySheet(sheetName, newName, hideCheck);
        } 
        else if (actionToRun === 'delete') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runDeleteSheet(sheetName);
        } 
        else if (actionToRun === 'config') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runUpdateSheet();
        } 
        else if (actionToRun === 'globalTabs') {
          google.script.run.withSuccessHandler(showLogs).withFailureHandler(onFailure).runCreateEmployeeTabs();
        }
        else if (actionToRun === 'createTabs') {
          google.script.run.withSuccessHandler(() => showSimpleSuccess('AM Tabs Refreshed')).withFailureHandler(onFailure).createEmployeeTabs();
        } 
        else if (actionToRun === 'deleteTabs') {
          google.script.run.withSuccessHandler(() => showSimpleSuccess('Tabs Deleted')).withFailureHandler(onFailure).deleteEmployeeTabs();
        } 
        else if (actionToRun === 'updateNotes') {
          google.script.run.withSuccessHandler(() => showSimpleSuccess('Notes Updated')).withFailureHandler(onFailure).manualUpdateNotesOnly();
        } 
        else if (actionToRun === 'totalRefresh') {
          google.script.run.withSuccessHandler(() => showSimpleSuccess('Local Refresh Complete')).withFailureHandler(onFailure).runMasterPipeline(); 
        }

        // Clear global variable after launch
        pendingAction = null;
      }

      function showLogs(logs) {
        document.getElementById('spinner').style.display = 'none';
        document.getElementById('global-row-1').style.display = 'grid'; 
        document.getElementById('global-row-2').style.display = 'grid'; 
        document.getElementById('local-buttons').style.display = 'grid'; 
        document.querySelector('.control-group').style.display = 'block';
        // Restore Range Replicator sections
        var rangeSection = document.getElementById('range-replicator-section');
        var rangeHeader = document.getElementById('range-replicator-header');
        if (rangeSection) rangeSection.style.display = 'block';
        if (rangeHeader) rangeHeader.style.display = 'block';
        document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'block'; });
        document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'block'; });
        
        var logArea = document.getElementById('log-area');
        var logContent = document.getElementById('log-content');
        logArea.style.display = 'block';

        if (!logs || logs.length === 0) {
          logContent.innerHTML = '<div style="padding:10px;">Action Complete (No logs returned).</div>';
          return;
        }

        var html = '';
        logs.forEach(function(log) {
          var colorClass = 'status-' + (log.status ? log.status.toLowerCase() : 'error');
          html += `<div class="log-entry"><span style="font-weight:500;">${log.file}</span><span class="${colorClass}">${log.status}: ${log.msg}</span></div>`;
        });
        logContent.innerHTML = html;
      }

      function showSimpleSuccess(msg) {
        showLogs([{ file: 'Local Action', status: 'Success', msg: msg }]);
      }

      // =============================================================
      // RANGE REPLICATOR FUNCTIONS
      // =============================================================
      
      let capturedRangeData = null;

      // Initialize target sheet dropdown
      google.script.run
        .withSuccessHandler(populateTargetSheetDropdown)
        .withFailureHandler(function(e) { console.error("Failed to load sheet names:", e); })
        .getAllSheetNamesForTarget();

      function populateTargetSheetDropdown(names) {
        var select = document.getElementById('target-sheet-selector');
        // Keep the first "same as source" option
        var firstOption = select.options[0];
        select.innerHTML = '';
        select.add(firstOption);
        
        if (names && names.length > 0) {
          names.forEach(function(name) {
            var option = document.createElement('option');
            option.value = name;
            option.text = name;
            select.add(option);
          });
        }
      }

      function toggleAltRange() {
        var checkbox = document.getElementById('alt-range-check');
        var input = document.getElementById('alt-range-input');
        input.style.display = checkbox.checked ? 'block' : 'none';
        if (!checkbox.checked) {
          input.value = '';
        }
      }

      // Load fleet files for test mode dropdown
      var fleetFilesLoaded = false;
      function loadFleetFiles() {
        if (fleetFilesLoaded) return;
        google.script.run
          .withSuccessHandler(function(files) {
            var select = document.getElementById('fleet-file-selector');
            select.innerHTML = '<option value="">‚Äî Select a file ‚Äî</option>';
            if (files && files.length > 0) {
              files.forEach(function(file) {
                var option = document.createElement('option');
                option.value = file.id;
                option.text = file.name;
                select.add(option);
              });
              fleetFilesLoaded = true;
            } else {
              select.innerHTML = '<option value="">No fleet files found</option>';
            }
          })
          .withFailureHandler(function(e) {
            var select = document.getElementById('fleet-file-selector');
            select.innerHTML = '<option value="">Error loading files</option>';
            console.error("Failed to load fleet files:", e);
          })
          .getFleetFileList();
      }

      function toggleTestMode() {
        var checkbox = document.getElementById('test-mode-check');
        var wrapper = document.getElementById('test-file-wrapper');
        var pushBtnText = document.getElementById('push-btn-text');
        
        if (checkbox.checked) {
          wrapper.style.display = 'block';
          pushBtnText.textContent = 'Test Push';
          loadFleetFiles(); // Load fleet files on first enable
        } else {
          wrapper.style.display = 'none';
          pushBtnText.textContent = 'Push to Fleet';
          document.getElementById('fleet-file-selector').value = '';
        }
      }

      function captureRange() {
        document.getElementById('range-display').innerHTML = '<div style="text-align:center; color:#718096;">Capturing...</div>';
        
        google.script.run
          .withSuccessHandler(function(data) {
            capturedRangeData = data;
            updateRangeDisplay(data);
          })
          .withFailureHandler(function(e) {
            document.getElementById('range-display').innerHTML = 
              '<div class="range-label" style="color:#c53030;">Capture Failed</div>' +
              '<div class="range-info">' + e.message + '</div>';
            capturedRangeData = null;
          })
          .captureSelectedRange();
      }

      function updateRangeDisplay(data) {
        var display = document.getElementById('range-display');
        display.className = 'range-display captured';
        
        var badgesHtml = '<div class="range-badges">';
        if (data.hasFormulas) badgesHtml += '<span class="badge badge-formula">Has Formulas</span>';
        if (data.hasRichText) badgesHtml += '<span class="badge badge-richtext">Has Rich Text</span>';
        badgesHtml += '</div>';
        
        var headersPreview = data.firstRowHeaders.slice(0, 5).join(', ');
        if (data.firstRowHeaders.length > 5) headersPreview += '...';
        
        display.innerHTML = 
          '<div class="range-label">Range Captured</div>' +
          '<div class="range-info">' +
            '<span>Sheet: <strong>' + data.sheetName + '</strong></span>' +
            '<span>Range: <strong>' + data.rangeA1 + '</strong></span>' +
            '<span>Size: <strong>' + data.numRows + ' √ó ' + data.numCols + '</strong></span>' +
          '</div>' +
          badgesHtml +
          '<div class="range-headers">Row 1: ' + headersPreview + '</div>';
      }

      function requestRangeAction(actionType) {
        // Validate captured data
        if (!capturedRangeData) {
          alert('‚ö†Ô∏è Please capture a range first.');
          return;
        }
        
        // Validate test mode file selection
        if (isTestMode() && !getTestFileId()) {
          alert('‚ö†Ô∏è Test Mode is enabled. Please select a target fleet file.');
          return;
        }
        
        var headerRow = document.getElementById('header-row-input').value;
        
        if (actionType === 'verify') {
          if (!headerRow) {
            alert('‚ö†Ô∏è Please enter a Header Row number to verify against.');
            return;
          }
          executeRangeVerify();
        } 
        else if (actionType === 'push') {
          if (!headerRow) {
            // Show no-header warning modal
            hideAllSections();
            document.getElementById('no-header-modal').style.display = 'block';
          } else {
            // Run verify first, then push based on results
            executeRangeVerifyThenPush();
          }
        }
      }

      function hideAllSections() {
        document.getElementById('global-row-1').style.display = 'none';
        document.getElementById('global-row-2').style.display = 'none';
        document.getElementById('local-buttons').style.display = 'none';
        document.querySelector('.control-group').style.display = 'none';
        document.getElementById('range-replicator-section').style.display = 'none';
        document.getElementById('range-replicator-header').style.display = 'none';
        document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'none'; });
        document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'none'; });
      }

      function showAllSections() {
        document.getElementById('global-row-1').style.display = 'grid';
        document.getElementById('global-row-2').style.display = 'grid';
        document.getElementById('local-buttons').style.display = 'grid';
        document.querySelector('.control-group').style.display = 'block';
        document.getElementById('range-replicator-section').style.display = 'block';
        document.getElementById('range-replicator-header').style.display = 'block';
        document.querySelectorAll('.section-divider').forEach(function(el) { el.style.display = 'block'; });
        document.querySelectorAll('h2').forEach(function(el) { el.style.display = 'block'; });
      }

      function cancelRangeAction() {
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        document.getElementById('confirm-modal').style.display = 'none';
        document.getElementById('test-success-modal').style.display = 'none';
        showAllSections();
      }

      function buildRangeConfig() {
        var targetSheet = document.getElementById('target-sheet-selector').value;
        var altRangeChecked = document.getElementById('alt-range-check').checked;
        var altRange = document.getElementById('alt-range-input').value;
        var headerRow = document.getElementById('header-row-input').value;
        var testModeChecked = document.getElementById('test-mode-check').checked;
        var selectedFileId = document.getElementById('fleet-file-selector').value;
        
        return {
          sheetName: capturedRangeData.sheetName,
          rangeA1: capturedRangeData.rangeA1,
          targetSheetName: targetSheet || capturedRangeData.sheetName,
          targetRangeA1: (altRangeChecked && altRange) ? altRange : capturedRangeData.rangeA1,
          headerRow: headerRow,
          numRows: capturedRangeData.numRows,
          numCols: capturedRangeData.numCols,
          data: capturedRangeData.data,
          firstRowHeaders: capturedRangeData.firstRowHeaders,
          testMode: testModeChecked,
          testFileId: selectedFileId
        };
      }
      
      function isTestMode() {
        return document.getElementById('test-mode-check').checked;
      }
      
      function getTestFileId() {
        return document.getElementById('fleet-file-selector').value;
      }

      function executeRangeVerify() {
        hideAllSections();
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('log-area').style.display = 'none';
        
        var config = buildRangeConfig();
        
        var successHandler = function(logs) {
          document.getElementById('spinner').style.display = 'none';
          showAllSections();
          showLogs(logs);
        };
        
        var failureHandler = function(e) {
          document.getElementById('spinner').style.display = 'none';
          showAllSections();
          alert('‚ùå Verification Error: ' + e.message);
        };
        
        // Use single-file or fleet-wide function based on test mode
        if (isTestMode()) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeadersSingleFile(config, getTestFileId());
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeaders(config);
        }
      }

      function executeRangeVerifyThenPush() {
        hideAllSections();
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('log-area').style.display = 'none';
        
        var config = buildRangeConfig();
        
        var successHandler = function(logs) {
          document.getElementById('spinner').style.display = 'none';
          
          // Check for mismatches
          var mismatches = logs.filter(function(log) {
            return log.status === 'Warning' && log.msg.includes('Mismatch');
          });
          
          if (mismatches.length > 0) {
            // Show mismatch modal
            var mismatchHtml = '';
            mismatches.forEach(function(m) {
              mismatchHtml += '<div style="padding:4px; border-bottom:1px solid #fecaca;">' +
                '<strong>' + m.file + '</strong>: ' + m.msg + '</div>';
            });
            document.getElementById('mismatch-list').innerHTML = mismatchHtml;
            document.getElementById('mismatch-modal').style.display = 'block';
          } else {
            // All good - proceed with push
            executeRangePush(false);
          }
        };
        
        var failureHandler = function(e) {
          document.getElementById('spinner').style.display = 'none';
          showAllSections();
          alert('‚ùå Verification Error: ' + e.message);
        };
        
        // Use single-file or fleet-wide function based on test mode
        if (isTestMode()) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeadersSingleFile(config, getTestFileId());
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .verifyRangeHeaders(config);
        }
      }

      // Store test file info for "Open File" functionality
      var lastTestFileId = null;
      var lastTestFileName = null;

      function executeRangePush(forceOverwrite) {
        document.getElementById('no-header-modal').style.display = 'none';
        document.getElementById('mismatch-modal').style.display = 'none';
        document.getElementById('spinner').style.display = 'block';
        document.getElementById('log-area').style.display = 'none';
        
        var config = buildRangeConfig();
        var testMode = isTestMode();
        
        // Store test file info before push
        if (testMode) {
          lastTestFileId = getTestFileId();
          var selector = document.getElementById('fleet-file-selector');
          lastTestFileName = selector.options[selector.selectedIndex].text;
        }
        
        var successHandler = function(logs) {
          document.getElementById('spinner').style.display = 'none';
          
          // Check if push was successful
          var wasSuccess = logs && logs.length > 0 && logs[0].status === 'Success';
          
          // In test mode with success, show the test success modal
          if (testMode && wasSuccess) {
            document.getElementById('test-success-filename').textContent = lastTestFileName;
            document.getElementById('test-success-modal').style.display = 'block';
            // Also show logs below
            showLogs(logs);
          } else {
            showAllSections();
            showLogs(logs);
          }
        };
        
        var failureHandler = function(e) {
          document.getElementById('spinner').style.display = 'none';
          showAllSections();
          alert('‚ùå Push Error: ' + e.message);
        };
        
        // Use single-file or fleet-wide function based on test mode
        if (testMode) {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .pushRangeToSingleFile(config, lastTestFileId, forceOverwrite);
        } else {
          google.script.run
            .withSuccessHandler(successHandler)
            .withFailureHandler(failureHandler)
            .pushRangeToFleet(config, forceOverwrite);
        }
      }

      function openTestFile() {
        if (lastTestFileId) {
          var url = 'https://docs.google.com/spreadsheets/d/' + lastTestFileId + '/edit';
          window.open(url, '_blank');
        }
        closeTestSuccessModal();
      }

      function closeTestSuccessModal() {
        document.getElementById('test-success-modal').style.display = 'none';
        showAllSections();
      }
    </script>
  </body>
</html>