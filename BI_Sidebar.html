<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    /* =========================================
       GLOBAL STYLES (COMPACT MODE)
       ========================================= */
    body { 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
      margin: 0; 
      background: #f8fafc; 
      color: #0f172a; 
      font-size: 12px; /* Adjusted for compactness */
      overflow: hidden; /* Prevent double scrollbar - tab-content handles scrolling */
    }
    
    * { box-sizing: border-box; }

    /* =========================================
       NAVIGATION TABS
       ========================================= */
    .tab-nav { 
      display: flex; 
      background: #fff; 
      border-bottom: 1px solid #e2e8f0; 
      position: sticky; 
      top: 0; 
      z-index: 100; 
    }

    .tab-btn { 
      flex: 1; 
      padding: 10px; /* Reduced padding */
      border: 0; 
      background: 0; 
      font-weight: 600; 
      color: #64748b; 
      cursor: pointer; 
      border-bottom: 3px solid transparent; 
      text-transform: uppercase; 
      font-size: 11px; 
    }

    .tab-btn:hover { background: #f1f5f9; color: #0f172a; }

    .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }

    .tab-content { 
      display: none; 
      padding: 10px; /* Reduced padding */
      height: calc(100vh - 45px); 
      overflow-y: auto; 
    }

    .tab-content.active { display: block; }

    /* =========================================
       BUCKET IQ TAB - OPENTABLE THEME
       ========================================= */
    #tab-bucket-iq {
      display: none;
      flex-direction: column;
      height: calc(100vh - 45px);
      padding: 0;
      background: #ffffff;
    }
    #tab-bucket-iq.active { display: flex; }

    /* Toast Notification */
    .kh-toast {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      background: #da3743;
      color: white;
      padding: 10px 16px;
      text-align: center;
      font-size: 12px;
      font-weight: 500;
      transform: translateY(-100%);
      transition: transform 0.3s ease;
      z-index: 100;
    }
    .kh-toast.show {
      transform: translateY(0);
    }

    /* Messages area - clean white */
    #tab-bucket-iq .kh-messages {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
      background: #ffffff;
      min-height: 0;  /* CRITICAL: allows flex item to shrink and enable scrolling */
    }

    /* Controls Container - Above Input */
    .bucket-iq-controls-container {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-bottom: 8px;
      width: 100%;
    }

    /* Floating Buttons (New Chat & Help) */
    .bucket-iq-new-chat, .bucket-iq-help {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid #d8d9db;
      color: #64748b;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .bucket-iq-new-chat:hover, .bucket-iq-help:hover {
      background: #f1f2f4;
      color: #da3743;
      border-color: #da3743;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .bucket-iq-help span {
      font-weight: 600;
      font-size: 16px;
    }

    /* Input area - modern chat style */
    .bucket-iq-input-area {
      padding: 12px 16px 20px 16px;
      border-top: 1px solid #f1f2f4;
      background: #ffffff;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      gap: 0;
    }

    /* Input Wrapper - Pill Shape */
    .bucket-iq-input-wrapper {
      flex: 1;
      background: #f1f2f4;
      border-radius: 24px;
      padding: 8px 8px 8px 16px;
      display: flex;
      align-items: center;
      transition: box-shadow 0.2s;
    }
    .bucket-iq-input-wrapper:focus-within {
      box-shadow: 0 0 0 2px rgba(218, 55, 67, 0.1);
      background: #ffffff;
      border: 1px solid #d8d9db;
    }

    .bucket-iq-input {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      min-height: 40px; /* Increased height */
      max-height: 120px;
      padding: 8px 0;
      outline: none;
      color: #2d333f;
    }
    .bucket-iq-input::placeholder {
      color: #64748b;
    }

    /* Send/Stop Buttons */
    .bucket-iq-send, .bucket-iq-stop {
      width: 36px; /* Slightly larger */
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: #da3743;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
      margin-left: 4px;
    }
    .bucket-iq-send:hover, .bucket-iq-stop:hover {
      background: #da3743;
      color: white;
      transform: scale(1.05);
    }
    .bucket-iq-send:disabled {
      color: #94a3b8;
      cursor: not-allowed;
      background: transparent;
      transform: none;
    }

    /* Assistant messages - OpenTable style */
    #tab-bucket-iq .kh-message.assistant {
      background: transparent;
      border: none;
      color: #2d333f;
      border-radius: 0;
      padding: 12px 10px;
      font-size: 13px;
      line-height: 1.5;
      width: 100%;
      max-width: 100%;
      margin-right: 0;
    }
    #tab-bucket-iq .kh-message.assistant strong { color: #da3743; }

    /* User messages - OpenTable Red */
    #tab-bucket-iq .kh-message.user {
      background: #da3743;
      color: white;
      border-radius: 18px 18px 4px 18px;
      padding: 16px 24px !important;
      font-size: 13px;
      line-height: 1.5;
      max-width: 90%; /* Keep user messages slightly constrained for distinction */
      margin-left: auto;
    }

    /* Max out width for tables and cards in chat */
    #tab-bucket-iq .kh-table, 
    #tab-bucket-iq .card {
      width: 100%;
      margin-left: 0;
      margin-right: 0;
      padding-left: 0;
      padding-right: 0;
    }

    /* Suggestion buttons - OpenTable style */
    #tab-bucket-iq .kh-suggestion {
      background: #ffffff;
      border: 1px solid #d8d9db;
      color: #2d333f;
      border-radius: 20px;
      padding: 8px 14px;
      font-size: 12px;
      transition: all 0.2s;
    }
    #tab-bucket-iq .kh-suggestion:hover {
      border-color: #da3743;
      color: #da3743;
      background: #fff0f1;
    }

    /* Action buttons - OpenTable style */
    #tab-bucket-iq .kh-action-btn.primary {
      background: #da3743;
      color: white;
      border-radius: 8px;
    }
    #tab-bucket-iq .kh-action-btn.primary:hover {
      background: #b91c2b;
    }

    /* Jump start trigger - OpenTable style */
    #tab-bucket-iq .kh-jumpstart-trigger {
      background: #da3743;
      border: none;
      border-radius: 24px;
      padding: 10px 24px;
      box-shadow: 0 4px 12px rgba(218, 55, 67, 0.25);
    }
    #tab-bucket-iq .kh-jumpstart-trigger:hover {
      background: #b91c2b;
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(218, 55, 67, 0.3);
    }

    /* Welcome section - OpenTable style */
    #tab-bucket-iq .kh-welcome {
      color: #2d333f;
    }
    #tab-bucket-iq .kh-welcome h5 {
      color: #2d333f;
      font-weight: 700;
      font-size: 16px;
    }
    #tab-bucket-iq .kh-section-label {
      color: #64748b;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    #tab-bucket-iq .kh-welcome-icon {
      color: #247f9e;
    }

    /* Help modal styles - OpenTable style */
    .help-modal {
      background: #ffffff;
      border: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.15);
      border-radius: 12px;
      max-width: 340px;
      width: calc(100% - 32px);
      max-height: calc(100vh - 100px);
      overflow: hidden;
    }
    .help-modal-header {
      background: #ffffff;
      border-bottom: 1px solid #f1f2f4;
      color: #2d333f;
      padding: 16px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }
    .help-modal-body {
      padding: 16px 20px;
      overflow-y: auto;
      max-height: calc(100vh - 200px);
    }
    .help-modal-close {
      color: #64748b;
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
    }
    .help-modal-close:hover {
      color: #da3743;
    }
    .help-section {
      margin-bottom: 20px;
    }
    .help-section:last-child {
      margin-bottom: 0;
    }
    .help-section h5 {
      color: #da3743;
      border-bottom: 1px solid #f1f2f4;
      padding-bottom: 8px;
      margin: 0 0 12px 0;
      font-size: 13px;
    }
    .help-section ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .help-section li {
      color: #2d333f;
      border-bottom: 1px solid #f1f2f4;
      padding: 8px 0;
      font-size: 12px;
      line-height: 1.4;
    }
    .help-section li:last-child {
      border-bottom: none;
    }
    .help-section li strong {
      color: #2d333f;
    }

    /* =========================================
       LAYOUT & CARDS
       ========================================= */
    .card { 
      background: #fff; 
      border: 1px solid #e2e8f0; 
      border-radius: 6px; /* Tighter radius */
      padding: 10px; /* Tighter padding */
      margin-bottom: 8px; 
      box-shadow: 0 1px 2px rgba(0,0,0,0.03); 
    }

    h3 { 
      margin: 0 0 6px 0; 
      font-size: 11px; 
      color: #64748b; 
      text-transform: uppercase; 
      border-bottom: 1px solid #f1f5f9; 
      padding-bottom: 4px; 
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    /* New Grid for Penetration stats */
    .grid-4 { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 4px; }

    /* =========================================
       METRICS & TYPOGRAPHY
       ========================================= */
    .lbl { 
      font-size: 10px; 
      color: #64748b; 
      text-transform: uppercase; 
      font-weight: 700; 
      margin-bottom: 2px; 
    }

    .val { font-size: 15px; font-weight: 700; color: #1e293b; }
    .sub { font-size: 10px; color: #64748b; }

    .txt-red { color: #ef4444; }
    .txt-grn { color: #166534; }
    .txt-blue { color: #2563eb; }

    /* =========================================
       TABLES
       ========================================= */
    .mini-table { width: 100%; border-collapse: collapse; font-size: 11px; }
    .mini-table td { padding: 2px 0; border-bottom: 1px dashed #f1f5f9; }
    .mini-table td:last-child { text-align: right; font-weight: 600; }

    /* =========================================
       FORMS & BUTTONS
       ========================================= */
    select, input { 
      width: 100%; 
      padding: 6px; /* Compact inputs */
      border: 1px solid #cbd5e1; 
      border-radius: 4px; 
      font-size: 12px; 
      margin-bottom: 8px; 
      background: #fff; 
    }
    
    .btn { 
      width: 100%; 
      padding: 8px; /* Compact buttons */
      border-radius: 4px; 
      border: 0; 
      cursor: pointer; 
      font-weight: 600; 
      margin-top: 4px; 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 6px; 
      font-size: 12px;
    }

    .btn-primary { background: #2563eb; color: #fff; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
    .btn-sec { background: #e2e8f0; color: #334155; }

    /* =========================================
       COMPONENTS
       ========================================= */
    #acc-detail { 
      display: none; 
      background: #f1f5f9; 
      padding: 8px; 
      border-radius: 4px; 
      margin-bottom: 8px; 
      border: 1px solid #e2e8f0; 
    }

    .detail-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 3px; }
    .detail-row span:last-child { font-weight: 600; color: #334155; }

    .overlay-view { 
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
      background: #fff; z-index: 2000; padding: 20px; 
      padding-bottom: 350px; /* Leave room for chat panel */
      display: none; flex-direction: column; 
    }
    .overlay-view.active { display: flex; }

    .data-preview { 
      background: #f8fafc; border: 1px solid #cbd5e1; padding: 10px; 
      border-radius: 6px; font-family: monospace; font-size: 11px; 
      white-space: pre-wrap; flex-grow: 1; overflow-y: auto; margin-top: 10px; 
    }

    .spinner { 
      border: 3px solid #f3f3f3; border-top: 3px solid #2563eb; 
      border-radius: 50%; width: 20px; height: 20px; 
      animation: spin 1s linear infinite; margin: 0 auto; 
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

    #sim-results { border-left: 4px solid #ccc; }

    /* =========================================
       KNOWLEDGE HUB - CHAT STYLES
       ========================================= */
    .kh-messages {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #f8fafc;
    }

    .kh-message {
      max-width: 92%;
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      line-height: 1.5;
    }
    .kh-message.user {
      align-self: flex-end;
      background: #2563eb;
      color: white;
      border-bottom-right-radius: 4px;
    }
    .kh-message.assistant {
      align-self: flex-start;
      background: #fff;
      color: #0f172a;
      border: 1px solid #e2e8f0;
      border-bottom-left-radius: 4px;
    }
    .kh-message.assistant strong { color: #2563eb; }
    .kh-message.assistant code {
      background: #f1f5f9;
      padding: 1px 4px;
      border-radius: 3px;
      font-size: 11px;
    }
    
    /* Markdown tables in chat */
    .kh-table {
      width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 11px;
      table-layout: auto;
    }
    .kh-table th,
    .kh-table td {
      border: 1px solid #e2e8f0;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
    }
    .kh-table th {
      background: #f8fafc;
      font-weight: 600;
      color: #374151;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .kh-table td {
      background: #fff;
      color: #1f2937;
    }
    .kh-table tr:nth-child(even) td {
      background: #f9fafb;
    }
    .kh-table tr:hover td {
      background: #f0f9ff;
    }
    
    /* Markdown headers in chat */
    .kh-header {
      font-weight: 600;
      color: #1e293b;
      margin: 12px 0 6px 0;
      line-height: 1.3;
    }
    .kh-header:first-child {
      margin-top: 0;
    }
    .kh-h1 { font-size: 16px; }
    .kh-h2 { font-size: 14px; }
    .kh-h3 { font-size: 13px; color: #334155; }
    
    /* Markdown dividers in chat */
    .kh-divider {
      border: none;
      border-top: 1px solid #e2e8f0;
      margin: 12px 0;
    }
    
    .kh-message.error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    .kh-message.loading {
      background: #fff;
      border: 1px solid #e2e8f0;
    }

    /* Data source indicator - shows which AM's data was loaded */
    .kh-data-indicator {
      font-size: 10px;
      color: #64748b;
      background: #f1f5f9;
      padding: 3px 8px;
      border-radius: 4px;
      margin-bottom: 8px;
      display: inline-block;
      border-left: 2px solid #22c55e;
    }

    .kh-loading-dots {
      display: flex;
      gap: 4px;
    }
    .kh-loading-dots span {
      width: 6px;
      height: 6px;
      background: #94a3b8;
      border-radius: 50%;
      animation: khBounce 1.4s infinite ease-in-out both;
    }
    .kh-loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .kh-loading-dots span:nth-child(2) { animation-delay: -0.16s; }
    @keyframes khBounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    .kh-welcome {
      text-align: center;
      color: #64748b;
      padding: 24px 12px;
    }
    .kh-welcome-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    .kh-welcome h5 {
      margin: 0 0 6px 0;
      color: #0f172a;
      font-size: 13px;
    }
    .kh-welcome p {
      margin: 0;
      font-size: 11px;
    }

    .kh-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
      justify-content: center;
    }
    .kh-suggestion {
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 6px 10px;
      border-radius: 14px;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      color: #334155;
    }
    .kh-suggestion:hover {
      border-color: #2563eb;
      color: #2563eb;
    }
    
    .kh-section-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin: 16px 0 8px 0;
    }
    .kh-section-label:first-of-type {
      margin-top: 12px;
    }
    
    .kh-top-prompt {
      font-weight: 700;
    }

    /* Action Buttons (for column actions) */
    .kh-action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #e2e8f0;
    }
    .kh-action-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s;
    }
    .kh-action-btn.primary {
      background: #2563eb;
      color: white;
    }
    .kh-action-btn.primary:hover {
      background: #1d4ed8;
    }
    .kh-action-btn.secondary {
      background: #f1f5f9;
      color: #475569;
      border: 1px solid #e2e8f0;
    }
    .kh-action-btn.secondary:hover {
      background: #e2e8f0;
    }
    .kh-action-btn.slack {
      background: #4a154b;
      color: white;
      border: none;
    }
    .kh-action-btn.slack:hover {
      background: #611f69;
    }
    .kh-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Feedback UI */
    .kh-feedback {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
      padding-top: 6px;
      border-top: 1px solid #f1f5f9;
    }
    .kh-feedback-label {
      font-size: 9px;
      color: #94a3b8;
      margin-right: 4px;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    .kh-feedback-btn {
      background: none;
      border: 1px solid #e2e8f0;
      padding: 2px 6px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 10px;
      color: #64748b;
      display: flex;
      align-items: center;
      gap: 2px;
      transition: all 0.2s;
    }
    .kh-feedback-btn:hover {
      border-color: #94a3b8;
      color: #334155;
    }
    .kh-feedback-btn.active-helpful {
      border-color: #22c55e;
      background: #f0fdf4;
      color: #16a34a;
    }
    .kh-feedback-btn.active-not-helpful {
      border-color: #ef4444;
      background: #fef2f2;
      color: #dc2626;
    }
    .kh-feedback-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .kh-feedback-text {
      font-size: 9px;
      color: #94a3b8;
      margin-left: auto;
    }

    /* Correction Modal */
    .kh-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2200; /* Above chat panel (2100) */
      display: none;
      align-items: center;
      justify-content: center;
    }
    .kh-modal-overlay.open { display: flex; }
    .kh-modal {
      background: #fff;
      border-radius: 12px;
      width: calc(100% - 32px);
      max-width: 360px;
      max-height: calc(100vh - 100px);
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .kh-modal-header {
      padding: 14px 16px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      font-weight: 600;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .kh-modal-close {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: #64748b;
      padding: 0;
      line-height: 1;
    }
    .kh-modal-body {
      padding: 16px;
    }
    .kh-modal-label {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 6px;
      display: block;
    }
    .kh-modal-preview {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 10px;
      font-size: 11px;
      color: #334155;
      max-height: 80px;
      overflow-y: auto;
      margin-bottom: 12px;
    }
    .kh-modal-textarea {
      width: 100%;
      min-height: 100px;
      padding: 10px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 12px;
      resize: vertical;
      margin-bottom: 12px;
    }
    .kh-modal-textarea:focus {
      outline: none;
      border-color: #2563eb;
    }
    .kh-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .kh-modal-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }
    .kh-modal-btn-cancel {
      background: #e2e8f0;
      color: #334155;
    }
    .kh-modal-btn-submit {
      background: #2563eb;
      color: #fff;
    }
    .kh-modal-btn-submit:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    /* AM Selection List */
    .kh-am-selection {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 8px;
      padding: 10px;
      background: #f8fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    .kh-am-selection button {
      font-size: 11px;
      padding: 6px 10px;
    }

    /* =========================================
       DAILY JUMP START
       ========================================= */
    .kh-jumpstart {
      margin: 12px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #fff;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .kh-jumpstart-header {
      padding: 10px 12px;
      background: #f8fafc;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .kh-jumpstart-title {
      font-size: 11px;
      font-weight: 700;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .kh-jumpstart-refresh {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      color: #94a3b8;
      padding: 4px;
      border-radius: 4px;
      transition: all 0.2s;
    }
    .kh-jumpstart-refresh:hover {
      background: #e2e8f0;
      color: #475569;
    }

    /* Section Box */
    .kh-jumpstart-section {
      border-bottom: 1px solid #f1f5f9;
    }
    .kh-jumpstart-section:last-child {
      border-bottom: none;
    }
    
    .kh-jumpstart-section-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      cursor: pointer;
      transition: background 0.2s;
      font-size: 12px;
      color: #334155;
    }
    .kh-jumpstart-section-header:hover {
      background: #f8fafc;
    }
    
    .kh-jumpstart-chevron {
      font-size: 10px;
      color: #94a3b8;
      margin-right: 8px;
      transition: transform 0.2s;
      width: 12px;
      text-align: center;
    }
    .kh-jumpstart-section.expanded .kh-jumpstart-chevron {
      transform: rotate(90deg);
    }
    
    .kh-jumpstart-dot {
      font-size: 8px;
      margin-right: 8px;
    }
    
    .kh-jumpstart-name {
      flex: 1;
      font-weight: 500;
    }
    
    .kh-jumpstart-badge {
      background: #f1f5f9;
      color: #64748b;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }
    .kh-jumpstart-badge.urgent {
      background: #fee2e2;
      color: #ef4444;
    }
    
    /* Section Content */
    .kh-jumpstart-content {
      display: none;
      padding: 0 12px 12px 12px;
      background: #fff;
    }
    .kh-jumpstart-section.expanded .kh-jumpstart-content {
      display: block;
    }
    
    /* Account List - scrollable when many accounts */
    .kh-jumpstart-list {
      margin-bottom: 10px;
      max-height: 200px;
      overflow-y: auto;
    }
    /* Styled scrollbar for Jump Start list */
    .kh-jumpstart-list::-webkit-scrollbar {
      width: 4px;
    }
    .kh-jumpstart-list::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 2px;
    }
    .kh-jumpstart-list::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 2px;
    }
    .kh-jumpstart-list::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .kh-jumpstart-row {
      display: flex;
      align-items: center;
      padding: 4px 0;
      font-size: 11px;
      color: #475569;
      border-bottom: 1px dashed #f1f5f9;
    }
    .kh-jumpstart-row:last-child {
      border-bottom: none;
    }
    
    .kh-jumpstart-emoji {
      font-size: 10px;
      width: 14px;
      margin-right: 4px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .kh-jumpstart-acc-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      padding: 2px 4px;
      border-radius: 3px;
      transition: background 0.15s;
    }
    .kh-jumpstart-acc-name:hover {
      background: #f1f5f9;
    }
    
    /* Days Label (for contract expiring and no engagement) */
    .kh-days-label {
      font-size: 9px;
      font-weight: 600;
      margin-left: 4px;
      padding: 1px 4px;
      border-radius: 3px;
      background: #f1f5f9;
      flex-shrink: 0;
    }
    .days-green { color: #16a34a; background: #dcfce7; }
    .days-orange { color: #ea580c; background: #ffedd5; }
    .days-red { color: #dc2626; background: #fee2e2; }
    
    /* Emoji Tags (inline with hover labels) */
    .kh-emoji-tag {
      cursor: help;
      font-size: 10px;
      margin-right: 1px;
    }
    
    /* Custom Tooltip (single tooltip at a time) */
    .kh-custom-tooltip {
      position: fixed;
      background: #1e293b;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      font-size: 11px;
      max-width: 250px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.15s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      line-height: 1.4;
    }
    .kh-custom-tooltip.visible { 
      opacity: 1; 
    }
    
    /* Clickable Account Names in Chat (click to copy RID) */
    .kh-clickable-account {
      cursor: pointer;
      text-decoration: underline dotted;
      text-decoration-color: #94a3b8;
      text-underline-offset: 2px;
      color: inherit;
      border-radius: 2px;
      transition: background 0.15s;
    }
    .kh-clickable-account:hover {
      background: #f1f5f9;
      text-decoration-color: #64748b;
    }

    /* Action Buttons */
    .kh-jumpstart-actions {
      display: flex;
      gap: 6px;
      margin-top: 8px;
    }
    
    .kh-jumpstart-btn {
      flex: 1;
      padding: 6px;
      border-radius: 4px;
      border: 1px solid #e2e8f0;
      background: #fff;
      color: #475569;
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s;
    }
    .kh-jumpstart-btn:hover {
      background: #f8fafc;
      border-color: #cbd5e1;
      color: #334155;
    }
    
    .kh-jumpstart-btn.primary {
      background: #eff6ff;
      border-color: #bfdbfe;
      color: #2563eb;
    }
    .kh-jumpstart-btn.primary:hover {
      background: #dbeafe;
      border-color: #93c5fd;
    }

    /* Start My Day Button */
    .kh-jumpstart-trigger {
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .kh-jumpstart-trigger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(37, 99, 235, 0.3);
    }
    
    .kh-jumpstart-empty {
      padding: 12px;
      text-align: center;
      color: #64748b;
      font-size: 11px;
      font-style: italic;
      background: #f8fafc;
      border-radius: 4px;
      margin: 0 12px 12px 12px;
    }
    
    /* Loading state */
    .kh-jumpstart-loading {
      padding: 24px 16px;
      text-align: center;
    }
    
    .kh-jumpstart-loading-text {
      margin-top: 12px;
      font-size: 11px;
      color: #64748b;
    }
    
    /* Error state */
    .kh-jumpstart-error {
      padding: 20px 16px;
      text-align: center;
    }
    
    .kh-jumpstart-error-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }
    
    .kh-jumpstart-error-text {
      font-size: 13px;
      font-weight: 500;
      color: #1e293b;
      margin-bottom: 4px;
    }
    
    .kh-jumpstart-error-detail {
      font-size: 11px;
      color: #64748b;
      margin-bottom: 12px;
    }
    
    /* All clear state */
    .kh-jumpstart-all-clear {
      padding: 24px 16px;
      text-align: center;
      background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
      border-radius: 6px;
      margin: 8px;
    }
    
    .kh-jumpstart-all-clear-icon {
      font-size: 28px;
      margin-bottom: 8px;
    }
    
    .kh-jumpstart-all-clear-text {
      font-size: 14px;
      font-weight: 600;
      color: #059669;
      margin-bottom: 4px;
    }
    
    .kh-jumpstart-all-clear-subtext {
      font-size: 11px;
      color: #10b981;
    }
    
    /* Empty section styling */
    .kh-jumpstart-section.empty .kh-jumpstart-section-header {
      cursor: default;
      opacity: 0.7;
    }
    
    .kh-jumpstart-section.empty .kh-jumpstart-section-header:hover {
      background: transparent;
    }
    
    .kh-jumpstart-chevron.hidden {
      visibility: hidden;
    }
    
    /* Show All button for large sections */
    .kh-jumpstart-show-all {
      padding: 8px 12px;
      display: none;  /* Hidden when expanded */
    }
    
    .kh-jumpstart-section:not(.expanded) .kh-jumpstart-show-all {
      display: block;  /* Shown when collapsed */
    }
    
    .kh-jumpstart-section:not(.expanded) .kh-jumpstart-list,
    .kh-jumpstart-section:not(.expanded) .kh-jumpstart-actions {
      display: none;  /* Hide list and buttons when collapsed */
    }
    
    .kh-jumpstart-show-all-btn {
      width: 100%;
      padding: 8px 12px;
      background: #f1f5f9;
      border: 1px dashed #cbd5e1;
      border-radius: 4px;
      color: #475569;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .kh-jumpstart-show-all-btn:hover {
      background: #e2e8f0;
      border-color: #94a3b8;
      color: #1e293b;
    }
    
    /* Copied state for Glean button */
    .kh-jumpstart-btn.copied {
      background: #059669 !important;
      color: white !important;
      border-color: #059669 !important;
    }
    
    /* Disabled state for buttons */
    .kh-jumpstart-trigger:disabled,
    .kh-jumpstart-refresh:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
  </style>
</head>
<body>

  <div class="tab-nav">
    <button class="tab-btn active" data-tab="tab-bucket-iq">BUCKET IQ</button>
    <button class="tab-btn" data-tab="tab-prep">MEETING PREP</button>
    <button class="tab-btn" data-tab="tab-calc">SIMULATOR</button>
  </div>

  <!-- Bucket iQ Tab - AI Chat Interface -->
  <div id="tab-bucket-iq" class="tab-content active">
    <!-- Toast Notification -->
    <div class="kh-toast" id="khToast">RID copied to clipboard</div>
    <!-- Messages Area -->
    <div class="kh-messages" id="khMessages">
      <!-- Daily Jump Start Accordion -->
      <div class="kh-jumpstart" id="khJumpStart" style="display:none;">
        <div class="kh-jumpstart-header">
          <div class="kh-jumpstart-title">
            <span>üåÖ</span> DAILY JUMP START
          </div>
          <button class="kh-jumpstart-refresh" onclick="startMyDay()" title="Refresh">
            üîÑ
          </button>
        </div>
        <div id="khJumpStartContent">
          <!-- Sections will be injected here -->
        </div>
      </div>

      <div class="kh-welcome" id="khWelcome">
        <div class="kh-welcome-icon">‚ú¶</div>
        <h5>Let's Get Down To Buckets</h5>
        <p>Features, Metrics, Nasty Saves, Support, I've GOT YOUR BACK!</p>
        
        <button class="kh-jumpstart-trigger" onclick="startMyDay()">
          <span>üåÖ</span> Start My Day
        </button>
        <div class="kh-section-label">InTouch Help</div>
        <div class="kh-suggestions">
          <button class="kh-suggestion kh-top-prompt">What can you do?</button>
          <button class="kh-suggestion">How does iQ scoring work?</button>
          <button class="kh-suggestion">Help me build my Focus20 list</button>
          <button class="kh-suggestion">Sheet looks broken</button>
          <button class="kh-suggestion">What should I look at first?</button>
        </div>
        <div class="kh-section-label">Account Analysis</div>
        <div class="kh-suggestions">
          <button class="kh-suggestion">Summarize my bucket</button>
          <button class="kh-suggestion">Flag accounts I haven't touched in 60+ days</button>
          <button class="kh-suggestion">Who is up for renewal soon?</button>
          <button class="kh-suggestion">Show my Icons and Elites</button>
          <button class="kh-suggestion">Which accounts should I pitch PI to?</button>
          <button class="kh-suggestion">How do I rank against the team?</button>
        </div>
      </div>
    </div>
    
    <!-- Input Area (Bottom, Pinned) -->
    <div class="bucket-iq-input-area">
      <!-- Controls Container (New Chat & Help) -->
      <div class="bucket-iq-controls-container">
        <button class="bucket-iq-new-chat" id="khClear" onmouseenter="showCustomTooltip(this, 'Start new chat')" onmouseleave="hideCustomTooltip()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
        </button>
        <button class="bucket-iq-help" id="helpBtn" title="Help & Guide">
          <span>?</span>
        </button>
      </div>
      <!-- Input Wrapper (Pill shape) -->
      <div class="bucket-iq-input-wrapper">
        <textarea class="bucket-iq-input" id="khInput" placeholder="Ask InTouch..." rows="1"></textarea>
        
        <!-- Send Button (Icon, Right aligned in wrapper) -->
        <button class="bucket-iq-send" id="khSend" title="Send">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
          </svg>
        </button>
        
        <!-- Stop Button (Icon, replaces Send when loading) -->
        <button class="bucket-iq-stop" id="khStop" title="Stop Generation" style="display:none;">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
            <rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <div id="tab-prep" class="tab-content">
     <div class="card">
        <h3>Partner Triage</h3>
        <label class="lbl">Select Account</label>
        <input type="text" id="account-input" list="account-list" placeholder="Loading..." oninput="checkAccount()" onfocus="this.select()" disabled>
        <datalist id="account-list"></datalist>
        <div id="acc-detail"></div>
        <button class="btn btn-primary" id="btn-ai" onclick="runAI()" disabled>‚ú® Launch AI Brief</button>
        <button class="btn btn-sec" onclick="runDeck()">üìÑ Create Presentation</button>
     </div>
  </div>

  <div id="tab-calc" class="tab-content">
    <div class="card">
      <h3>Simulation Scope</h3>
      <div class="grid-2" style="margin-bottom:10px;">
        <button class="btn btn-primary" id="scope-ind" onclick="setScope('INDIVIDUAL')">Individual</button>
        <button class="btn btn-sec" id="scope-grp" onclick="setScope('GROUP')">Group</button>
      </div>

      <div id="selector-ind">
        <label class="lbl">Select Account</label>
        <input type="text" id="calc-acc-input" list="account-list" placeholder="Search Account..." onchange="onCalcAccountSelect()" onfocus="this.select()">
      </div>

      <div id="selector-grp" style="display:none;">
        <label class="lbl">Select Group</label>
        <select id="calc-grp-select" onchange="onCalcGroupSelect()">
          <option value="" disabled selected>Loading Groups...</option>
        </select>
      </div>
    </div>

    <div class="card">
      <h3>Configuration</h3>
      <label class="lbl">System Type</label>
      <select id="sim-system" onchange="updateSystemDefaults()">
        <option value="CORE" selected>Core ($299)</option>
        <option value="PRO">Pro ($499)</option>
      </select>

      <label class="lbl">Pricing Model</label>
      <select id="sim-model" onchange="updateSimInputs()">
        <option value="FREEMIUM">Free Direct Plan (Freemium)</option>
        <option value="FREE_GOOGLE">Free Google Plan</option>
        <option value="AYCE">AYCE</option>
      </select>

      <div class="grid-2">
        <div id="input-sub">
          <label class="lbl">Sub Fee ($)</label>
          <input type="number" id="sim-sub" value="299">
        </div>
        <div id="input-disco">
          <label class="lbl">Disco Price ($)</label>
          <input type="number" id="sim-rate" value="1.50" step="0.05">
        </div>
      </div>

      <button class="btn btn-primary" onclick="runSimulation()">üé≤ Run Simulation</button>
    </div>

    <div id="sim-results" class="card" style="display:none;">
      <h3>Results Breakdown</h3>
      <div id="sim-table-container"></div>
    </div>
  </div>

  <div id="overlay-loading" class="overlay-view" style="align-items:center; text-align:center;">
     <div id="loader-spacer" style="height:0px; transition: height 0.3s;"></div>
     <div class="spinner"></div>
     <div id="loader-text" class="lbl" style="margin-top:15px; font-size:14px; color:#64748b;">Preparing Data for Brief...</div>
     
     <button id="btn-cancel" class="btn" onclick="cancelProcess()" 
             style="display:none; margin-top:15px; background:#fee2e2; color:#991b1b; border:1px solid #fca5a5; width:auto; padding:6px 20px; font-size:11px;">
        Stop Script
     </button>

     <div id="loader-upsell" style="display:none; margin-top:30px; background:#eff6ff; padding:20px; border-radius:12px; border:1px solid #bfdbfe; width:90%; max-width:280px; animation: fadeIn 0.5s;">
         <p style="margin:0 0 15px 0; color:#1e40af; font-size:13px; line-height:1.5; font-weight:500;">
            Why sit here and twiddle your thumbs?<br>
            <span style="font-weight:400; color:#3b82f6;">Dig into the account with InTouch AI on Gemini!</span>
         </p>
         <button class="btn btn-primary" onclick="runAI()" style="background:#2563eb; border-radius:20px; box-shadow:0 2px 4px rgba(37,99,235,0.2);">
            ‚ú® Launch AI Brief
         </button>
         <p style="margin:12px 0 0 0; color:#64748b; font-size:11px; font-style:italic; line-height:1.4;">
            Presentation is generating in the background and will open automatically when ready.
         </p>
     </div>
  </div>

  <div id="overlay-results" class="overlay-view">
     <h2 style="margin:0 0 10px 0; color:#2563eb;">‚ú® Brief Ready!</h2>
     <div id="copy-status" style="display:none; padding:10px; border-radius:6px; font-weight:600; margin-bottom:15px;"></div>
     <button class="btn btn-primary" onclick="launchGeminiAndCopy()">üöÄ Copy Data & Open Gemini</button>
     <button class="btn btn-sec" onclick="closeOverlay()">Back</button>
     <div id="ai-preview" class="data-preview"></div>
  </div>

  <script>
    // --- GLOBAL VARIABLES ---
    let ACCOUNT_MAP = {}; 
    let ACCOUNT_NAME_TO_RID = {};  // Lookup for click-to-copy RID in chat
    let CURRENT_SCOPE = 'INDIVIDUAL'; 
    let CURRENT_BASELINE_REV = 0; 
    let isAICancelled = false; 
    let activeTooltipEl = null;  // Track active tooltip element

    // --- CUSTOM TOOLTIP SYSTEM (only one visible at a time) ---
    function showCustomTooltip(el, text) {
      const tooltip = document.getElementById('khCustomTooltip');
      if (!tooltip || !text) return;
      
      // Close any existing tooltip
      if (activeTooltipEl) {
        hideCustomTooltip();
      }
      
      const rect = el.getBoundingClientRect();
      tooltip.textContent = text;
      
      // Position tooltip below the element
      tooltip.style.left = Math.max(4, rect.left) + 'px';
      tooltip.style.top = (rect.bottom + 4) + 'px';
      
      // Ensure tooltip doesn't overflow right edge
      tooltip.style.maxWidth = Math.min(250, window.innerWidth - rect.left - 8) + 'px';
      
      tooltip.classList.add('visible');
      activeTooltipEl = el;
    }
    
    function hideCustomTooltip() {
      const tooltip = document.getElementById('khCustomTooltip');
      if (tooltip) {
        tooltip.classList.remove('visible');
      }
      activeTooltipEl = null;
    }
    
    // Close tooltip when clicking anywhere else
    document.addEventListener('click', function(e) {
      if (activeTooltipEl && !e.target.closest('.kh-custom-tooltip') && e.target !== activeTooltipEl) {
        hideCustomTooltip();
      }
    });

    // --- INITIALIZATION ---
    window.onload = function() {
      setupTabs();
      setLoadingState(true);
      google.script.run
        .withSuccessHandler(populateSidebarData)
        .withFailureHandler(handleError)
        .getSidebarData();
    };

    function setLoadingState(isLoading) {
      const amPicker = document.getElementById('am-picker');
      const accountInput = document.getElementById('account-input');

      if (isLoading) {
        if (amPicker) {
          amPicker.innerHTML = '<option value="" disabled selected>Loading AMs...</option>';
          amPicker.disabled = true;
          amPicker.style.backgroundColor = "#f3f4f6";
        }

        if (accountInput) {
          accountInput.value = '';
          accountInput.placeholder = "Loading Accounts...";
          accountInput.disabled = true;
          accountInput.style.backgroundColor = "#f3f4f6";
        }
      } else {
        if (amPicker) {
          amPicker.disabled = false;
          amPicker.style.backgroundColor = "white";
        }
        if (accountInput) {
          accountInput.placeholder = "Search Accounts...";
          accountInput.disabled = false;
          accountInput.style.backgroundColor = "white";
        }
      }
    }

    function populateSidebarData(data) {
      if (!data) return;

      const amPicker = document.getElementById('am-picker');
      if (amPicker) {
        let amHtml = '<option value="" disabled selected>Select AM</option>';
        if (data.ams && data.ams.length > 0) {
          data.ams.forEach(am => { amHtml += `<option value="${am}">${am}</option>`; });
        }
        amPicker.innerHTML = amHtml;
      }

      const dataList = document.getElementById('account-list');
      if (dataList) {
        let accHtml = '';
        ACCOUNT_MAP = {}; 
        ACCOUNT_NAME_TO_RID = {};  // Reset lookup
  
        if (data.accounts && data.accounts.length > 0) {
          data.accounts.forEach(acc => {
            const displayVal = `${acc.name} (${acc.rid})`;
            ACCOUNT_MAP[displayVal] = acc;
            // Build name -> RID lookup for chat click-to-copy
            if (acc.name && acc.rid) {
              ACCOUNT_NAME_TO_RID[acc.name] = acc.rid;
            }
            accHtml += `<option value="${displayVal}">`;
          });
        }
        dataList.innerHTML = accHtml;
      }
      setLoadingState(false);
    }

    function handleError(err) {
      console.error(err);
      alert("Failed to load sidebar data: " + err.message);
    }

    // --- TAB LOGIC: PARTNER TRIAGE ---
    function checkAccount() {
      const val = document.getElementById('account-input').value;
      const detailBox = document.getElementById('acc-detail');
      const btnAI = document.getElementById('btn-ai');
      
      const record = ACCOUNT_MAP[val];
      
      // üîç DEBUG: Log what we found
      console.log("[checkAccount] Input value:", val);
      console.log("[checkAccount] Record found:", record);
      
      if (record) {
         btnAI.disabled = false;
         detailBox.style.display = 'block';
         
         // Show warning styling if metro/macro are empty
         const metroClass = record.metro ? '' : 'style="color:#ef4444;"';
         const macroClass = record.macro ? '' : 'style="color:#ef4444;"';
         
         detailBox.innerHTML = `
            <div class="detail-row"><span>RID:</span><span>${record.rid}</span></div>
            <div class="detail-row"><span>Metro:</span><span ${metroClass}>${record.metro || '‚ö†Ô∏è EMPTY'}</span></div>
            <div class="detail-row"><span>Macro:</span><span ${macroClass}>${record.macro || '‚ö†Ô∏è EMPTY'}</span></div>
         `;
      } else {
         btnAI.disabled = true;
         detailBox.style.display = 'none';
      }
    }

    // --- OVERLAY & ACTIONS ---

    function setLoadingMode(mode) {
       const overlay = document.getElementById('overlay-loading');
       const upsell = document.getElementById('loader-upsell');
       const text = document.getElementById('loader-text');
       const spacer = document.getElementById('loader-spacer');
       const cancelBtn = document.getElementById('btn-cancel'); 

       overlay.classList.add('active');
       isAICancelled = false; 

       if (mode === 'deck') {
          overlay.style.justifyContent = 'flex-start'; 
          spacer.style.height = '15vh'; 
          text.innerText = "Generating Presentation...";
          upsell.style.display = 'block';
          cancelBtn.style.display = 'none'; 
       } else {
          overlay.style.justifyContent = 'center';
          spacer.style.height = '0px';
          text.innerText = "Preparing Data for Brief..."; 
          upsell.style.display = 'none';
          cancelBtn.style.display = 'inline-flex'; 
       }
    }

    function cancelProcess() {
       isAICancelled = true;
       document.getElementById('overlay-loading').classList.remove('active');
       document.getElementById('account-input').focus();
    }

    function runDeck() {
       const val = document.getElementById('account-input').value;
       const record = ACCOUNT_MAP[val];
       if(!record) return alert("Please select a valid account.");

       // üîç DEBUG: Log what we're sending
       console.log("[runDeck] Sending config:", {
          accountName: record.name,
          rid: record.rid,
          metro: record.metro,
          macro: record.macro,
          neighborhood: record.neighborhood
       });

       setLoadingMode('deck');
       
       google.script.run
          .withSuccessHandler(res => {
             document.getElementById('overlay-loading').classList.remove('active');
             if(res && res.newSheetsUrl) window.open(res.newSheetsUrl);
          })
          .withFailureHandler(err => {
             document.getElementById('overlay-loading').classList.remove('active');
             console.error("[runDeck] Server error:", err);
             alert("Failed to create deck: " + err.message);
          })
          .createBizInsightsDeck({
             accountName: record.name,
             rid: record.rid,
             metro: record.metro,
             macro: record.macro,
             neighborhood: record.neighborhood || record.macro
          });
    }

    function runAI() {
       const val = document.getElementById('account-input').value;
       const record = ACCOUNT_MAP[val];
       if(!record) return alert("Please select a valid account.");
       
       setLoadingMode('simple');
       
       google.script.run.withSuccessHandler(res => {
          if (isAICancelled) return; 
          
          document.getElementById('overlay-loading').classList.remove('active');
          document.getElementById('ai-preview').innerText = res;
          document.getElementById('copy-status').style.display = 'none';
          document.getElementById('overlay-results').classList.add('active');
       }).buildPromptForRID(record.rid);
    }

    function launchGeminiAndCopy() {
       const text = document.getElementById('ai-preview').innerText;
       const url = 'https://gemini.google.com/gem/55125c85f8bf';
       
       const syncSuccess = copyToClipboardSync(text);

       if (syncSuccess) {
           updateStatus(true);
           window.open(url, '_blank'); 
       } else {
           if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(() => {
                 updateStatus(true);
                 setTimeout(() => window.open(url, '_blank'), 250);
              }).catch(err => {
                 console.error(err);
                 updateStatus(false);
                 alert("Copy failed. Please manually copy the text below.");
              });
           } else {
              updateStatus(false);
              alert("Clipboard not supported. Please copy manually.");
           }
       }
    }

    function copyToClipboardSync(text) {
       try {
          const t = document.createElement("textarea");
          t.value = text;
          t.style.position = "fixed"; 
          t.style.left = "-9999px";
          document.body.appendChild(t);
          t.select();
          const result = document.execCommand("copy"); 
          document.body.removeChild(t);
          return result;
       } catch (err) {
          return false;
       }
    }

    function updateStatus(isSuccess) {
       const statusDiv = document.getElementById('copy-status');
       statusDiv.style.display = 'block';
       if (isSuccess) {
          statusDiv.innerText = "‚úÖ Data copied! Launching Gemini...";
          statusDiv.style.background = "#dcfce7"; 
          statusDiv.style.color = "#166534";
       } else {
          statusDiv.innerText = "‚ö†Ô∏è Copy failed.";
          statusDiv.style.background = "#fee2e2"; 
          statusDiv.style.color = "#991b1b";
       }
    }

    function setupTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });
    }

    function closeOverlay() { 
      document.querySelectorAll('.overlay-view').forEach(e => e.classList.remove('active')); 
    }

    // =========================================================
    // --- SIMULATOR FUNCTIONS (TAB 3 - RESTORED) ---
    // =========================================================

    function updateSystemDefaults() {
      const sys = document.getElementById('sim-system').value;
      const subInput = document.getElementById('sim-sub');
      
      // Only reset defaults if NOT in AYCE mode
      if (document.getElementById('sim-model').value !== 'AYCE') {
          if (sys === 'PRO') { subInput.value = 499; } else { subInput.value = 299; }
      }
      resetSimResults();
    }

    function setScope(scope) {
      CURRENT_SCOPE = scope;
      
      // Toggle Buttons
      document.getElementById('scope-ind').className = scope === 'INDIVIDUAL' ? 'btn btn-primary' : 'btn btn-sec';
      document.getElementById('scope-grp').className = scope === 'GROUP' ? 'btn btn-primary' : 'btn btn-sec';
      
      // Toggle Dropdowns
      document.getElementById('selector-ind').style.display = scope === 'INDIVIDUAL' ? 'block' : 'none';
      document.getElementById('selector-grp').style.display = scope === 'GROUP' ? 'block' : 'none';
      
      resetSimResults();
      
      // Lazy Load Groups
      if (scope === 'GROUP' && document.getElementById('calc-grp-select').options.length <= 1) {
        loadGroups();
      }
    }

    function loadGroups() {
      const sel = document.getElementById('calc-grp-select');
      sel.innerHTML = '<option>Loading...</option>';
      google.script.run.withSuccessHandler(groups => {
        let html = '<option value="" disabled selected>Select Group</option>';
        groups.forEach(g => html += `<option value="${g}">${g}</option>`);
        sel.innerHTML = html;
      }).getGroupList();
    }

    function fetchBaseline(target) {
      CURRENT_BASELINE_REV = 0; // Reset
      google.script.run.withSuccessHandler(res => {
         CURRENT_BASELINE_REV = res.revenue;
         // If AYCE is currently selected, apply logic immediately
         if (document.getElementById('sim-model').value === 'AYCE') {
            updateSimInputs();
         }
      }).getAccountRevenue(target); // Changed from getFinancialBaseline to match AiOpsFunctions
    }

    function onCalcAccountSelect() {
       const val = document.getElementById('calc-acc-input').value;
       resetSimResults();
       // Fetch Baseline if valid account selected
       if (ACCOUNT_MAP[val]) fetchBaseline(ACCOUNT_MAP[val].rid);
    }

    function onCalcGroupSelect() {
       const val = document.getElementById('calc-grp-select').value;
       resetSimResults();
       // Fetch Baseline if valid group selected
       if (val) fetchBaseline(val);
    }

    function updateSimInputs() {
      const model = document.getElementById('sim-model').value;
      const showDisco = (model === 'FREEMIUM');
      document.getElementById('input-disco').style.visibility = showDisco ? 'visible' : 'hidden';
      
      // Reset disco rate to default when Freemium is selected
      if (model === 'FREEMIUM') {
         document.getElementById('sim-rate').value = '1.50';
      }
      
      // AYCE Logic (90% of Baseline)
      if (model === 'AYCE') {
         if (CURRENT_BASELINE_REV > 0) {
            document.getElementById('sim-sub').value = Math.round(CURRENT_BASELINE_REV * 0.9);
         }
      } else {
         // Revert to system default based on dropdown
         const sys = document.getElementById('sim-system').value;
         document.getElementById('sim-sub').value = (sys === 'PRO') ? 499 : 299;
      }
      resetSimResults();
    }

    function resetSimResults() {
      document.getElementById('sim-results').style.display = 'none';
    }

    function runSimulation() {
      const model = document.getElementById('sim-model').value;
      const subFee = document.getElementById('sim-sub').value;
      const discoRate = document.getElementById('sim-rate').value;
      
      let target = '';
      if (CURRENT_SCOPE === 'INDIVIDUAL') {
        const val = document.getElementById('calc-acc-input').value;
        if (!ACCOUNT_MAP[val]) return alert("Please select a valid account first.");
        target = ACCOUNT_MAP[val].rid; 
      } else {
        target = document.getElementById('calc-grp-select').value;
        if (!target) return alert("Please select a group.");
      }

      const btn = event.target;
      const oldText = btn.innerText;
      btn.disabled = true;
      btn.innerText = "Calculating...";

      google.script.run.withSuccessHandler(res => {
        btn.disabled = false;
        btn.innerText = oldText;
        
        if (res.success || res.breakdown) {
           // Support both legacy and new return formats
           renderSimTable(res.data || res); 
        } else {
           alert("Simulation Error: " + (res.error || "Unknown"));
        }
      }).runPricingSimulation({ // Ensure this function exists in AiOpsFunctions or Main
        scope: CURRENT_SCOPE,
        target: target,
        model: model,
        subFee: subFee,
        discoRate: discoRate
      });
    }

    function renderSimTable(data) {
      const box = document.getElementById('sim-results');
      const container = document.getElementById('sim-table-container');
      box.style.display = 'block';
      
      const bd = data.breakdown;
      const cb = data.currentBreakdown || {}; // Current breakdown from server
      const fmt = (n) => n.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
      const pct = (n) => Math.round(n) + '%';
      
      // Simplified model labels
      const modelValue = document.getElementById('sim-model').value;
      const modelLabels = {
        'FREEMIUM': 'Freemium',
        'FREE_GOOGLE': 'Free Google',
        'AYCE': 'AYCE'
      };
      const label = modelLabels[modelValue] || modelValue;
      
      // Current pricing values (from server or calculate fallback)
      const currentSubFee = cb.subFee || 0;
      const currentVariableFees = cb.variableFees || 0;
      const currentTotal = cb.total || (bd.total - data.monthlyDelta);
      
      let rows = '';

      if (modelValue === 'FREEMIUM' || modelValue === 'FREE_GOOGLE') {
        rows = `
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">CURRENT PRICING</td></tr>
          <tr><td>Sub Fee</td><td>${fmt(currentSubFee)}</td></tr>
          <tr><td>Variable Fees</td><td>${fmt(currentVariableFees)}</td></tr>
          <tr style="border-top:1px solid #e2e8f0; font-weight:600;"><td>Current Total</td><td>${fmt(currentTotal)}</td></tr>
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">${label.toUpperCase()} SIMULATION</td></tr>
          <tr><td>Sub Fee</td><td>${fmt(bd.subFee)}</td></tr>
          <tr><td>Your Network</td><td>${fmt(bd.yourNetwork)}</td></tr>
          <tr><td>Network</td><td>${fmt(bd.network)}</td></tr>
          <tr><td>Discovery PI</td><td>${fmt(bd.discoPI)}</td></tr>
          <tr><td>Google</td><td>${fmt(bd.google)}</td></tr>
          <tr style="border-top:2px solid #e2e8f0; font-weight:bold;"><td>Simulated Total</td><td>${fmt(bd.total)}</td></tr>
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">COMPARISON</td></tr>
          <tr><td>Monthly Delta</td><td class="${data.monthlyDelta < 0 ? 'txt-grn' : 'txt-red'}">${fmt(data.monthlyDelta)}</td></tr>
          <tr><td>% Change</td><td class="${data.monthlyDelta < 0 ? 'txt-grn' : 'txt-red'}">${pct(data.percentChange * -1)}</td></tr>
        `;
      } else {
        rows = `
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">CURRENT PRICING</td></tr>
          <tr><td>Sub Fee</td><td>${fmt(currentSubFee)}</td></tr>
          <tr><td>Variable Fees</td><td>${fmt(currentVariableFees)}</td></tr>
          <tr style="border-top:1px solid #e2e8f0; font-weight:600;"><td>Current Total</td><td>${fmt(currentTotal)}</td></tr>
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">${label.toUpperCase()} SIMULATION</td></tr>
          <tr><td>Sub Fee</td><td>${fmt(bd.subFee)}</td></tr>
          <tr style="border-top:2px solid #e2e8f0; font-weight:bold;"><td>Simulated Total</td><td>${fmt(bd.total)}</td></tr>
          <tr style="background:#f8fafc;"><td colspan="2" style="font-weight:600; color:#64748b; padding:6px 0;">COMPARISON</td></tr>
          <tr><td>Monthly Delta</td><td class="${data.monthlyDelta < 0 ? 'txt-grn' : 'txt-red'}">${fmt(data.monthlyDelta)}</td></tr>
          <tr><td>% Change</td><td class="${data.monthlyDelta < 0 ? 'txt-grn' : 'txt-red'}">${pct(data.percentChange * -1)}</td></tr>
        `;
      }

      container.innerHTML = `<table class="mini-table" style="width:100%; margin-top:5px;">${rows}</table>`;
    }

    // =========================================================
    // --- KNOWLEDGE HUB CHAT FUNCTIONS ---
    // =========================================================
    
    /**
     * COLUMN CATEGORIES - Maps section names to column ranges
     * Mirrors the backend COLUMN_CATEGORIES for client-side column rotation
     */
    const COLUMN_CATEGORIES = {
      'ACCOUNT_IDS': { name: 'Account IDs', columns: ['E'] },
      'ACCOUNT_NAME': { name: 'Account Name', columns: ['G'] },
      'LOCATION': { name: 'Location', columns: ['I'] },
      'DATES_ACTIVITY': { name: 'Dates & Activity', columns: ['J', 'K', 'L'] },
      'ACCOUNT_STATUS': { name: 'Account + Status Info', columns: ['M', 'N', 'O'] },
      'SYSTEM_STATS': { name: 'System Stats', columns: ['P', 'Q', 'R'] },
      'PERCENTAGE_METRICS': { name: 'Percentage Metrics', columns: ['S', 'T', 'U'] },
      'REVENUE': { name: 'Revenue', columns: ['V', 'W', 'X'] },
      'SEATED_COVERS': { name: 'Seated Covers', columns: ['Y', 'Z', 'AA'] },
      'PRICING': { name: 'Pricing', columns: ['AB', 'AC', 'AD'] }
    };
    
    const khState = {
      isOpen: false,
      isLoading: false,
      currentRequestId: null,    // Tracks current request ID for abort handling
      conversationHistory: [],
      pendingColumnAction: null,    // Stores {category: 'DATES_ACTIVITY', metric: 'Customer Since'}
      pendingFunctionAction: null,  // Stores {functionName: 'manualUpdateNotesOnly', label: 'Refresh Notes'}
      pendingSlackAction: null,     // Stores {channel: 'ask-intouch'} for Slack escalation
      pendingSmartSelectAction: null, // Stores {rids: ['12345', '67890', ...]} for checking RIDs
      pendingTeamAnalysisAction: false, // True when team analysis is pending
      pendingRetryQuery: null,      // Stores query to retry after navigating to AM tab
      currentAMContext: null,       // Stores {isAMTab, fullName, isTeamView, sheetName}
      modifiedColumns: {},          // Tracks which columns were modified this session
      lastModifiedMetric: null,     // Tracks last modified metric for filtering advice context
      lastListedRIDs: null,         // Stores RIDs from the last list response for "add them" follow-ups
      autoIsolateMode: false,       // True when query started with "isolate" or "filter" - triggers auto check+filter
      showResetButton: false,       // True after auto-isolate to show Reset button alongside Focus20
      isolatedRIDs: null,           // Stores currently isolated RIDs for layered filtering
      shouldLogNextChat: true,      // Log first chat after session/sidebar/newchat/expand - then reset
      // Daily Jump Start state
      jumpStartData: null,          // Cached data from getJumpStartData()
      jumpStartLoading: false,      // Loading state for Jump Start
      expandedSections: {}          // Tracks which sections are expanded {termPending: true, ...}
    };
    
    // Confirmation phrases that trigger pending column action
    const CONFIRMATION_PHRASES = [
      'yes', 'yeah', 'ya', 'yep', 'yup', 'sure', 'ok', 'okay', 'go for it', 
      'do it', 'please', 'go ahead', 'sounds good', 'let\'s do it', 'make it so',
      'absolutely', 'definitely', 'of course', 'yes please', 'that would be great',
      'perfect', 'great', 'cool', 'awesome', 'proceed', 'confirmed', 'affirmative'
    ];

    const khEls = {
      panel: null,
      clearBtn: null,
      stopBtn: null,
      helpBtn: null,
      messages: null,
      input: null,
      sendBtn: null,
      welcome: null
    };

    function initKnowledgeHub() {
      // Tab-based layout - no FAB or minimize needed
      khEls.panel = document.getElementById('tab-bucket-iq');
      khEls.clearBtn = document.getElementById('khClear');
      khEls.stopBtn = document.getElementById('khStop');
      khEls.helpBtn = document.getElementById('helpBtn');
      khEls.messages = document.getElementById('khMessages');
      khEls.input = document.getElementById('khInput');
      khEls.sendBtn = document.getElementById('khSend');
      khEls.welcome = document.getElementById('khWelcome');

      // Wire up button click handlers
      if (khEls.clearBtn) khEls.clearBtn.addEventListener('click', clearKHChat);
      if (khEls.stopBtn) khEls.stopBtn.addEventListener('click', stopKHRequest);
      if (khEls.helpBtn) khEls.helpBtn.addEventListener('click', showHelpGuide);
      if (khEls.sendBtn) khEls.sendBtn.addEventListener('click', sendKHMessage);

      // Suggestion clicks
      document.querySelectorAll('.kh-suggestion').forEach(btn => {
        btn.addEventListener('click', () => {
          if (khEls.input) {
            khEls.input.value = btn.textContent;
            sendKHMessage();
          }
        });
      });

      // Enter key to send (Ctrl+Enter or Cmd+Enter for textarea)
      if (khEls.input) {
        khEls.input.addEventListener('keydown', (e) => {
          // Send on Enter (without Shift for new line)
          if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendKHMessage();
          }
        });
      }

      // Initialize AM context on load (chat is now always visible in tab)
      initAMContext();
    }
    
    function clearKHChat() {
      // Reset conversation state
      khState.conversationHistory = [];
      
      // Log first chat after new chat clicked
      khState.shouldLogNextChat = true;
      khState.isLoading = false;
      khState.currentRequestId = null;
      khState.pendingColumnAction = null;
      khState.pendingFunctionAction = null;
      khState.pendingSlackAction = null;
      khState.pendingSmartSelectAction = null;
      khState.pendingTeamAnalysisAction = false;
      khState.currentAMContext = null;
      khState.modifiedColumns = {};
      khState.lastListedRIDs = null;
      khState.autoIsolateMode = false;
      khState.showResetButton = false;
      khState.isolatedRIDs = null;
      // Reset Jump Start state
      khState.jumpStartData = null;
      khState.jumpStartLoading = false;
      khState.expandedSections = {};
      
      // Clear messages and show welcome screen
      if (khEls.messages) {
        khEls.messages.innerHTML = `
          <!-- Daily Jump Start Accordion -->
          <div class="kh-jumpstart" id="khJumpStart" style="display:none;">
            <div class="kh-jumpstart-header">
              <div class="kh-jumpstart-title">
                <span>üåÖ</span> DAILY JUMP START
              </div>
              <button class="kh-jumpstart-refresh" onclick="startMyDay()" title="Refresh">
                üîÑ
              </button>
            </div>
            <div id="khJumpStartContent">
              <!-- Sections will be injected here -->
            </div>
          </div>

          <div class="kh-welcome" id="khWelcome">
            <div class="kh-welcome-icon">‚ú¶</div>
            <h5>Let's Get Down To Buckets</h5>
            <p>Features, Metrics, Nasty Saves, Support, I've GOT YOUR BACK!</p>
            
            <button class="kh-jumpstart-trigger" onclick="startMyDay()">
              <span>üåÖ</span> Start My Day
            </button>
            <div class="kh-section-label">InTouch Help</div>
            <div class="kh-suggestions">
              <button class="kh-suggestion kh-top-prompt">What can you do?</button>
              <button class="kh-suggestion">How does iQ scoring work?</button>
              <button class="kh-suggestion">Help me build my Focus20 list</button>
              <button class="kh-suggestion">Sheet looks broken</button>
              <button class="kh-suggestion">What should I look at first?</button>
            </div>
            <div class="kh-section-label">Account Analysis</div>
            <div class="kh-suggestions">
              <button class="kh-suggestion">Summarize my bucket</button>
              <button class="kh-suggestion">Flag accounts I haven't touched in 60+ days</button>
              <button class="kh-suggestion">Who is up for renewal soon?</button>
              <button class="kh-suggestion">Show my Icons and Elites</button>
              <button class="kh-suggestion">Which accounts should I pitch PI to?</button>
              <button class="kh-suggestion">How do I rank against the team?</button>
            </div>
          </div>
        `;
        
        // Re-wire suggestion buttons
        document.querySelectorAll('.kh-suggestion').forEach(btn => {
          btn.addEventListener('click', () => {
            if (khEls.input) {
              khEls.input.value = btn.textContent;
              sendKHMessage();
            }
          });
        });
        // Note: New Chat and Help buttons are now in bucket-iq-input-area (outside khMessages)
        // so they don't need to be re-wired when clearing the chat
      }
      
      // Update welcome reference
      khEls.welcome = document.getElementById('khWelcome');
      
      // Clear input and reset buttons
      if (khEls.input) {
        khEls.input.value = '';
        khEls.input.focus();
      }
      
      // Reset send/stop buttons
      if (khEls.stopBtn) khEls.stopBtn.style.display = 'none';
      if (khEls.sendBtn) {
        khEls.sendBtn.style.display = 'inline-flex';
        khEls.sendBtn.disabled = false;
      }
    }

    // =========================================================
    // --- DAILY JUMP START FUNCTIONS ---
    // =========================================================
    
    /**
     * Truncate account name for display
     * @param {string} name - Account name
     * @param {number} maxLength - Maximum length (default 28)
     * @returns {string} Truncated name with '...' if needed
     */
    function truncateAccountName(name, maxLength = 28) {
      if (!name) return '';
      if (name.length <= maxLength) return name;
      return name.substring(0, maxLength - 3) + '...';
    }
    
    /**
     * Start My Day - Main entry point for Daily Jump Start
     * Fetches data and renders the accordion
     */
    function startMyDay() {
      console.log('[startMyDay] Starting...');
      
      // EDGE CASE 8: Debounce rapid clicks - prevent multiple fetches
      if (khState.jumpStartLoading) {
        console.log('[startMyDay] Already loading, ignoring click');
        return;
      }
      
      // Get DOM elements
      const jumpStartEl = document.getElementById('khJumpStart');
      const jumpStartContent = document.getElementById('khJumpStartContent');
      const welcomeEl = document.getElementById('khWelcome');
      const triggerBtn = document.querySelector('.kh-jumpstart-trigger');
      const refreshBtn = document.querySelector('.kh-jumpstart-refresh');
      
      if (!jumpStartEl || !jumpStartContent) {
        console.error('[startMyDay] Jump Start elements not found');
        return;
      }
      
      // Show accordion, hide welcome
      jumpStartEl.style.display = 'block';
      if (welcomeEl) welcomeEl.style.display = 'none';
      
      // EDGE CASE 2: Loading state - disable buttons to prevent double-clicks
      khState.jumpStartLoading = true;
      if (triggerBtn) triggerBtn.disabled = true;
      if (refreshBtn) refreshBtn.disabled = true;
      
      // Show loading spinner
      jumpStartContent.innerHTML = `
        <div class="kh-jumpstart-loading">
          <div class="kh-loading-dots">
            <span></span><span></span><span></span>
          </div>
          <div class="kh-jumpstart-loading-text">
            Loading your priorities...
          </div>
        </div>
      `;
      
      // Get AM name from context or let server detect
      const amName = khState.currentAMContext?.fullName || '';
      
      google.script.run
        .withSuccessHandler((result) => {
          console.log('[startMyDay] Data received:', result);
          
          // Re-enable buttons
          khState.jumpStartLoading = false;
          if (triggerBtn) triggerBtn.disabled = false;
          if (refreshBtn) refreshBtn.disabled = false;
          
          if (result.success) {
            // EDGE CASE 7: Reset expand state on refresh (fresh start)
            khState.jumpStartData = result;
            khState.expandedSections = {};
            renderJumpStartAccordion(result);
          } else {
            // EDGE CASE 3: Error state with friendly message and retry
            console.error('[startMyDay] Server returned error:', result.error);
            jumpStartContent.innerHTML = `
              <div class="kh-jumpstart-error">
                <div class="kh-jumpstart-error-icon">‚ö†Ô∏è</div>
                <div class="kh-jumpstart-error-text">
                  Couldn't load your daily summary
                </div>
                <div class="kh-jumpstart-error-detail">
                  ${result.error || 'Please try again'}
                </div>
                <button class="kh-jumpstart-btn primary" onclick="startMyDay()">
                  Try Again
                </button>
              </div>
            `;
          }
        })
        .withFailureHandler((error) => {
          // EDGE CASE 3: Network/server error handling
          console.error('[startMyDay] Fetch error:', error);
          
          // Re-enable buttons
          khState.jumpStartLoading = false;
          if (triggerBtn) triggerBtn.disabled = false;
          if (refreshBtn) refreshBtn.disabled = false;
          
          jumpStartContent.innerHTML = `
            <div class="kh-jumpstart-error">
              <div class="kh-jumpstart-error-icon">‚ùå</div>
              <div class="kh-jumpstart-error-text">
                Connection error
              </div>
              <div class="kh-jumpstart-error-detail">
                ${error.message || 'Please check your connection and try again'}
              </div>
              <button class="kh-jumpstart-btn primary" onclick="startMyDay()">
                Try Again
              </button>
            </div>
          `;
        })
        .getJumpStartData(amName);
    }
    
    /**
     * Render the Jump Start accordion with all sections
     * Handles threshold behavior: 0 (empty), 1-6 (expanded), 7+ (collapsed)
     * @param {Object} data - Data from getJumpStartData()
     */
    // Section tooltip definitions - natural language descriptions of qualifiers
    const sectionTooltips = {
      termPending: 'Accounts with status indicating termination or cancellation in progress',
      contractsExpiring: 'Accounts with contracts ending within the next 45 days',
      noEngagement60: 'Accounts with no logged engagement in the last 60+ days',
      noBookings30: 'Accounts with booking issues like 0-Fullbook or no recent bookings',
      highPIRevenue: 'Accounts with PI revenue share >30% AND total revenue >$1,200'
    };
    
    function renderJumpStartAccordion(data) {
      const jumpStartContent = document.getElementById('khJumpStartContent');
      if (!jumpStartContent || !data.sections) {
        console.error('[renderJumpStartAccordion] Missing content element or sections');
        return;
      }
      
      // Define section order (priority: high ‚Üí medium ‚Üí opportunity)
      const sectionOrder = ['termPending', 'contractsExpiring', 'noEngagement60', 'noBookings30', 'highPIRevenue'];
      
      let html = '';
      let totalAccounts = 0;
      
      sectionOrder.forEach(sectionId => {
        const section = data.sections[sectionId];
        if (!section) return;
        
        totalAccounts += section.count;
        const count = section.count;
        
        // EDGE CASE 6: Threshold behavior
        // 0 accounts: empty state, not expandable
        // 1-6 accounts: auto-expanded with list + buttons
        // 7+ accounts: collapsed by default, "Show All" button
        const isEmpty = count === 0;
        const isLargeSection = count > 6;
        
        // Determine expansion state
        let expanded = '';
        if (!isEmpty) {
          if (khState.expandedSections[sectionId] === undefined) {
            // First render: auto-expand 1-6, collapse 7+
            khState.expandedSections[sectionId] = !isLargeSection;
          }
          expanded = khState.expandedSections[sectionId] ? 'expanded' : '';
        }
        
        // EDGE CASE 1: Empty sections are not expandable
        const headerClickHandler = isEmpty 
          ? '' 
          : `onclick="toggleJumpStartSection('${sectionId}')"`;
        
        const emptyClass = isEmpty ? 'empty' : '';
        const chevronClass = isEmpty ? 'hidden' : '';
        const sectionTooltip = sectionTooltips[sectionId] || '';
        
        html += `
          <div class="kh-jumpstart-section ${expanded} ${emptyClass}" data-section-id="${sectionId}" data-count="${count}">
            <div class="kh-jumpstart-section-header" ${headerClickHandler}>
              <span class="kh-jumpstart-chevron ${chevronClass}">‚ñ∂</span>
              <span class="kh-jumpstart-dot">${section.priorityDot}</span>
              <span class="kh-jumpstart-name" onmouseenter="showCustomTooltip(this, '${sectionTooltip}')" onmouseleave="hideCustomTooltip()">${section.title}</span>
              <span class="kh-jumpstart-badge ${section.priority === 'high' && count > 0 ? 'urgent' : ''}">${count}</span>
            </div>
            <div class="kh-jumpstart-content">
              ${isEmpty ? renderEmptySection() : renderSectionContent(section, isLargeSection)}
            </div>
          </div>
        `;
      });
      
      // All clear state when no accounts need attention
      if (totalAccounts === 0) {
        html = `
          <div class="kh-jumpstart-all-clear">
            <div class="kh-jumpstart-all-clear-icon">‚ú®</div>
            <div class="kh-jumpstart-all-clear-text">All clear!</div>
            <div class="kh-jumpstart-all-clear-subtext">No accounts need immediate attention</div>
          </div>
        `;
      }
      
      jumpStartContent.innerHTML = html;
      console.log(`[renderJumpStartAccordion] Rendered ${sectionOrder.length} sections, ${totalAccounts} total accounts`);
    }
    
    /**
     * Get color class for days since engagement
     * @param {number} daysSince - Days since last engagement (999 = no date)
     * @returns {string} CSS class name
     */
    function getDaysColorClass(daysSince) {
      if (daysSince === 999) return 'days-red';     // No date = +90D
      if (daysSince <= 45) return 'days-green';
      if (daysSince <= 75) return 'days-orange';
      return 'days-red';                            // 76-90+
    }
    
    /**
     * Render content for a section with accounts
     * EDGE CASE 6: Handles threshold behavior for large sections (7+)
     * @param {Object} section - Section data with accounts array
     * @param {boolean} isLargeSection - True if section has 7+ accounts (collapsed by default)
     * @returns {string} HTML string
     */
    function renderSectionContent(section, isLargeSection = false) {
      if (!section.accounts || section.accounts.length === 0) {
        return renderEmptySection();
      }
      
      const count = section.accounts.length;
      
      // Build account list
      let listHtml = '<div class="kh-jumpstart-list">';
      section.accounts.forEach((acc, idx) => {
        const name = truncateAccountName(acc.name);
        
        // Render emoji tags inline with individual hover labels (using custom tooltip)
        let emojiHtml = '';
        if (acc.emojiTags && acc.emojiTags.length > 0) {
          emojiHtml = acc.emojiTags
            .map(tag => `<span class="kh-emoji-tag" onmouseenter="showCustomTooltip(this, '${tag.label}')" onmouseleave="hideCustomTooltip()">${tag.emoji}</span>`)
            .join('');
        } else if (acc.emoji) {
          // Fallback to old format if emojiTags not available
          emojiHtml = `<span class="kh-emoji-tag">${acc.emoji}</span>`;
        }
        
        // Build days label based on section type
        let daysHtml = '';
        if (section.id === 'contractsExpiring' && acc.daysUntil != null) {
          daysHtml = `<span class="kh-days-label">${acc.daysUntil}D</span>`;
        } else if (section.id === 'noEngagement60' && acc.daysSince != null) {
          const daysDisplay = acc.daysSince === 999 ? '+90D' : `${acc.daysSince}D`;
          const colorClass = getDaysColorClass(acc.daysSince);
          daysHtml = `<span class="kh-days-label ${colorClass}">${daysDisplay}</span>`;
        }
        
        listHtml += `
          <div class="kh-jumpstart-row">
            <span class="kh-jumpstart-emoji">${emojiHtml}</span>
            <span class="kh-jumpstart-acc-name" onmouseenter="showCustomTooltip(this, 'Click to copy RID: ${acc.rid}')" onmouseleave="hideCustomTooltip()" data-rid="${acc.rid}" onclick="copyRIDToClipboard('${acc.rid}')">${name}</span>
            ${daysHtml}
          </div>
        `;
      });
      listHtml += '</div>';
      
      // Build action buttons with hover tooltips (using custom tooltip)
      const actionsHtml = `
        <div class="kh-jumpstart-actions">
          <button class="kh-jumpstart-btn" onclick="jumpStartIsolate('${section.id}')" onmouseenter="showCustomTooltip(this, 'Filter Smart Select to show only these accounts')" onmouseleave="hideCustomTooltip()">
            üéØ Isolate
          </button>
          <button class="kh-jumpstart-btn primary" onclick="jumpStartDigIn('${section.id}')" onmouseenter="showCustomTooltip(this, 'Isolate accounts and generate AI analysis')" onmouseleave="hideCustomTooltip()">
            üîç Dig In
          </button>
          <button class="kh-jumpstart-btn" onclick="jumpStartGlean('${section.id}')" id="gleanBtn-${section.id}" onmouseenter="showCustomTooltip(this, 'Copy prompt to clipboard and open Glean')" onmouseleave="hideCustomTooltip()">
            üß† Glean
          </button>
        </div>
      `;
      
      // EDGE CASE 6: For collapsed large sections (7+), show "Show All" prompt
      // This appears when section is collapsed, inviting user to expand
      const showAllHtml = isLargeSection ? `
        <div class="kh-jumpstart-show-all">
          <button class="kh-jumpstart-show-all-btn" onclick="expandJumpStartSection('${section.id}')">
            üìã Show All ${count} Accounts
          </button>
        </div>
      ` : '';
      
      return showAllHtml + listHtml + actionsHtml;
    }
    
    /**
     * Render empty section placeholder
     * @returns {string} HTML string
     */
    function renderEmptySection() {
      return `<div class="kh-jumpstart-empty">‚úÖ No accounts need attention</div>`;
    }
    
    /**
     * Toggle expand/collapse for a section
     * EDGE CASE 1: Empty sections (count=0) are not expandable
     * @param {string} sectionId - Section identifier
     */
    function toggleJumpStartSection(sectionId) {
      const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
      if (!sectionEl) return;
      
      // EDGE CASE 1: Don't allow toggle on empty sections
      const count = parseInt(sectionEl.dataset.count || '0');
      if (count === 0) {
        console.log(`[toggleJumpStartSection] Section ${sectionId} is empty, not expandable`);
        return;
      }
      
      const isExpanded = sectionEl.classList.contains('expanded');
      
      if (isExpanded) {
        // Collapse this section
        sectionEl.classList.remove('expanded');
        khState.expandedSections[sectionId] = false;
      } else {
        // ACCORDION BEHAVIOR: Collapse all other sections first
        document.querySelectorAll('.kh-jumpstart-section.expanded').forEach(el => {
          el.classList.remove('expanded');
          const id = el.dataset.sectionId;
          if (id) khState.expandedSections[id] = false;
        });
        
        // Then expand this one
        sectionEl.classList.add('expanded');
        khState.expandedSections[sectionId] = true;
      }
    }
    
    /**
     * Explicitly expand a section (used by "Show All" button)
     * EDGE CASE 6: For 7+ account sections, clicking "Show All" expands
     * @param {string} sectionId - Section identifier
     */
    function expandJumpStartSection(sectionId) {
      const sectionEl = document.querySelector(`[data-section-id="${sectionId}"]`);
      if (!sectionEl) return;
      
      sectionEl.classList.add('expanded');
      khState.expandedSections[sectionId] = true;
      console.log(`[expandJumpStartSection] Expanded section ${sectionId}`);
    }
    
    /**
     * Silent isolation - same as executeAutoIsolate but returns promise, no chat message
     * Used by Dig In to isolate first, then show a single combined message
     * @param {Array} rids - Array of RID strings to isolate
     * @returns {Promise<Object>} - Resolves with {success, checkedCount, isolatedRIDs, ...}
     */
    function executeAutoIsolateSilent(rids) {
      return new Promise((resolve, reject) => {
        // Validate input
        if (!rids || rids.length === 0) {
          resolve({ success: false, error: 'No RIDs to isolate' });
          return;
        }
        
        // Get AM context for the server call
        const amName = khState.currentAMContext ? khState.currentAMContext.fullName : '';
        const isLayering = khState.isolatedRIDs && khState.isolatedRIDs.length > 0;
        
        console.log(`[executeAutoIsolateSilent] ${isLayering ? 'LAYERING' : 'FRESH'}: ${rids.length} RIDs`);
        
        // Choose appropriate server function based on whether we're layering
        const serverFunction = isLayering ? 'layerSmartSelectFilter' : 'checkAndFilterSmartSelect';
        
        // Build the server call dynamically
        if (isLayering) {
          // Layering: pass new RIDs, existing RIDs, and AM name
          google.script.run
            .withSuccessHandler((result) => {
              // Store isolated RIDs for future layering
              if (result.success) {
                khState.isolatedRIDs = result.isolatedRIDs || rids;
              }
              resolve(result);
            })
            .withFailureHandler((error) => {
              reject(error);
            })
            .layerSmartSelectFilter(rids, khState.isolatedRIDs, amName);
        } else {
          // Fresh isolation: just RIDs and AM name
          google.script.run
            .withSuccessHandler((result) => {
              // Store isolated RIDs for future layering
              if (result.success) {
                khState.isolatedRIDs = result.isolatedRIDs || rids;
              }
              resolve(result);
            })
            .withFailureHandler((error) => {
              reject(error);
            })
            .checkAndFilterSmartSelect(rids, amName);
        }
      });
    }
    
    /**
     * Isolate accounts in Smart Select (Jump Start action)
     * Uses existing executeAutoIsolate which handles its own messaging
     * @param {string} sectionId - Section identifier (e.g., 'termPending')
     */
    function jumpStartIsolate(sectionId) {
      // Validate section exists in cached data
      if (!khState.jumpStartData?.sections?.[sectionId]) {
        console.error('[jumpStartIsolate] Section not found:', sectionId);
        addKHMessage('error', 'Section data not loaded. Try refreshing.');
        return;
      }
      
      const section = khState.jumpStartData.sections[sectionId];
      const rids = section.accounts.map(a => a.rid);
      
      // Handle empty section
      if (rids.length === 0) {
        addKHMessage('assistant', `No accounts to isolate in **${section.title}**.`);
        return;
      }
      
      console.log(`[jumpStartIsolate] Isolating ${rids.length} RIDs from ${sectionId}`);
      
      // Store pending action (for state tracking)
      khState.pendingSmartSelectAction = { rids };
      
      // Delegate to existing executeAutoIsolate - it handles:
      // - Loading state
      // - Server call
      // - Success/error messaging
      // - Focus20 + Reset button setup
      executeAutoIsolate(rids, sectionId);  // Pass sectionId as dataIndicator for tracking
    }
    
    /**
     * Dig In - Isolate silently, then show ONE combined message with strategic summary
     * @param {string} sectionId - Section identifier
     */
    function jumpStartDigIn(sectionId) {
      // Validate section exists in cached data
      if (!khState.jumpStartData?.sections?.[sectionId]) {
        console.error('[jumpStartDigIn] Section not found:', sectionId);
        addKHMessage('error', 'Section data not loaded. Try refreshing.');
        return;
      }
      
      const section = khState.jumpStartData.sections[sectionId];
      const rids = section.accounts.map(a => a.rid);
      
      // Handle empty section
      if (rids.length === 0) {
        addKHMessage('assistant', `No accounts in **${section.title}** to analyze.`);
        return;
      }
      
      console.log(`[jumpStartDigIn] Digging into ${rids.length} accounts from ${sectionId}`);
      
      // Show loading state
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      // Use silent isolation - no automatic message
      executeAutoIsolateSilent(rids)
        .then((result) => {
          // Remove loading indicator
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            // Build the ONE combined message with strategic summary
            const summary = generateDigInSummary(section, result.checkedCount, sectionId);
            
            // Set up Focus20 action for the button
            khState.pendingFunctionAction = {
              functionName: 'moveTrueAccountsToFocus20',
              label: 'Add to Focus20'
            };
            
            // Enable Reset button
            khState.showResetButton = true;
            
            // Output single combined message with action buttons
            addKHMessage('assistant', summary, true);
            
          } else if (result.wrongTab) {
            // User is on wrong AM tab
            addKHMessage('assistant', 
              `**Heads up:** You're not on the correct tab.\n\n` +
              `Expected: **${result.expectedTab}**\n` +
              `Current: **${result.currentTab || 'unknown'}**\n\n` +
              `Please navigate to the correct tab and try again.`
            );
          } else if (result.noIntersection) {
            // Layering resulted in no matches
            addKHMessage('assistant', 
              `**No matching accounts found.**\n\n` +
              `None of the ${section.title} accounts overlap with your current filter.\n\n` +
              `Click **Reset** to clear filters and try again.`
            );
            khState.showResetButton = true;
            khState.pendingFunctionAction = null;
            addKHMessage('assistant', '', true);  // Show reset button
          } else {
            // Generic error
            addKHMessage('error', result.error || 'Could not isolate accounts. Please try again.');
          }
        })
        .catch((error) => {
          // Handle promise rejection
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + (error.message || 'Unknown error'));
        });
    }
    
    /**
     * Generate strategic summary message for Dig In based on section type
     * @param {Object} section - Section data with accounts array
     * @param {number} isolatedCount - Number of accounts actually isolated
     * @param {string} sectionId - Section identifier for strategic focus
     * @returns {string} Formatted markdown summary
     */
    function generateDigInSummary(section, isolatedCount, sectionId) {
      // Header with isolation confirmation
      let summary = `üîç **Digging into ${section.title}** (${isolatedCount} accounts)\n\n`;
      summary += `‚úÖ Sheet filtered to these accounts\n\n`;
      
      // Strategic summary varies by section type
      summary += getStrategicSummary(sectionId, section) + '\n\n';
      
      // Account list (top 5 with details)
      summary += `**Accounts:**\n`;
      section.accounts.slice(0, 5).forEach(acc => {
        const emoji = acc.emoji || '';
        const name = truncateAccountName(acc.name, 25);
        summary += `‚Ä¢ ${emoji} **${name}** (${acc.rid})`;
        
        // Add context based on section type
        if (sectionId === 'noEngagement60' && acc.daysSince) {
          summary += ` ‚Äî ${acc.daysSince}d since contact`;
        } else if (sectionId === 'noBookings30' && acc.reason) {
          summary += ` ‚Äî ${acc.reason}`;
        } else if (sectionId === 'highPIRevenue') {
          if (acc.piShare) summary += ` ‚Äî PI: ${acc.piShare}`;
          if (acc.revenue) summary += `, Rev: ${acc.revenue}`;
        }
        summary += '\n';
      });
      
      // Show overflow count
      if (section.accounts.length > 5) {
        summary += `‚Ä¢ _...and ${section.accounts.length - 5} more_\n`;
      }
      
      // CTA for next action
      summary += `\n**Layer another filter or:**`;
      
      return summary;
    }
    
    /**
     * Get strategic summary content based on section type
     * @param {string} sectionId - Section identifier
     * @param {Object} section - Section data
     * @returns {string} Strategic guidance text
     */
    function getStrategicSummary(sectionId, section) {
      const count = section.accounts.length;
      
      switch (sectionId) {
        case 'termPending':
          return `${section.priorityDot} **Renewal Urgency**\n` +
            `These ${count} accounts have terms pending/expired. Priority actions:\n` +
            `‚Ä¢ Review each contract status in column K (Term End Date)\n` +
            `‚Ä¢ Check for competitive threats before outreach\n` +
            `‚Ä¢ Prepare renewal proposals with any applicable upsells\n` +
            `‚Ä¢ _Consider escalating accounts with > $1K monthly revenue_`;
            
        case 'contractsExpiring':
          return `${section.priorityDot} **Expiration Timeline**\n` +
            `These ${count} accounts are approaching contract end. Strategy:\n` +
            `‚Ä¢ Prioritize by revenue and churn risk\n` +
            `‚Ä¢ Document competitive intel from recent conversations\n` +
            `‚Ä¢ Identify upsell opportunities (PI, Experiences, etc.)\n` +
            `‚Ä¢ _30-day window is ideal for renewal conversations_`;
            
        case 'noEngagement60':
          return `${section.priorityDot} **Re-engagement Priority**\n` +
            `These ${count} accounts haven't been contacted in 60+ days:\n` +
            `‚Ä¢ Check last engagement date in column L\n` +
            `‚Ä¢ Review recent performance metrics for conversation starters\n` +
            `‚Ä¢ Watch for churn signals (declining covers, disco issues)\n` +
            `‚Ä¢ _Quick check-in calls can prevent silent churn_`;
            
        case 'noBookings30':
          return `${section.priorityDot} **Booking Investigation**\n` +
            `These ${count} accounts have booking issues to investigate:\n` +
            `‚Ä¢ Check availability settings and inventory\n` +
            `‚Ä¢ Review seasonal patterns vs. anomalies\n` +
            `‚Ä¢ Look for operational issues (closed days, staffing)\n` +
            `‚Ä¢ _0-Fullbook often indicates setup problems, not demand issues_`;
            
        case 'highPIRevenue':
          return `${section.priorityDot} **Revenue Optimization**\n` +
            `These ${count} accounts have strong PI traction (>30% share, >$1.2K rev):\n` +
            `‚Ä¢ Review PI campaign performance in DISTRO\n` +
            `‚Ä¢ Identify optimization opportunities (bid adjustments, targeting)\n` +
            `‚Ä¢ Consider upsell to higher PI tiers or Experiences\n` +
            `‚Ä¢ _These are your high-ROI accounts ‚Äî nurture the relationship_`;
            
        default:
          return `${section.priorityDot} **${section.title}**\n` +
            `${count} accounts flagged for review.`;
      }
    }
    
    /**
     * Glean - Copy comprehensive prompt to clipboard and open Glean
     * @param {string} sectionId - Section identifier
     */
    function jumpStartGlean(sectionId) {
      // Validate section exists
      if (!khState.jumpStartData?.sections?.[sectionId]) {
        console.error('[jumpStartGlean] Section not found:', sectionId);
        addKHMessage('error', 'Section data not loaded. Try refreshing.');
        return;
      }
      
      const section = khState.jumpStartData.sections[sectionId];
      const amName = khState.jumpStartData.amName || 'Account Manager';
      
      // Handle empty section
      if (section.accounts.length === 0) {
        addKHMessage('assistant', `No accounts in **${section.title}** to analyze with Glean.`);
        return;
      }
      
      console.log(`[jumpStartGlean] Generating Glean prompt for ${section.accounts.length} accounts`);
      
      // Get the button for visual feedback
      const gleanBtn = document.getElementById(`gleanBtn-${sectionId}`);
      const originalText = gleanBtn ? gleanBtn.innerHTML : '';
      
      // Generate the comprehensive Glean prompt
      const prompt = generateGleanPrompt(section, amName, sectionId);
      
      // Copy to clipboard and open Glean
      navigator.clipboard.writeText(prompt)
        .then(() => {
          // EDGE CASE 9: Visual feedback on button
          if (gleanBtn) {
            gleanBtn.innerHTML = '‚úì Copied';
            gleanBtn.classList.add('copied');
            
            // Reset button text after 2 seconds
            setTimeout(() => {
              gleanBtn.innerHTML = originalText;
              gleanBtn.classList.remove('copied');
            }, 2000);
          }
          
          // Open Glean in new tab
          window.open('https://app.glean.com/', '_blank');
          
          // Show confirmation with preview of the prompt
          const confirmationMsg = 
            `üß† **Glean Analysis Ready**\n\n` +
            `Copied to clipboard! Paste into Glean to analyze these accounts.\n\n` +
            `\`\`\`\n` +
            `### CONTEXT\n` +
            `You are analyzing ${section.accounts.length} OpenTable restaurant accounts for ${amName}.\n` +
            `These accounts were flagged as: ${section.title}\n\n` +
            `### ACCOUNTS TO ANALYZE\n` +
            section.accounts.slice(0, 3).map(a => `${a.emoji || '‚Ä¢'} ${a.name}`).join('\n') +
            (section.accounts.length > 3 ? `\n... and ${section.accounts.length - 3} more` : '') +
            `\n\`\`\``;
          
          addKHMessage('assistant', confirmationMsg);
        })
        .catch((err) => {
          console.error('[jumpStartGlean] Clipboard error:', err);
          addKHMessage('error', 'Could not copy to clipboard. Please try again.');
        });
    }
    
    /**
     * Generate comprehensive Glean prompt with section-specific focus
     * @param {Object} section - Section data with accounts array
     * @param {string} amName - AM's full name
     * @param {string} sectionId - Section identifier for customization
     * @returns {string} Formatted prompt for Glean
     */
    function generateGleanPrompt(section, amName, sectionId) {
      // Build the comprehensive prompt
      let prompt = `### CONTEXT\n`;
      prompt += `You are analyzing ${section.accounts.length} OpenTable restaurant accounts for ${amName}.\n`;
      prompt += `These accounts were flagged as: ${section.title}\n\n`;
      
      // Section-specific focus area
      prompt += `### FOCUS AREA\n`;
      prompt += getGleanFocus(sectionId) + '\n\n';
      
      // Account list with details
      prompt += `### ACCOUNTS TO ANALYZE\n`;
      section.accounts.forEach(acc => {
        const emoji = acc.emoji || '‚Ä¢';
        prompt += `${emoji} ${acc.name}`;
        if (acc.reason) prompt += ` ‚Äî ${acc.reason}`;
        if (acc.piShare) prompt += ` ‚Äî PI: ${acc.piShare}`;
        if (acc.revenue) prompt += `, Rev: ${acc.revenue}`;
        if (acc.daysSince) prompt += ` ‚Äî ${acc.daysSince}d since contact`;
        prompt += '\n';
      });
      
      // RIDs for system lookup
      const ridList = section.accounts.map(a => a.rid).join(', ');
      prompt += `\nRIDs for system lookup: ${ridList}\n\n`;
      
      // Standard analysis request
      prompt += `### ANALYSIS REQUEST\n`;
      prompt += `Using all available company knowledge, CRM data, and integrated systems:\n\n`;
      prompt += `1. **Account Health Summary** ‚Äî Recent activity and red flags per account\n`;
      prompt += `2. **Pattern Recognition** ‚Äî Common themes across these accounts\n`;
      prompt += `3. **Engagement History** ‚Äî Recent communications per account\n`;
      prompt += `4. **Recommended Actions** ‚Äî Specific next steps per account\n`;
      prompt += `5. **Prioritization** ‚Äî Rank by urgency and impact\n\n`;
      
      // Output format guidance
      prompt += `### OUTPUT FORMAT\n`;
      prompt += `Clear headers per account, bullet points for scanning, flag urgent items with ‚ö†Ô∏è`;
      
      return prompt;
    }
    
    /**
     * Get section-specific focus text for Glean prompt
     * @param {string} sectionId - Section identifier
     * @returns {string} Focus area description
     */
    function getGleanFocus(sectionId) {
      switch (sectionId) {
        case 'termPending':
          return `Focus on renewal barriers and save strategies. Look for:\n` +
            `‚Ä¢ Previous renewal conversations and outcomes\n` +
            `‚Ä¢ Competitive mentions or threats\n` +
            `‚Ä¢ Contract negotiation history\n` +
            `‚Ä¢ Any escalations or at-risk flags`;
            
        case 'contractsExpiring':
          return `Focus on competitive intel and renewal conversations. Look for:\n` +
            `‚Ä¢ Recent performance discussions\n` +
            `‚Ä¢ Pricing negotiations or objections\n` +
            `‚Ä¢ Feature requests or complaints\n` +
            `‚Ä¢ Relationship health indicators`;
            
        case 'noEngagement60':
          return `Focus on re-engagement opportunities and churn signals. Look for:\n` +
            `‚Ä¢ Last meaningful interaction and outcome\n` +
            `‚Ä¢ Any support tickets or issues\n` +
            `‚Ä¢ Performance trends before silence\n` +
            `‚Ä¢ Similar accounts that churned`;
            
        case 'noBookings30':
          return `Focus on operational issues and booking barriers. Look for:\n` +
            `‚Ä¢ Technical support tickets\n` +
            `‚Ä¢ Availability or inventory discussions\n` +
            `‚Ä¢ Seasonal pattern context\n` +
            `‚Ä¢ Similar accounts with booking issues`;
            
        case 'highPIRevenue':
          return `Focus on PI optimization and upsell opportunities. Look for:\n` +
            `‚Ä¢ PI campaign performance history\n` +
            `‚Ä¢ Budget discussions or changes\n` +
            `‚Ä¢ Competitor PI activity\n` +
            `‚Ä¢ Expansion or tier upgrade potential`;
            
        default:
          return `Analyze these accounts for patterns, risks, and recommended actions.`;
      }
    }

    function sendKHMessage() {
      if (!khEls.input) return;
      const query = khEls.input.value.trim();
      if (!query || khState.isLoading) return;

      // Hide welcome message
      if (khEls.welcome) {
        khEls.welcome.style.display = 'none';
      }

      // Check if this is a confirmation for a pending action
      const normalizedQuery = query.toLowerCase().trim();
      if (isConfirmationPhrase(normalizedQuery)) {
        if (khState.pendingColumnAction) {
          executeColumnAction(false); // false = triggered by text, not button
          khEls.input.value = '';
          return;
        }
        if (khState.pendingFunctionAction) {
          executeFunctionAction(false); // false = triggered by text, not button
          khEls.input.value = '';
          return;
        }
        if (khState.pendingPortfolioAction) {
          executePortfolioAction(false); // false = triggered by text, not button
          khEls.input.value = '';
          return;
        }
        
        // If user confirms but no pending action, check if they want filtering advice
        // (common after a column change when AI offers "let me know if you'd like filtering advice")
        if (khState.lastModifiedMetric) {
          addKHMessage('user', query);
          khEls.input.value = '';
          provideFilteringAdvice(khState.lastModifiedMetric);
          return;
        }
      }

      // Check if user is asking to add previously listed RIDs to Smart Select
      if (isAddToSmartSelectRequest(query) && khState.lastListedRIDs && khState.lastListedRIDs.length > 0) {
        console.log(`[sendKHMessage] User asking to add ${khState.lastListedRIDs.length} previously listed RIDs to Smart Select`);
        khState.pendingSmartSelectAction = { rids: khState.lastListedRIDs };
        addKHMessage('user', query);
        khEls.input.value = '';
        executeSmartSelectAction();
        return;
      }
      
      // Clear any pending actions if user asks something else
      khState.pendingColumnAction = null;
      khState.pendingFunctionAction = null;
      khState.pendingSlackAction = null;
      
      // Detect auto-isolate mode: query starts with "isolate" or "filter" (with optional pleasantries)
      const lowerQuery = query.toLowerCase();
      // Match: "isolate...", "filter...", "please isolate...", "kindly filter...", "can you isolate...", etc.
      const isolatePattern = /^(please\s+|kindly\s+|can\s+you\s+|could\s+you\s+|would\s+you\s+|i\s+want\s+to\s+|i\s+need\s+to\s+|let'?s\s+|just\s+)?(isolate|filter)\b/i;
      khState.autoIsolateMode = isolatePattern.test(lowerQuery);
      if (khState.autoIsolateMode) {
        console.log('[sendKHMessage] Auto-isolate mode activated (query starts with isolate/filter)');
      }

      // Add user message to UI
      addKHMessage('user', query);
      khEls.input.value = '';

      // Show loading - swap send/stop buttons
      khState.isLoading = true;
      khState.currentRequestId = Date.now(); // Track request for abort
      if (khEls.sendBtn) khEls.sendBtn.style.display = 'none';
      if (khEls.stopBtn) khEls.stopBtn.style.display = 'inline-flex';
      const loadingEl = addKHMessage('loading', '');

      // Build conversation history for context
      const historyJson = khState.conversationHistory.length > 0 
        ? JSON.stringify(khState.conversationHistory) 
        : null;

      // Call backend
      google.script.run
        .withSuccessHandler((result) => {
          // Check if request was stopped
          if (!khState.isLoading && !khState.currentRequestId) {
            if (loadingEl) loadingEl.remove();
            return; // Request was stopped, ignore response
          }
          
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          khState.currentRequestId = null;
          // Reset buttons
          if (khEls.stopBtn) khEls.stopBtn.style.display = 'none';
          if (khEls.sendBtn) {
            khEls.sendBtn.style.display = 'inline-flex';
            khEls.sendBtn.disabled = false;
          }

          if (result.success) {
            // Reset log flag after successful chat (first message was logged)
            khState.shouldLogNextChat = false;
            
            // Check if user needs to navigate to AM tab first
            if (result.notOnAMTab) {
              khState.pendingRetryQuery = result.originalQuery || query;
              addKHMessage('assistant', result.answer, true);  // showActionButtons=true to trigger retry button
              return;
            }
            
            // Check for action tags and extract them
            const { cleanedAnswer, columnAction, functionAction, slackAction, smartSelectAction, teamAnalysisAction } = parseColumnAction(result.answer);
            
            if (columnAction) {
              khState.pendingColumnAction = columnAction;
            }
            if (functionAction) {
              khState.pendingFunctionAction = functionAction;
            }
            if (slackAction) {
              khState.pendingSlackAction = slackAction;
            }
            if (smartSelectAction) {
              khState.pendingSmartSelectAction = smartSelectAction;
              // Store AM context for tab verification
              if (result.amContext && result.amContext.fullName) {
                khState.currentAMContext = result.amContext;
              }
            }
            if (teamAnalysisAction) {
              khState.pendingTeamAnalysisAction = true;
            }
            
            // Store AM context if data was injected
            if (result.amContext) {
              khState.currentAMContext = result.amContext;
            }
            
            // Add data source indicator if data was injected
            const dataIndicator = result.dataInjected && result.dataSource 
              ? `<div class="kh-data-indicator">üìä ${result.dataSource.amName} (${result.dataSource.totalAccounts} accounts)</div>`
              : '';
            
            // Extract and store any RIDs listed in the response for "add them" follow-ups
            const extractedRIDs = extractRIDsFromMessage(cleanedAnswer);
            if (extractedRIDs && extractedRIDs.length > 0) {
              console.log(`[sendKHMessage] Storing ${extractedRIDs.length} RIDs from response for potential Smart Select`);
              khState.lastListedRIDs = extractedRIDs;
            }
            
            // Check if we should auto-isolate: >10 RIDs OR autoIsolateMode active
            const shouldAutoIsolate = smartSelectAction && 
              (smartSelectAction.rids.length > 10 || khState.autoIsolateMode);
            
            if (shouldAutoIsolate) {
              console.log(`[sendKHMessage] Auto-isolate triggered: ${smartSelectAction.rids.length} RIDs, autoIsolateMode=${khState.autoIsolateMode}`);
              // Show the message without action buttons (we'll auto-execute and add new buttons after)
              addKHMessage('assistant', cleanedAnswer, false, dataIndicator);
              // Auto-execute check+filter
              executeAutoIsolate(smartSelectAction.rids, dataIndicator);
              // Reset autoIsolateMode
              khState.autoIsolateMode = false;
            } else {
              // Normal flow: show action buttons if there's a pending action
              const hasAction = !!columnAction || !!functionAction || !!slackAction || !!smartSelectAction || !!teamAnalysisAction;
              addKHMessage('assistant', cleanedAnswer, hasAction, dataIndicator);
            }
            
            // Add to history for follow-up context
            khState.conversationHistory.push({ role: 'user', content: query });
            khState.conversationHistory.push({ role: 'assistant', content: cleanedAnswer });
            // Keep history manageable (last 10 exchanges)
            if (khState.conversationHistory.length > 20) {
              khState.conversationHistory = khState.conversationHistory.slice(-20);
            }
          } else {
            addKHMessage('error', 'Error: ' + (result.error || 'Something went wrong'));
          }
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          khState.currentRequestId = null;
          // Reset buttons
          if (khEls.stopBtn) khEls.stopBtn.style.display = 'none';
          if (khEls.sendBtn) {
            khEls.sendBtn.style.display = 'inline-flex';
            khEls.sendBtn.disabled = false;
          }
          addKHMessage('error', 'Error: ' + error.message);
        })
        .askInTouchGuide(query, historyJson, khState.shouldLogNextChat);
    }
    
    /**
     * Stop the current AI request
     * Sets flags to ignore the response and resets UI
     */
    function stopKHRequest() {
      console.log('[stopKHRequest] Stopping current request');
      
      // Set flags to ignore any pending response
      khState.isLoading = false;
      khState.currentRequestId = null;
      
      // Remove any loading indicators
      const loadingEls = document.querySelectorAll('.kh-message.loading');
      loadingEls.forEach(el => el.remove());
      
      // Swap buttons back
      if (khEls.stopBtn) khEls.stopBtn.style.display = 'none';
      if (khEls.sendBtn) {
        khEls.sendBtn.style.display = 'inline-flex';
        khEls.sendBtn.disabled = false;
      }
      
      // Add system message
      addKHMessage('assistant', '_Request stopped. Ask me something else!_');
      
      // Focus input
      if (khEls.input) khEls.input.focus();
    }
    
    /**
     * Check if the query is a confirmation phrase
     */
    function isConfirmationPhrase(query) {
      // Check exact match or starts with confirmation
      return CONFIRMATION_PHRASES.some(phrase => 
        query === phrase || 
        query.startsWith(phrase + ' ') || 
        query.startsWith(phrase + '!')
      );
    }
    
    /**
     * Extract RIDs from a message that lists accounts
     * Looks for patterns like "‚Ä¢ 1234567 - Restaurant Name" or "**1234567** - Name"
     * @param {string} content - The message content
     * @returns {Array|null} Array of RID strings, or null if none found
     */
    function extractRIDsFromMessage(content) {
      if (!content) return null;
      
      const rids = [];
      
      // Pattern 1: Bullet list format "‚Ä¢ 1234567 - Restaurant Name"
      const bulletPattern = /[‚Ä¢\-\*]\s*(\d{4,10})\s*[\-‚Äì]/g;
      let match;
      while ((match = bulletPattern.exec(content)) !== null) {
        if (!rids.includes(match[1])) {
          rids.push(match[1]);
        }
      }
      
      // Pattern 2: Bold RID format "**1234567** - Name"
      const boldPattern = /\*\*(\d{4,10})\*\*/g;
      while ((match = boldPattern.exec(content)) !== null) {
        if (!rids.includes(match[1])) {
          rids.push(match[1]);
        }
      }
      
      // Pattern 3: RID at start of line "1234567 - Restaurant"
      const linePattern = /^(\d{4,10})\s*[\-‚Äì]/gm;
      while ((match = linePattern.exec(content)) !== null) {
        if (!rids.includes(match[1])) {
          rids.push(match[1]);
        }
      }
      
      if (rids.length > 0) {
        console.log(`[extractRIDsFromMessage] Found ${rids.length} RIDs in message`);
        return rids;
      }
      
      return null;
    }
    
    /**
     * Check if query is asking to add previously listed items to Smart Select
     * @param {string} query - The user's query
     * @returns {boolean} True if this is an "add them" type request
     */
    function isAddToSmartSelectRequest(query) {
      if (!query) return false;
      const patterns = [
        /add\s*(them|those|these|the\s*rids?|all)?\s*to\s*(my\s*)?(smart\s*)?select/i,
        /check\s*(them|those|these|all)\s*(in|on)\s*(smart\s*)?select/i,
        /put\s*(them|those|these)\s*(in|on)\s*(smart\s*)?select/i,
        /select\s*(them|those|these|all)/i,
        /yes,?\s*(add|check)\s*(them)?/i,
        /^(yes|yeah|yep|sure|ok|please|do it)\s*$/i  // Simple confirmation after RID list
      ];
      return patterns.some(p => p.test(query.trim()));
    }
    
    /**
     * Parse action tags from AI response
     * Supports [COLUMN_ACTION:...], [FUNCTION_ACTION:...], [SLACK_ACTION:...], [SMART_SELECT_ACTION:...], [TEAM_ANALYSIS_ACTION]
     * Returns { cleanedAnswer, columnAction, functionAction, slackAction, smartSelectAction, teamAnalysisAction }
     */
    function parseColumnAction(answer) {
      let columnAction = null;
      let functionAction = null;
      let smartSelectAction = null;
      let teamAnalysisAction = false;
      
      // Match category-based column format: [COLUMN_ACTION:CATEGORY_KEY:Metric Name]
      const columnRegex = /\[COLUMN_ACTION:([A-Z_]+):([^\]]+)\]/g;
      const columnMatch = columnRegex.exec(answer);
      if (columnMatch) {
        const categoryKey = columnMatch[1];
        const metric = columnMatch[2].trim();
        
        // Validate the category exists
        if (COLUMN_CATEGORIES[categoryKey]) {
          columnAction = {
            category: categoryKey,
            metric: metric
          };
        } else {
          // Fallback: if it looks like a column letter (legacy format), try to map it
          const legacyColumnMap = {
            'E': 'ACCOUNT_IDS', 'G': 'ACCOUNT_NAME', 'I': 'LOCATION',
            'J': 'DATES_ACTIVITY', 'K': 'DATES_ACTIVITY', 'L': 'DATES_ACTIVITY',
            'M': 'ACCOUNT_STATUS', 'N': 'ACCOUNT_STATUS', 'O': 'ACCOUNT_STATUS',
            'P': 'SYSTEM_STATS', 'Q': 'SYSTEM_STATS', 'R': 'SYSTEM_STATS',
            'S': 'PERCENTAGE_METRICS', 'T': 'PERCENTAGE_METRICS', 'U': 'PERCENTAGE_METRICS',
            'V': 'REVENUE', 'W': 'REVENUE', 'X': 'REVENUE',
            'Y': 'SEATED_COVERS', 'Z': 'SEATED_COVERS', 'AA': 'SEATED_COVERS',
            'AB': 'PRICING', 'AC': 'PRICING', 'AD': 'PRICING'
          };
          
          if (legacyColumnMap[categoryKey]) {
            console.log('[parseColumnAction] Converting legacy column format:', categoryKey);
            columnAction = {
              category: legacyColumnMap[categoryKey],
              metric: metric
            };
          } else {
            console.warn('[parseColumnAction] Unknown category/column:', categoryKey);
          }
        }
      }
      
      // Match function action format: [FUNCTION_ACTION:functionName:Button Label]
      const functionRegex = /\[FUNCTION_ACTION:([a-zA-Z_]+):([^\]]+)\]/g;
      const functionMatch = functionRegex.exec(answer);
      if (functionMatch) {
        functionAction = {
          functionName: functionMatch[1],
          label: functionMatch[2].trim()
        };
        console.log('[parseColumnAction] Found function action:', functionAction);
      }
      
      // Match Slack action format: [SLACK_ACTION:channel-name]
      let slackAction = null;
      const slackRegex = /\[SLACK_ACTION:([^\]]+)\]/g;
      const slackMatch = slackRegex.exec(answer);
      if (slackMatch) {
        slackAction = {
          channel: slackMatch[1].trim()
        };
        console.log('[parseColumnAction] Found Slack action:', slackAction);
      }
      
      // Match Smart Select action format: [SMART_SELECT_ACTION:rid1,rid2,rid3,...]
      const smartSelectRegex = /\[SMART_SELECT_ACTION:([^\]]+)\]/g;
      const smartSelectMatch = smartSelectRegex.exec(answer);
      if (smartSelectMatch) {
        const ridsString = smartSelectMatch[1].trim();
        const rids = ridsString.split(',').map(r => r.trim()).filter(r => r);
        if (rids.length > 0) {
          smartSelectAction = { rids: rids };
          console.log('[parseColumnAction] Found Smart Select action:', smartSelectAction);
        }
      }
      
      // Match Team Analysis action: [TEAM_ANALYSIS_ACTION]
      const teamAnalysisRegex = /\[TEAM_ANALYSIS_ACTION\]/g;
      if (teamAnalysisRegex.test(answer)) {
        teamAnalysisAction = true;
        console.log('[parseColumnAction] Found Team Analysis action');
      }
      
      // Remove all action tags from the displayed answer
      const cleanedAnswer = answer
        .replace(/\[COLUMN_ACTION:[^\]]+\]/g, '')
        .replace(/\[FUNCTION_ACTION:[^\]]+\]/g, '')
        .replace(/\[SLACK_ACTION:[^\]]+\]/g, '')
        .replace(/\[SMART_SELECT_ACTION:[^\]]+\]/g, '')
        .replace(/\[TEAM_ANALYSIS_ACTION\]/g, '')
        .replace(/\[PORTFOLIO_ACTION:[^\]]*\]/g, '')  // Keep for backward compatibility
        .trim();
      
      return { cleanedAnswer, columnAction, functionAction, slackAction, smartSelectAction, teamAnalysisAction };
    }
    
    /**
     * Resolve which column to use for a given category
     * Implements column rotation: uses next available column in the section
     * If section is exhausted, wraps back to first column
     * @param {string} categoryKey - The category key (e.g., 'DATES_ACTIVITY')
     * @returns {string} The column letter to use (e.g., 'J', 'K', or 'L')
     */
    function resolveColumnForCategory(categoryKey) {
      const category = COLUMN_CATEGORIES[categoryKey];
      if (!category) {
        console.error('[resolveColumnForCategory] Unknown category:', categoryKey);
        return null;
      }
      
      const columns = category.columns;
      
      // Find the first column in this category that hasn't been modified this session
      for (const col of columns) {
        if (!khState.modifiedColumns[col]) {
          console.log(`[resolveColumnForCategory] ${categoryKey} ‚Üí using unmodified column ${col}`);
          return col;
        }
      }
      
      // All columns in section are modified, wrap back to first
      console.log(`[resolveColumnForCategory] ${categoryKey} ‚Üí section exhausted, wrapping to ${columns[0]}`);
      return columns[0];
    }
    
    /**
     * Execute the pending column action
     * Now uses category-based resolution with column rotation
     * @param {boolean} fromButton - If true, called from action button (don't add "Yes" message)
     */
    function executeColumnAction(fromButton = true) {
      if (!khState.pendingColumnAction) return;
      
      const { category, metric } = khState.pendingColumnAction;
      
      // Resolve which column to use (handles rotation)
      const resolvedColumn = resolveColumnForCategory(category);
      if (!resolvedColumn) {
        addKHMessage('error', 'Could not determine which column to use.');
        khState.pendingColumnAction = null;
        return;
      }
      
      // Remove action buttons if they exist
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Add user confirmation message only if triggered by text (not button)
      if (!fromButton) {
        addKHMessage('user', 'Yes');
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log(`[executeColumnAction] Setting column ${resolvedColumn} to "${metric}" (category: ${category})`);
      
      // Call backend to set the column
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            // Track this modification for column rotation and filtering advice context
            khState.modifiedColumns[result.column] = result.metric;
            khState.lastModifiedMetric = result.metric;
            console.log('[executeColumnAction] Tracked modification:', khState.modifiedColumns);
            
            // Get the section name for a friendly message
            const sectionName = COLUMN_CATEGORIES[category]?.name || category;
            
            // Check if column was already set to this metric
            if (result.alreadySet) {
              addKHMessage('assistant', `**${result.metric}** is already showing in **Column ${result.column}**! You're all set.\n\nWould you like advice on how to filter this column for the best analysis view?`);
            } else {
              addKHMessage('assistant', `Done! I've set **Column ${result.column}** to **${result.metric}** in the ${sectionName} section.\n\nLet me know if you'd like advice on how to filter this column for the best analysis view!`);
            }
            
            // Clear the pending action
            khState.pendingColumnAction = null;
          } else {
            addKHMessage('error', 'Could not set column: ' + (result.error || 'Unknown error'));
            khState.pendingColumnAction = null;
          }
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + error.message);
          khState.pendingColumnAction = null;
        })
        .setDynamicColumnHeader(resolvedColumn, metric);
    }

    // Track last query for feedback
    let khLastQuery = '';

    function addKHMessage(type, content, showActionButtons = false, dataIndicator = '') {
      if (!khEls.messages) return null;
      const msgEl = document.createElement('div');
      msgEl.className = 'kh-message ' + type;

      if (type === 'loading') {
        msgEl.innerHTML = '<div class="kh-loading-dots"><span></span><span></span><span></span></div>';
      } else if (type === 'assistant') {
        // Generate unique ID for this message
        const msgId = 'kh-msg-' + Date.now();
        msgEl.id = msgId;
        msgEl.dataset.response = content;
        msgEl.dataset.query = khLastQuery;
        
        // Data indicator shows which AM's data was loaded
        const indicatorHtml = dataIndicator || '';
        
        let actionButtonsHtml = '';
        if (showActionButtons) {
          if (khState.pendingColumnAction) {
            actionButtonsHtml = `
              <div class="kh-action-buttons">
                <button class="kh-action-btn primary" onclick="executeColumnAction()">
                  <span>‚ñ∂</span> Add Column
                </button>
                <button class="kh-action-btn secondary" onclick="dismissAction()">
                  Not now
                </button>
              </div>
            `;
          } else if (khState.pendingFunctionAction) {
            const label = khState.pendingFunctionAction.label || 'Run';
            // Check if we should show Reset button (after auto-isolate)
            if (khState.showResetButton) {
              actionButtonsHtml = `
                <div class="kh-action-buttons">
                  <button class="kh-action-btn primary" onclick="executeFunctionAction()">
                    <span>‚ñ∂</span> ${label}
                  </button>
                  <button class="kh-action-btn secondary" onclick="executeReset()">
                    <span>‚Ü∫</span> Reset
                  </button>
                </div>
              `;
            } else {
              actionButtonsHtml = `
                <div class="kh-action-buttons">
                  <button class="kh-action-btn primary" onclick="executeFunctionAction()">
                    <span>‚ñ∂</span> ${label}
                  </button>
                  <button class="kh-action-btn secondary" onclick="dismissAction()">
                    Not now
                  </button>
                </div>
              `;
            }
          } else if (khState.pendingSlackAction) {
            const channel = khState.pendingSlackAction.channel;
            actionButtonsHtml = `
              <div class="kh-action-buttons">
                <button class="kh-action-btn slack" onclick="openSlackChannel('${channel}')">
                  Open #${channel} in Slack
                </button>
                <button class="kh-action-btn secondary" onclick="dismissAction()">
                  Not now
                </button>
              </div>
            `;
          } else if (khState.pendingSmartSelectAction) {
            const count = khState.pendingSmartSelectAction.rids.length;
            actionButtonsHtml = `
              <div class="kh-action-buttons">
                <button class="kh-action-btn primary" onclick="executeSmartSelectAction()">
                  <span>‚úì</span> Check ${count} in Smart Select
                </button>
                <button class="kh-action-btn secondary" onclick="dismissAction()">
                  Not now
                </button>
              </div>
            `;
          } else if (khState.pendingTeamAnalysisAction) {
            actionButtonsHtml = `
              <div class="kh-action-buttons">
                <button class="kh-action-btn primary" onclick="executeTeamAnalysis()">
                  <span>üë•</span> Run Team Analysis
                </button>
                <button class="kh-action-btn secondary" onclick="dismissAction()">
                  Not now
                </button>
              </div>
            `;
          } else if (khState.pendingRetryQuery) {
            actionButtonsHtml = `
              <div class="kh-action-buttons">
                <button class="kh-action-btn primary" onclick="executeRetryQuery()">
                  Ok, Let's Go
                </button>
              </div>
            `;
          }
        }
        
        msgEl.innerHTML = indicatorHtml + formatKHResponse(content) + actionButtonsHtml + `
          <div class="kh-feedback">
            <span class="kh-feedback-label">Rate</span>
            <button class="kh-feedback-btn" onclick="submitKHFeedback('${msgId}', 'helpful')" title="Helpful">üëç</button>
            <button class="kh-feedback-btn" onclick="submitKHFeedback('${msgId}', 'not_helpful')" title="Not helpful">üëé</button>
            <button class="kh-feedback-btn" onclick="openKHCorrection('${msgId}')" title="Suggest correction">‚úèÔ∏è</button>
            <span class="kh-feedback-text"></span>
          </div>
        `;
      } else if (type === 'user') {
        khLastQuery = content; // Store for feedback
        msgEl.textContent = content;
      } else {
        msgEl.textContent = content;
      }

      khEls.messages.appendChild(msgEl);
      khEls.messages.scrollTop = khEls.messages.scrollHeight;
      return msgEl;
    }
    
    /**
     * Provide contextual filtering advice based on the last modified metric
     * Called when user confirms after a column change
     * @param {string} metric - The metric name that was just added
     */
    function provideFilteringAdvice(metric) {
      const metricLower = metric.toLowerCase();
      let advice = '';
      
      // Contextual filtering advice based on metric type
      if (metricLower.includes('metro') || metricLower.includes('neighborhood') || metricLower.includes('macro')) {
        advice = `**Filtering ${metric}:**\n\n1. Click the **${metric}** column header dropdown\n2. Select **Filter by values**\n3. Uncheck "Select all", then check the specific locations you want\n4. Click OK\n\n**Pro tip:** After filtering to your target area, use Smart Select to mark priority accounts for Focus20!`;
      } else if (metricLower.includes('status') || metricLower.includes('system type')) {
        advice = `**Filtering ${metric}:**\n\n1. Click the **${metric}** column header dropdown\n2. Select **Filter by values**\n3. Uncheck "Select all", then check the values you want (e.g., "Core", "Active")\n4. Click OK\n\n**Common filters:**\n- Filter for "Term Pending" to see accounts needing renewal conversations\n- Filter for specific system types to segment your outreach`;
      } else if (metricLower.includes('disco') || metricLower.includes('%') || metricLower.includes('percent')) {
        advice = `**Filtering ${metric}:**\n\n**To find low-performing accounts:**\n1. Click the column header ‚Üí Sort A‚ÜíZ (low to high)\n2. Focus on the bottom performers\n\n**To find top performers:**\n1. Sort Z‚ÜíA (high to low)\n\n**For threshold filtering:**\n1. Click dropdown ‚Üí Filter by condition\n2. Use "Greater than" or "Less than" with your target value`;
      } else if (metricLower.includes('revenue') || metricLower.includes('yield') || metricLower.includes('due')) {
        advice = `**Filtering ${metric}:**\n\n**To find top revenue accounts:**\n1. Sort Z‚ÜíA (high to low) - top performers appear first\n\n**To find underperformers:**\n1. Sort A‚ÜíZ (low to high)\n\n**For specific thresholds:**\n1. Filter by condition ‚Üí "Greater than" or "Less than"\n2. Enter your dollar threshold`;
      } else if (metricLower.includes('cvr') || metricLower.includes('cover')) {
        advice = `**Filtering ${metric}:**\n\n**To analyze cover volume:**\n1. Sort Z‚ÜíA for highest volume accounts\n2. Sort A‚ÜíZ to find accounts with low/no bookings\n\n**Compare channels:** Set multiple cover columns (Y, Z, AA) to different channels to see the distribution side-by-side.`;
      } else if (metricLower.includes('date') || metricLower.includes('term') || metricLower.includes('since') || metricLower.includes('engaged')) {
        advice = `**Filtering ${metric}:**\n\n**For date-based columns:**\n1. Sort oldest-first (A‚ÜíZ) to see upcoming deadlines or longest tenures\n2. Sort newest-first (Z‚ÜíA) for recent activity\n\n**For specific date ranges:**\n1. Filter by condition ‚Üí "Date is before" or "Date is after"\n2. Enter your target date\n\n**Pro tip:** For contract alerts, sort to surface expired/pending terms first!`;
      } else if (metricLower.includes('focus20')) {
        advice = `**Using the Focus20 column:**\n\nThis column shows the date each account was added to your Focus20 list.\n\n**To see your current Focus20:**\n1. Filter by condition ‚Üí "Is not empty"\n2. This shows only accounts in your Focus20\n\n**To refresh your list:**\n1. Sort by date added (oldest first)\n2. Consider rotating out accounts that have been there 2+ weeks\n3. Use Smart Select + X to remove, then add fresh priorities with +`;
      } else {
        // Generic advice
        advice = `**Filtering ${metric}:**\n\n1. Click the column header dropdown\n2. Choose **Sort A‚ÜíZ** or **Sort Z‚ÜíA** for quick ordering\n3. Use **Filter by values** to select specific items\n4. Use **Filter by condition** for numeric thresholds\n\n**Remember:** Click RESET to clear all filters when done!`;
      }
      
      // Clear the lastModifiedMetric so we don't keep offering advice
      khState.lastModifiedMetric = null;
      
      addKHMessage('assistant', advice);
    }

    /**
     * Dismiss any pending action without executing
     */
    function dismissAction() {
      khState.pendingColumnAction = null;
      khState.pendingFunctionAction = null;
      khState.pendingSlackAction = null;
      khState.pendingSmartSelectAction = null;
      khState.pendingTeamAnalysisAction = false;
      khState.autoIsolateMode = false;
      khState.showResetButton = false;
      // Remove the action buttons from the last message
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
    }
    
    /**
     * Open a Slack channel in a new window
     * @param {string} channel - The channel name (without #)
     */
    function openSlackChannel(channel) {
      // Remove action buttons
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Open Slack channel (web URL format)
      const slackUrl = 'https://slack.com/app_redirect?channel=' + encodeURIComponent(channel);
      window.open(slackUrl, '_blank');
      
      // Clear the pending action
      khState.pendingSlackAction = null;
      
      // Add confirmation message
      addKHMessage('assistant', 'Opening #' + channel + ' in Slack. The support team is happy to help!');
    }
    
    /**
     * Execute a pending function action (like manualUpdateNotesOnly)
     * @param {boolean} fromButton - If true, called from action button (don't add "Yes" message)
     */
    function executeFunctionAction(fromButton = true) {
      if (!khState.pendingFunctionAction) return;
      
      const { functionName, label } = khState.pendingFunctionAction;
      
      // Remove action buttons if they exist
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Add user confirmation message only if triggered by text (not button)
      if (!fromButton) {
        addKHMessage('user', 'Yes');
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log(`[executeFunctionAction] Running function: ${functionName}`);
      
      // Call the backend function dynamically
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          addKHMessage('assistant', `Done! The **${label}** operation completed successfully. The notes across your sheet have been updated from Salesforce. Let me know if you need anything else!`);
          khState.pendingFunctionAction = null;
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error running function: ' + error.message);
          khState.pendingFunctionAction = null;
        })
        [functionName](); // Dynamic function call
    }

    // =========================================================
    // --- SMART SELECT ACTION ---
    // =========================================================
    
    /**
     * Execute Smart Select action - check specified RIDs in Column D
     */
    function executeSmartSelectAction() {
      if (!khState.pendingSmartSelectAction || !khState.pendingSmartSelectAction.rids) {
        addKHMessage('error', 'No RIDs to check. Please ask me to list the accounts first, then I can add them to Smart Select.');
        return;
      }
      
      const rids = khState.pendingSmartSelectAction.rids;
      const amName = khState.currentAMContext ? khState.currentAMContext.fullName : '';
      
      // Remove action buttons
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log(`[executeSmartSelectAction] Checking ${rids.length} RIDs for AM: "${amName}"`);
      console.log(`[executeSmartSelectAction] First few RIDs:`, rids.slice(0, 5));
      
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            let message = `Done! I've checked **${result.checkedCount}** account${result.checkedCount > 1 ? 's' : ''} in Smart Select (Column D).\n\n`;
            
            message += `**Next Steps:**\n`;
            message += `- Click **+** above Column E to add these to Focus20\n`;
            message += `- Click **X** to remove from Focus20\n\n`;
            
            message += `**To filter to just these accounts:**\n`;
            message += `1. Click the Smart Select column header (Column D)\n`;
            message += `2. Filter by condition ‚Üí "Is equal to" ‚Üí TRUE\n\n`;
            
            message += `**To clear Smart Select:** Click the **RESET** button above Column E.`;
            
            if (result.notFoundCount > 0) {
              message += `\n\n*Note: ${result.notFoundCount} RIDs were not found on this sheet (they may be filtered out or on a different tab).*`;
            }
            
            message += `\n\nIf you have any other questions about your account data I'd be happy to dive in with you!`;
            
            // Set up Focus20 action for the button
            khState.pendingFunctionAction = {
              functionName: 'moveTrueAccountsToFocus20',
              label: 'Add to Focus20'
            };
            
            addKHMessage('assistant', message, true);  // true = show action buttons
          } else if (result.wrongTab) {
            // User is on wrong tab - show warning
            addKHMessage('assistant', `**Heads up:** You are not currently on **${result.expectedTab}**'s tab. You're on **${result.currentTab || 'a different sheet'}**.

Please navigate to ${result.expectedTab}'s tab and try again, or ask about the accounts on your current tab.`);
          } else {
            // Provide more helpful error
            let errorMsg = result.error || 'Unknown error';
            if (result.hint) {
              errorMsg += `\n\n*${result.hint}*`;
            }
            addKHMessage('assistant', `Could not check RIDs: ${errorMsg}\n\nMake sure you're on the correct AM's tab and try again.`);
          }
          
          khState.pendingSmartSelectAction = null;
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + error.message);
          khState.pendingSmartSelectAction = null;
        })
        .checkRIDsInSmartSelect(rids, amName);
    }
    
    /**
     * Execute auto-isolate flow: check RIDs in Smart Select AND apply filter
     * Triggered when: >10 RIDs in response OR query started with "isolate"/"filter"
     * Supports LAYERED filtering: if already isolated, finds intersection with new RIDs
     * @param {Array} rids - Array of RID strings
     * @param {string} dataIndicator - Optional data indicator HTML
     */
    function executeAutoIsolate(rids, dataIndicator = '') {
      if (!rids || rids.length === 0) {
        addKHMessage('error', 'No RIDs to isolate.');
        return;
      }
      
      const amName = khState.currentAMContext ? khState.currentAMContext.fullName : '';
      const isLayering = khState.isolatedRIDs && khState.isolatedRIDs.length > 0;
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      if (isLayering) {
        console.log(`[executeAutoIsolate] LAYERING: ${rids.length} new RIDs onto ${khState.isolatedRIDs.length} existing`);
      } else {
        console.log(`[executeAutoIsolate] FRESH isolate: ${rids.length} RIDs for AM: "${amName}"`);
      }
      
      // Choose the appropriate server function
      const serverFunction = isLayering ? 'layerSmartSelectFilter' : 'checkAndFilterSmartSelect';
      const serverArgs = isLayering ? [rids, khState.isolatedRIDs, amName] : [rids, amName];
      
      const handleSuccess = (result) => {
        if (loadingEl) loadingEl.remove();
        khState.isLoading = false;
        if (khEls.sendBtn) khEls.sendBtn.disabled = false;
        
        if (result.success) {
          // Store the isolated RIDs for potential layering
          khState.isolatedRIDs = result.isolatedRIDs || rids.filter(r => !result.notFoundRIDs || !result.notFoundRIDs.includes(r));
          
          let message;
          if (isLayering) {
            message = `‚úÖ **Layered filter applied** - now showing **${result.checkedCount}** account${result.checkedCount !== 1 ? 's' : ''} that match both criteria.\n\n`;
          } else {
            message = `‚úÖ **Isolated ${result.checkedCount}** account${result.checkedCount !== 1 ? 's' : ''} - your sheet is now filtered to show only these RIDs.\n\n`;
          }
          
          if (result.notFoundCount > 0) {
            message += `*Note: ${result.notFoundCount} RIDs were not found on this sheet.*\n\n`;
          }
          
          message += `**You can layer in another metric or:**`;
          
          // Set up Focus20 action for the button
          khState.pendingFunctionAction = {
            functionName: 'moveTrueAccountsToFocus20',
            label: 'Add to Focus20'
          };
          
          // Mark that we need to show Reset button too
          khState.showResetButton = true;
          
          addKHMessage('assistant', message, true, dataIndicator);
        } else if (result.wrongTab) {
          addKHMessage('assistant', `**Heads up:** You are not currently on **${result.expectedTab}**'s tab. You're on **${result.currentTab || 'a different sheet'}**.

Please navigate to ${result.expectedTab}'s tab and try again, or ask about the accounts on your current tab.`);
        } else if (result.noIntersection) {
          addKHMessage('assistant', `**No matching accounts found.** None of the requested RIDs overlap with your current filter.\n\nTry a different criteria, or click **Reset** to start fresh.`);
          khState.showResetButton = true;
          khState.pendingFunctionAction = null;
          addKHMessage('assistant', '', true); // Show reset button
        } else {
          let errorMsg = result.error || 'Unknown error';
          addKHMessage('assistant', `Could not isolate RIDs: ${errorMsg}\n\nMake sure you're on the correct AM's tab and try again.`);
        }
        
        khState.pendingSmartSelectAction = null;
      };
      
      const handleFailure = (error) => {
        if (loadingEl) loadingEl.remove();
        khState.isLoading = false;
        if (khEls.sendBtn) khEls.sendBtn.disabled = false;
        addKHMessage('error', 'Error: ' + error.message);
        khState.pendingSmartSelectAction = null;
      };
      
      // Call the appropriate server function
      if (isLayering) {
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleFailure)
          .layerSmartSelectFilter(rids, khState.isolatedRIDs, amName);
      } else {
        google.script.run
          .withSuccessHandler(handleSuccess)
          .withFailureHandler(handleFailure)
          .checkAndFilterSmartSelect(rids, amName);
      }
    }
    
    /**
     * Execute Reset action - clears Smart Select and removes filter
     * Called from the Reset button after auto-isolate
     */
    function executeReset() {
      // Remove action buttons
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log('[executeReset] Resetting Smart Select and filters');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            addKHMessage('assistant', `‚úÖ **Reset complete!** Smart Select has been cleared and all filters removed.\n\nWhat would you like to explore next?`);
          } else {
            addKHMessage('assistant', `Could not reset: ${result.error || 'Unknown error'}\n\nYou can manually reset by clicking the RESET button above Column E.`);
          }
          
          // Clear pending actions and isolated state
          khState.pendingFunctionAction = null;
          khState.showResetButton = false;
          khState.isolatedRIDs = null;  // Clear layered filter state
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + error.message);
        })
        .resetInTouchView();
    }

    // =========================================================
    // --- PORTFOLIO/TEAM ANALYSIS FUNCTIONS ---
    // =========================================================
    
    /**
     * Execute portfolio analysis for the pending AM
     * @param {boolean} fromButton - If true, called from action button (don't add "Yes" message)
     */
    function executePortfolioAction(fromButton = true) {
      if (!khState.pendingPortfolioAction || khState.pendingPortfolioAction.type !== 'CONFIRM') return;
      
      const amName = khState.pendingPortfolioAction.amName;
      
      // Remove action buttons if they exist
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Add user confirmation message only if triggered by text (not button)
      if (!fromButton) {
        addKHMessage('user', 'Yes');
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log(`[executePortfolioAction] Analyzing portfolio for: ${amName}`);
      
      // Call backend to get portfolio data
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            // Store the data for follow-up questions
            khState.lastPortfolioData = result.data;
            
            // Format and display the analysis
            const formattedAnalysis = formatPortfolioAnalysis(result.data);
            addKHMessage('assistant', formattedAnalysis);
            
            // Add to conversation history so Gemini has context
            khState.conversationHistory.push({ 
              role: 'assistant', 
              content: `[Portfolio data loaded for ${amName}]\n${JSON.stringify(result.data)}` 
            });
          } else {
            addKHMessage('error', 'Could not analyze portfolio: ' + (result.error || 'Unknown error'));
          }
          khState.pendingPortfolioAction = null;
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + error.message);
          khState.pendingPortfolioAction = null;
        })
        .getAMPortfolioAnalysis(amName);
    }
    
    /**
     * Execute team-wide portfolio analysis
     */
    function executeTeamAnalysis() {
      // Remove action buttons if they exist
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Show loading
      khState.isLoading = true;
      if (khEls.sendBtn) khEls.sendBtn.disabled = true;
      const loadingEl = addKHMessage('loading', '');
      
      console.log('[executeTeamAnalysis] Running team-wide analysis');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          
          if (result.success) {
            const formattedAnalysis = formatTeamAnalysis(result.data);
            addKHMessage('assistant', formattedAnalysis + `

If you have any other questions about the team data I'd be happy to dive in with you!`);
            
            khState.conversationHistory.push({ 
              role: 'assistant', 
              content: `[Team portfolio data loaded]\n${JSON.stringify(result.data)}` 
            });
          } else {
            addKHMessage('error', 'Could not analyze team: ' + (result.error || 'Unknown error'));
          }
          khState.pendingTeamAnalysisAction = false;
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          if (khEls.sendBtn) khEls.sendBtn.disabled = false;
          addKHMessage('error', 'Error: ' + error.message);
          khState.pendingTeamAnalysisAction = false;
        })
        .getTeamPortfolioAnalysis();
    }
    
    /**
     * Re-run the original query after user navigates to AM tab
     */
    function executeRetryQuery() {
      // Remove action buttons
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      const queryToRetry = khState.pendingRetryQuery;
      khState.pendingRetryQuery = null;
      
      if (queryToRetry) {
        console.log('[executeRetryQuery] Re-running query: ' + queryToRetry);
        sendKHMessage(queryToRetry);
      }
    }
    
    /**
     * Show list of available AMs for selection
     */
    function showAMSelectionList() {
      // Remove existing action buttons
      const actionButtons = document.querySelector('.kh-action-buttons');
      if (actionButtons) {
        actionButtons.remove();
      }
      
      // Check if we already have the list cached
      if (khState.availableAMs && khState.availableAMs.length > 0) {
        renderAMSelectionList(khState.availableAMs);
        return;
      }
      
      // Fetch list from backend
      khState.isLoading = true;
      const loadingEl = addKHMessage('loading', '');
      
      google.script.run
        .withSuccessHandler((result) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          
          if (result.success && result.ams.length > 0) {
            khState.availableAMs = result.ams;
            renderAMSelectionList(result.ams);
          } else {
            addKHMessage('error', 'No AM tabs found in this workbook.');
          }
        })
        .withFailureHandler((error) => {
          if (loadingEl) loadingEl.remove();
          khState.isLoading = false;
          addKHMessage('error', 'Error loading AMs: ' + error.message);
        })
        .getAvailableAMTabs();
    }
    
    /**
     * Render the AM selection list as buttons
     */
    function renderAMSelectionList(ams) {
      let buttonsHtml = '<div class="kh-am-selection"><p style="margin:0 0 8px 0; font-size:11px; color:#64748b;">Select an Account Manager:</p>';
      
      ams.forEach(am => {
        const displayName = am.fullName || am.tabName || 'Unknown';
        buttonsHtml += `<button class="kh-action-btn secondary" style="margin:2px; flex:none; width:auto;" onclick="selectAMForAnalysis('${displayName.replace(/'/g, "\\'")}')">
          ${displayName}
        </button>`;
      });
      
      buttonsHtml += `<button class="kh-action-btn secondary" style="margin:2px; flex:none; width:auto; background:#f0fdf4; border-color:#86efac;" onclick="executeTeamAnalysis()">
        üë• All AMs (Team)
      </button>`;
      
      buttonsHtml += '</div>';
      
      addKHMessage('assistant', 'Who would you like to analyze?\n\n' + buttonsHtml);
    }
    
    /**
     * Select a specific AM for analysis (from the list)
     */
    function selectAMForAnalysis(amName) {
      // Set up the pending action and execute
      khState.pendingPortfolioAction = {
        type: 'CONFIRM',
        amName: amName
      };
      executePortfolioAction(true);
    }
    
    /**
     * Format portfolio analysis data for display
     */
    function formatPortfolioAnalysis(data) {
      const formatList = (list, maxItems = 5) => {
        if (!list || list.length === 0) return 'None';
        return list.slice(0, maxItems).map(item => `${item.label} (${item.count})`).join(' | ');
      };
      
      let html = `## üìä Portfolio Analysis: ${data.amName}\n\n`;
      
      html += `**Overview**\n`;
      html += `- **Bucket:** ${data.bucket} accounts | **Groups:** ${data.groups}\n`;
      html += `- **Avg Yield:** $${data.avgYield} | **Avg Sub Fee:** $${data.avgSubFee}\n\n`;
      
      html += `**‚ö†Ô∏è Contract Status** (Priority Items)\n`;
      html += `- **Term Pending:** ${data.termPending}${data.termPending > 0 ? ' ‚ö†Ô∏è' : ''}\n`;
      html += `- Expired: ${data.contractRenewal.expired} | Canceling: ${data.contractRenewal.canceling} | Warning (45d): ${data.contractRenewal.warning45d}\n\n`;
      
      html += `**üìà Product Adoption**\n`;
      html += `- Active PI: ${data.activePI} | Active XP: ${data.activeXP}\n`;
      html += `- Private Dining: ${data.privateDining} | Instant Booking: ${data.instantBooking}\n`;
      html += `- Discovery %: ${data.discoveryPct} | PI Rev Share: ${data.piRevShare}\n\n`;
      
      html += `**System Mix:** ${formatList(data.systemMix)}\n\n`;
      html += `**Quality Tiers:** ${formatList(data.qualityTiers)}\n\n`;
      html += `**Exclusive Pricing:** ${formatList(data.exclusivePricing)}\n\n`;
      html += `**Special Programs:** ${formatList(data.specialPrograms) || 'None'}\n\n`;
      html += `**No Booking Reasons:** ${formatList(data.noBookingReasons) || 'None'}\n\n`;
      
      // Add key observations
      html += `---\n**Key Observations:**\n`;
      
      if (data.termPending > 0) {
        html += `- üî¥ **${data.termPending} Term Pending** accounts need immediate renewal conversations\n`;
      }
      if (data.contractRenewal.expired > 0) {
        html += `- üî¥ **${data.contractRenewal.expired} Expired** contracts - urgent outreach needed\n`;
      }
      if (data.noBookingReasons && data.noBookingReasons.length > 0) {
        const fullbookIssue = data.noBookingReasons.find(r => r.label.toLowerCase().includes('fullbook'));
        if (fullbookIssue) {
          html += `- ‚ö†Ô∏è **${fullbookIssue.count} accounts** with Fullbook issues - check for system problems\n`;
        }
      }
      if (data.termPending === 0 && data.contractRenewal.expired === 0) {
        html += `- ‚úÖ No urgent contract issues\n`;
      }
      
      html += `\nWould you like me to dive deeper into any of these areas?`;
      
      return html;
    }
    
    /**
     * Format team analysis data for display
     */
    function formatTeamAnalysis(data) {
      const formatList = (list, maxItems = 5) => {
        if (!list || list.length === 0) return 'None';
        return list.slice(0, maxItems).map(item => `${item.label} (${item.count})`).join(' | ');
      };
      
      let html = `## üë• Team Portfolio Analysis\n\n`;
      
      html += `**Overview** (${data.amCount} Account Managers)\n`;
      html += `- **Total Bucket:** ${data.bucket} accounts | **Groups:** ${data.groups}\n`;
      html += `- **Avg Yield:** $${data.avgYield} | **Avg Sub Fee:** $${data.avgSubFee}\n\n`;
      
      html += `**‚ö†Ô∏è Contract Status** (Team-wide)\n`;
      html += `- **Term Pending:** ${data.termPending}${data.termPending > 0 ? ' ‚ö†Ô∏è' : ''}\n`;
      html += `- Expired: ${data.contractRenewal.expired} | Canceling: ${data.contractRenewal.canceling} | Warning (45d): ${data.contractRenewal.warning45d}\n\n`;
      
      html += `**üìà Product Adoption**\n`;
      html += `- Active PI: ${data.activePI} | Active XP: ${data.activeXP}\n`;
      html += `- Private Dining: ${data.privateDining} | Instant Booking: ${data.instantBooking}\n\n`;
      
      html += `**System Mix:** ${formatList(data.systemMix)}\n\n`;
      html += `**Quality Tiers:** ${formatList(data.qualityTiers)}\n\n`;
      html += `**Exclusive Pricing:** ${formatList(data.exclusivePricing)}\n\n`;
      
      // AM Breakdown
      if (data.amBreakdown && data.amBreakdown.length > 0) {
        html += `**AM Breakdown** (by bucket size):\n`;
        data.amBreakdown.slice(0, 10).forEach(am => {
          const flag = am.termPending > 0 ? ` ‚ö†Ô∏è${am.termPending}` : '';
          html += `- ${am.name}: ${am.bucket} accts${flag}\n`;
        });
        html += `\n`;
      }
      
      html += `Would you like to see details for a specific AM?`;
      
      return html;
    }
    
    /**
     * Initialize AM context on chat open
     * Called when the chat panel opens to detect current AM tab
     */
    function initAMContext() {
      google.script.run
        .withSuccessHandler((result) => {
          khState.currentAMContext = result;
          console.log('[initAMContext] AM Context:', result);
        })
        .withFailureHandler((error) => {
          console.log('[initAMContext] Error:', error.message);
        })
        .getActiveAMContext();
    }

    function submitKHFeedback(msgId, rating) {
      const msgEl = document.getElementById(msgId);
      if (!msgEl) return;
      
      const feedbackBtns = msgEl.querySelectorAll('.kh-feedback-btn');
      const feedbackText = msgEl.querySelector('.kh-feedback-text');
      
      // Disable buttons
      feedbackBtns.forEach(btn => btn.disabled = true);
      
      // Highlight selected
      feedbackBtns[rating === 'helpful' ? 0 : 1].classList.add(
        rating === 'helpful' ? 'active-helpful' : 'active-not-helpful'
      );
      
      // Send feedback
      google.script.run
        .withSuccessHandler((result) => {
          if (feedbackText) {
            feedbackText.textContent = result.success ? 'Thanks!' : 'Error';
          }
        })
        .withFailureHandler(() => {
          if (feedbackText) feedbackText.textContent = 'Error';
        })
        .logKnowledgeHubFeedback({
          query: msgEl.dataset.query || '',
          response: msgEl.dataset.response || '',
          rating: rating
        });
    }

    function openKHCorrection(msgId) {
      const msgEl = document.getElementById(msgId);
      if (!msgEl) return;
      
      const modal = document.getElementById('khCorrectionModal');
      const preview = document.getElementById('khCorrectionPreview');
      const textarea = document.getElementById('khCorrectionText');
      
      if (modal && preview && textarea) {
        preview.textContent = (msgEl.dataset.response || '').substring(0, 200) + '...';
        textarea.value = '';
        modal.dataset.msgId = msgId;
        modal.classList.add('open');
        textarea.focus();
      }
    }

    function closeKHCorrection() {
      const modal = document.getElementById('khCorrectionModal');
      if (modal) modal.classList.remove('open');
    }

    /**
     * Copy RID to clipboard and show toast notification
     * @param {string} rid - Restaurant ID to copy
     */
    function copyRIDToClipboard(rid) {
      navigator.clipboard.writeText(rid).then(() => {
        const toast = document.getElementById('khToast');
        if (toast) {
          toast.textContent = `RID ${rid} copied to clipboard`;
          toast.classList.add('show');
          setTimeout(() => toast.classList.remove('show'), 2000);
        }
      }).catch(err => {
        console.error('[copyRIDToClipboard] Failed to copy:', err);
      });
    }

    /**
     * Show the help guide modal
     */
    function showHelpGuide() {
      const modal = document.getElementById('helpModal');
      if (modal) modal.classList.add('open');
    }
    
    /**
     * Close the help guide modal
     */
    function closeHelpModal() {
      const modal = document.getElementById('helpModal');
      if (modal) modal.classList.remove('open');
    }

    function submitKHCorrection() {
      const modal = document.getElementById('khCorrectionModal');
      const textarea = document.getElementById('khCorrectionText');
      const submitBtn = document.getElementById('khCorrectionSubmit');
      
      if (!modal || !textarea) return;
      
      const correction = textarea.value.trim();
      if (!correction) return;
      
      const msgId = modal.dataset.msgId;
      const msgEl = document.getElementById(msgId);
      
      if (submitBtn) submitBtn.disabled = true;
      
      google.script.run
        .withSuccessHandler((result) => {
          if (submitBtn) submitBtn.disabled = false;
          closeKHCorrection();
          
          // Update feedback text on original message
          if (msgEl) {
            const feedbackText = msgEl.querySelector('.kh-feedback-text');
            if (feedbackText) feedbackText.textContent = result.success ? 'Correction submitted!' : 'Error';
          }
        })
        .withFailureHandler(() => {
          if (submitBtn) submitBtn.disabled = false;
          alert('Failed to submit correction');
        })
        .logKnowledgeHubFeedback({
          query: msgEl ? msgEl.dataset.query : '',
          response: msgEl ? msgEl.dataset.response : '',
          rating: 'not_helpful',
          correction: correction
        });
    }

    function formatKHResponse(text) {
      // Escape HTML first
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      // Headers: ### text, ## text, # text ‚Üí styled headers
      html = html.replace(/^### (.+)$/gm, '<div class="kh-header kh-h3">$1</div>');
      html = html.replace(/^## (.+)$/gm, '<div class="kh-header kh-h2">$1</div>');
      html = html.replace(/^# (.+)$/gm, '<div class="kh-header kh-h1">$1</div>');
      
      // Horizontal rules: --- ‚Üí styled divider
      html = html.replace(/^---+$/gm, '<hr class="kh-divider">');
      
      // Bold: **text** or __text__
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
      
      // Inline code: `code`
      html = html.replace(/`([^`]+)`/g, '<code>$1</code>');
      
      // Markdown tables - MUST process BEFORE line breaks
      // Match table blocks: lines starting with |
      html = html.replace(/(?:^|\n)(\|[^\n]+\|\n\|[-:\|\s]+\|\n(?:\|[^\n]+\|\n?)+)/g, function(match) {
        const lines = match.trim().split('\n').filter(line => line.trim());
        if (lines.length < 2) return match;
        
        // First line is header
        const headerCells = lines[0].split('|').filter(cell => cell.trim() !== '');
        
        // Skip separator line (line with dashes)
        // Rest are data rows
        const dataLines = lines.slice(2);
        
        let tableHtml = '<table class="kh-table"><thead><tr>';
        headerCells.forEach(cell => {
          tableHtml += '<th>' + cell.trim() + '</th>';
        });
        tableHtml += '</tr></thead><tbody>';
        
        dataLines.forEach(line => {
          const cells = line.split('|').filter(cell => cell.trim() !== '');
          tableHtml += '<tr>';
          cells.forEach(cell => {
            tableHtml += '<td>' + cell.trim() + '</td>';
          });
          tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table>';
        return '\n' + tableHtml + '\n';
      });
      
      // Line breaks
      html = html.replace(/\n/g, '<br>');
      
      // Simple bullet lists (lines starting with - or *)
      html = html.replace(/<br>[\s]*[-*]\s+/g, '<br>‚Ä¢ ');
      
      // Numbered lists
      html = html.replace(/<br>(\d+)\.\s+/g, '<br>$1. ');
      
      // Make account names clickable to copy RID
      // Sort by name length (longest first) to avoid partial matches
      const sortedNames = Object.keys(ACCOUNT_NAME_TO_RID).sort((a, b) => b.length - a.length);
      sortedNames.forEach(name => {
        if (name.length < 4) return; // Skip very short names to avoid false matches
        const rid = ACCOUNT_NAME_TO_RID[name];
        // Escape special regex characters in name
        const escapedName = name.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        // Match whole word boundaries, case-insensitive
        const regex = new RegExp(`\\b${escapedName}\\b`, 'gi');
        html = html.replace(regex, `<span class="kh-clickable-account" data-rid="${rid}" onclick="copyRIDToClipboard('${rid}')" onmouseenter="showCustomTooltip(this, 'Click to copy RID: ${rid}')" onmouseleave="hideCustomTooltip()">${name}</span>`);
      });

      return html;
    }

    // Initialize Knowledge Hub when page loads
    document.addEventListener('DOMContentLoaded', initKnowledgeHub);
    // Also try on window load as fallback
    window.addEventListener('load', initKnowledgeHub);
  </script>

  <!-- Correction Modal -->
  <div class="kh-modal-overlay" id="khCorrectionModal">
    <div class="kh-modal">
      <div class="kh-modal-header">
        <span>Suggest a Correction</span>
        <button class="kh-modal-close" onclick="closeKHCorrection()">‚úï</button>
      </div>
      <div class="kh-modal-body">
        <label class="kh-modal-label">AI Response (preview):</label>
        <div class="kh-modal-preview" id="khCorrectionPreview"></div>
        <label class="kh-modal-label">What should the correct answer be?</label>
        <textarea class="kh-modal-textarea" id="khCorrectionText" placeholder="Enter the correct information..."></textarea>
        <div class="kh-modal-actions">
          <button class="kh-modal-btn kh-modal-btn-cancel" onclick="closeKHCorrection()">Cancel</button>
          <button class="kh-modal-btn kh-modal-btn-submit" id="khCorrectionSubmit" onclick="submitKHCorrection()">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="kh-modal-overlay" id="helpModal">
    <div class="help-modal">
      <div class="help-modal-header">
        <span>Bucket iQ Guide</span>
        <button class="help-modal-close" onclick="closeHelpModal()">‚úï</button>
      </div>
      <div class="help-modal-body">
        <div class="help-section">
          <h5>Action Buttons</h5>
          <ul>
            <li><strong>Start My Day</strong> - Load your daily priorities and action items</li>
            <li><strong>Dig In</strong> - Filter your sheet to specific accounts</li>
            <li><strong>Focus20</strong> - Build your top 20 focus list</li>
            <li><strong>Reset</strong> - Clear all active filters</li>
            <li><strong>+ (New Chat)</strong> - Start a fresh conversation</li>
          </ul>
        </div>
        <div class="help-section">
          <h5>Jump Start Sections</h5>
          <ul>
            <li><strong>üî¥ Term Pending</strong> - Contract ending soon, action required</li>
            <li><strong>üî¥ Contracts Expiring</strong> - Approaching contract end date</li>
            <li><strong>üü° No Engagement 60d</strong> - Hasn't been contacted in 60+ days</li>
            <li><strong>üü° Booking Issues</strong> - Zero covers or booking problems</li>
            <li><strong>üü¢ High PI + Revenue</strong> - Top performing PI accounts</li>
            <li><strong>‚≠ê Icon/Elite</strong> - Premium tier account</li>
          </ul>
        </div>
        <div class="help-section">
          <h5>Quick Tips</h5>
          <ul>
            <li>Type "isolate" or "filter" to auto-filter your sheet</li>
            <li>Ask for specific metrics like "show disco share"</li>
            <li>Say "add them" after a list to bulk select accounts</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Tooltip Container (only one visible at a time) -->
  <div id="khCustomTooltip" class="kh-custom-tooltip"></div>

</body>
</html>